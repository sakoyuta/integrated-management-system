<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-house | 営業サイト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body, #root { height: 100%; margin: 0; }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body strong { color: #2563eb; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;

        // ==========================================
        //  0. Error Boundary & Hooks
        // ==========================================

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }

            handleReset = () => {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('ghouse_')) localStorage.removeItem(key);
                    });
                    window.location.reload();
                } catch (e) {
                    console.error("Reset failed", e);
                }
            };

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center h-full min-h-[300px] bg-red-50 p-6 rounded-lg border border-red-200 m-4">
                            <div className="text-center max-w-md">
                                <h2 className="text-lg font-bold text-red-700 mb-2">エラーが発生しました</h2>
                                <p className="text-sm text-gray-600 mb-4">データの不整合が起きている可能性があります。</p>
                                <div className="bg-white p-2 rounded border border-red-100 text-left text-xs text-red-500 overflow-auto max-h-24 mb-4 font-mono">
                                    {this.state.error?.toString()}
                                </div>
                                <button onClick={this.handleReset} className="text-sm bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50 transition">
                                    データをリセットして復旧
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const usePersistentState = (key, initialValue) => {
            const [state, setState] = useState(() => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    return initialValue;
                }
            });
            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (e) {
                    console.error(`Error writing localStorage key "${key}":`, e);
                }
            }, [key, state]);
            return [state, setState];
        };

        // ==========================================
        //  IndexedDB Helper Functions
        // ==========================================

        const DB_NAME = 'ghouse_videos';
        const DB_VERSION = 1;
        const STORE_NAME = 'videos';

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        };

        const saveVideoToDB = async (id, videoBlob) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id, blob: videoBlob });
                request.onsuccess = () => resolve(id);
                request.onerror = () => reject(request.error);
            });
        };

        const getVideoFromDB = async (id) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result?.blob);
                request.onerror = () => reject(request.error);
            });
        };

        const deleteVideoFromDB = async (id) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        const AI_SYSTEM_PROMPT = `あなたは高性能注文住宅「G HOUSE」の優秀な営業マネージャーです。`;

        // ==========================================
        //  1. Icons & Shared UI Components
        // ==========================================

        const LucideIcon = ({ name, className, size = 20 }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} className={className} width={size} height={size}></i>;
        };

        const VideoPlayer = ({ videoId, className }) => {
            const [videoURL, setVideoURL] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadVideo = async () => {
                    try {
                        const blob = await getVideoFromDB(videoId);
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            setVideoURL(url);
                        }
                    } catch (error) {
                        console.error('動画読み込みエラー:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                loadVideo();
                return () => {
                    if (videoURL) URL.revokeObjectURL(videoURL);
                };
            }, [videoId]);

            if (loading) {
                return <div className="flex items-center justify-center p-4 text-gray-500 text-xs">動画を読み込み中...</div>;
            }

            if (!videoURL) {
                return <div className="flex items-center justify-center p-4 text-red-500 text-xs">動画の読み込みに失敗しました</div>;
            }

            return <video src={videoURL} controls className={className} />;
        };

        const Toast = ({ message, type, onDismiss }) => {
            if (!message) return null;
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            useEffect(() => { const timer = setTimeout(onDismiss, 3000); return () => clearTimeout(timer); }, [onDismiss]);
            return ( <div className="fixed top-5 right-5 z-50 animate-fade-in"> <div className={`${bgColor} text-white font-bold rounded-lg shadow-lg py-3 px-5 flex items-center`}> <span className="flex-grow">{message}</span> </div> </div> );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 transition-opacity">
                    <div className="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-all animate-fade-in">
                        <div className="p-6">
                            <div className="flex items-start">
                                <div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <LucideIcon name="alert-triangle" className="text-red-600" size={24} />
                                </div>
                                <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 className="text-lg leading-6 font-medium text-gray-900">{title}</h3>
                                    <div className="mt-2"> <p className="text-sm text-gray-500 whitespace-pre-wrap">{message}</p> </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                            <button type="button" onClick={onConfirm} className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">削除</button>
                            <button type="button" onClick={onCancel} className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">キャンセル</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AutoResizeTextarea = ({ value, onChange, placeholder, className = "" }) => {
            const textareaRef = useRef(null);
            useLayoutEffect(() => {
                const el = textareaRef.current;
                if (el) { el.style.height = "auto"; el.style.height = `${el.scrollHeight}px`; }
            }, [value]);
            return ( <textarea ref={textareaRef} value={value || ''} onChange={onChange} placeholder={placeholder} className={`w-full p-2 border border-gray-300 rounded-md shadow-sm resize-none focus:ring-blue-500 focus:border-blue-500 text-sm overflow-hidden ${className}`} rows="1" /> );
        };

        const EditableField = ({ label, iconName, children }) => (
            <div>
                <label className="flex items-center text-sm font-semibold text-gray-500 mb-2"> <LucideIcon name={iconName} size={16} /> <span className="ml-2">{label}</span> </label>
                {children}
            </div>
        );

        function dataUrlToBlobUrl(dataUrl) {
          try {
            if (!dataUrl) return null;
            const [header, base64] = dataUrl.split(',');
            const mime = (header.match(/data:(.*?);base64/) || [])[1] || 'application/pdf';
            const bin = atob(base64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const blobUrl = URL.createObjectURL(new Blob([bytes], { type: mime }));
            return blobUrl;
          } catch (e) {
            console.error("Blob conversion failed", e);
            return null;
          }
        }

        const mockApi = {
            uploadFile: (file) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const reader = new FileReader();
                        reader.onload = () => resolve({ name: file.name, url: reader.result, storageKey: `materials/${Date.now()}-${file.name}` });
                        reader.onerror = (error) => reject({ status: 500, message: 'ファイル読み込み中にエラーが発生しました。' });
                        reader.readAsDataURL(file);
                    }, 500);
                });
            }
        };

        const ApiKeyModal = ({ isOpen, onClose, onSave }) => {
            const [apiKey, setApiKey] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">APIキーの設定</h3>
                        <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-2 border rounded mb-4" placeholder="AIza..." />
                        <div className="flex justify-end space-x-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button>
                            <button onClick={() => { if(apiKey.trim()) onSave(apiKey.trim()); }} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">保存して閉じる</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AIConsultModal = ({ isOpen, onClose, apiKey }) => {
            const [input, setInput] = useState('');
            const [response, setResponse] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            if (!isOpen) return null;

            const handleConsult = async () => {
                if (!input.trim()) return;
                setIsLoading(true);
                setResponse('');
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: AI_SYSTEM_PROMPT + "\n\n【お客様状況】\n" + input }] }] })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    setResponse(data.candidates?.[0]?.content?.parts?.[0]?.text || "エラーが発生しました。");
                } catch (error) { setResponse(`エラー: ${error.message}`); } finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><LucideIcon name="brain" className="text-purple-600"/> AI営業コンシェルジュ</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div className="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                            <div className="flex-1 flex flex-col min-h-0">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">お客様の状況</label>
                                <textarea value={input} onChange={(e) => setInput(e.target.value)} className="flex-1 w-full p-4 border rounded-lg resize-none focus:ring-2 focus:ring-purple-500 text-sm" placeholder="例：30代夫婦..." />
                                <button onClick={handleConsult} disabled={isLoading || !input.trim()} className="mt-4 w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 disabled:bg-gray-300 transition-colors flex justify-center items-center gap-2">{isLoading ? '思考中...' : '相談する'}</button>
                            </div>
                            <div className="flex-1 flex flex-col min-h-0 bg-gray-50 rounded-lg border p-4 overflow-y-auto">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">AIアドバイス</label>
                                {response ? <div className="markdown-body text-sm leading-relaxed" dangerouslySetInnerHTML={{ __html: marked.parse(response) }} /> : <div className="flex-1 flex items-center justify-center text-gray-400 text-sm">相談内容を入力してください</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const RepresentativeManagementModal = ({ isOpen, onClose, salesReps, onAddRep, onUpdateRep, onDeleteRep }) => {
            const [editingId, setEditingId] = useState(null);
            const [editingName, setEditingName] = useState('');

            if (!isOpen) return null;
            if (!salesReps || !Array.isArray(salesReps)) return null;

            const handleStartEdit = (rep) => {
                setEditingId(rep.id);
                setEditingName(rep.name);
            };

            const handleSaveEdit = (repId) => {
                if (editingName.trim()) {
                    onUpdateRep(repId, editingName.trim());
                }
                setEditingId(null);
                setEditingName('');
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setEditingName('');
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <LucideIcon name="users" className="text-indigo-600" size={24} />
                                担当者管理
                            </h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100">
                                &times;
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="space-y-3">
                                {salesReps.map((rep) => (
                                    <div key={rep.id} className="flex items-center gap-3 p-4 border rounded-lg hover:shadow-md transition-shadow bg-gray-50">
                                        {editingId === rep.id ? (
                                            <>
                                                <input
                                                    type="text"
                                                    value={editingName}
                                                    onChange={(e) => setEditingName(e.target.value)}
                                                    className="flex-1 px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    autoFocus
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter') handleSaveEdit(rep.id);
                                                        if (e.key === 'Escape') handleCancelEdit();
                                                    }}
                                                />
                                                <button
                                                    onClick={() => handleSaveEdit(rep.id)}
                                                    className="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm font-medium"
                                                >
                                                    <LucideIcon name="check" size={16} />
                                                </button>
                                                <button
                                                    onClick={handleCancelEdit}
                                                    className="px-3 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition-colors text-sm font-medium"
                                                >
                                                    <LucideIcon name="x" size={16} />
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                <div className="flex-1 font-medium text-gray-800">{rep.name}</div>
                                                <button
                                                    onClick={() => handleStartEdit(rep)}
                                                    className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium flex items-center gap-1"
                                                >
                                                    <LucideIcon name="edit-2" size={14} />
                                                    編集
                                                </button>
                                                <button
                                                    onClick={() => onDeleteRep(rep.id, rep.name)}
                                                    className="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-1"
                                                >
                                                    <LucideIcon name="trash-2" size={14} />
                                                    削除
                                                </button>
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                            <button
                                onClick={onAddRep}
                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-bold shadow-sm"
                            >
                                <LucideIcon name="user-plus" size={18} />
                                新規担当者を追加
                            </button>
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors font-medium"
                            >
                                閉じる
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        //  2. Data Definitions (VERSION 18 - FIXED)
        // ==========================================
        const salesInitialData = {
            salesReps: [
                { id: 'rep1', name: '德田 耕明' }, { id: 'rep2', name: '田畑 美香' }, { id: 'rep3', name: '金村 晃功' },
                { id: 'rep4', name: '湯谷 憲一' }, { id: 'rep5', name: '光川 実緒' }, { id: 'rep6', name: '西村 貴裕' },
                { id: 'rep7', name: '吉田 祐' }, { id: 'rep8', name: '小松 大樹' }, { id: 'rep9', name: '稲尾 拓慎' },
                { id: 'rep10', name: '舟橋 裕也' }, { id: 'rep11', name: '髙木 徹' }, { id: 'rep12', name: '杉村 悠斗' },
                { id: 'rep13', name: '葉山 一輝' }, { id: 'rep14', name: '阿部 澄人' },
            ],
            // IDを 'chap1', 'chap2'... に統一
            trainingItems: [
                { id: 'chap1', name: '第一章　原理原則・心構え', category: 'A研修 (デビュー)', description: '営業としてのマインドセット、G HOUSEの理念、お客様への基本姿勢を学ぶ。\n\n【目標】\n・接客デビューできる状態\n・基本動作の習得', documents: [] },
                { id: 'chap2', name: '第二章　見学説明会（セミナー）', category: 'A研修 (デビュー)', description: 'モデルハウス案内やセミナーでのプレゼンテーションスキルを習得する。\n\n【目標】\n・1ヶ月目でセミナーデビュー\n・標準トークの完遂', documents: [] },
                { id: 'chap3', name: '第三章　個別相談・提案力', category: 'B研修 (1.5棟/月)', description: 'お客様ごとの課題を解決するヒアリング能力と、最適なプランを提案する力を養う。\n\n【目標】\n・実践スキルの習得\n・ヒアリングからの課題特定', documents: [] },
                { id: 'chap4', name: '第四章　全体像の把握', category: 'B研修 (1.5棟/月)', description: '資金計画、土地探し、契約から引き渡しまでの全体フローを理解し、お客様をリードする。\n\n【目標】\n・トラブルのない進行管理\n・資金計画の精度向上', documents: [] },
                { id: 'chap5', name: '第五章　性能知識（YouTube学習）・ショールーム見学', category: 'B研修 (1.5棟/月)', description: 'G HOUSEの核心である高性能（気密・断熱・耐震）を深く理解し、他社との差別化を語れるようにする。YouTube動画教材やショールームでの実地学習を含む。\n\n【目標】\n・性能メリットの言語化\n・競合対策', documents: [] },
                { id: 'chap6', name: '第六章　成長編（2.5棟/月目標）', category: 'C研修 (独り立ち)', description: '安定して月2.5棟を受注するための高度なクロージング技術と、紹介受注を生む人間力を磨く。C研修を反復継続し、トップセールスを目指す。\n\n【目標】\n・独り立ち\n・コンスタントな受注', documents: [] },
            ],
            // Progressのキーも 'chap1', 'chap2'... に統一
            progress: {
              rep1: {
                  chap1: { status: '◎', comments: [{id: 1, date: '2025-09-20', text: '合格。'}] },
                  chap2: { status: '◎', comments: [] },
                  chap3: { status: '△', comments: [] },
                  chap4: { status: '未着手', comments: [] },
                  chap5: { status: '未着手', comments: [] },
                  chap6: { status: '未着手', comments: [] }
              },
            },
            // 月次契約数データ（8月起算の年度管理）
            contracts: {
                // rep1: { '2024': { '8': 0, '9': 0, '10': 0, '11': 0, '12': 0, '1': 0, '2': 0, '3': 0, '4': 0, '5': 0, '6': 0, '7': 0 } }
            }
        };

        // Flow Data (省略せず記述)
        const initialFlowSteps = [
            { id: 101, days: "随時", title: "資料請求対応", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 102, days: "", title: "紹介制度（反響処理）", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 103, days: "", title: "顧客管理", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 104, days: "0日", title: "セミナー資料準備・モデルハウス備品準備", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 1, days: "", title: "モデルハウス見学説明会", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 2, days: "", title: "Gハウス限定会員入会", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 105, days: "", title: "会員へお礼連絡", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 3, days: "30日", title: "初回面談", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 106, days: "", title: "事前審査", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 4, days: "", title: "土地探し", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 5, days: "", title: "いえプロ送客", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 107, days: "60日", title: "商談2", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 108, days: "", title: "商談3", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 6, days: "", title: "建築申込（3万円）", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 109, days: "", title: "建築申込金の返金申し込み対応", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 110, days: "", title: "建築申込金の返金時の営業事務側返金対応", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 111, days: "", title: "新規プラン依頼（業者へ見積もり依頼）", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 7, days: "", title: "プラン提案", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 34, days: "", title: "契約内定 (内定報告)", role: "sales", purpose: "", procedure: `内定が決まった際に下記内容を報告する。\n\n▪️お客様名：\n▪️契約日　：\n▪️時間　_：\n▪️契約場所：\n▪️初回ヒアリング予定日：\n▪️打ち合わせ希望店舗　：\n▪️打ち合わせ可能曜日　：\n▪️間取り確定日数　　　：\n▪️商品名　：\n▪️キャンペーン内容　　：\n▪️2026年7月末完成案件か：\n▪️銀行名　：\n▪️本申し込みに建築確認済証が必要か：\n▪️着工金に建築確認済証が必要か：\n▪️最終金の金消に表題登記完了が必要か：\n▪️最終金の手続きは検査済証が必要か：\n▪️解体業者：\n解体工期：\n▪️測量日　：\n▪️農地転用や市街化調整区域、43申請など：\n▪️土地決済日：\n▪️造成完了日：\n▪️分筆完了日、誰が分筆するか：\n▪️懸念事項　：\n▪️LIFEXの場合のプラン番号：`, manualUrl: "" },
            { id: 13, days: "", title: "本審査", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 112, days: "", title: "ダンドリワークの作成", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 8, days: "", title: "契約前資料の準備", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 113, days: "", title: "請負契約書作成", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 12, days: "", title: "請負契約", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 114, days: "90日", title: "契約書締結後の処理", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 115, days: "91日", title: "営業コンシェルジュのお客様LINEグループへ参加", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 116, days: "", title: "お申し出発生時の対応", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 117, days: "", title: "各種申請事項", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 118, days: "120日", title: "間取り変更資料作成", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 119, days: "", title: "業者賞金証明書提出", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 120, days: "", title: "変更契約書作成", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 25, days: "150日", title: "変更契約", role: "sales", purpose: "", procedure: `1.変更契約時に打合せ時に確定した費用の確認...`, manualUrl: "" },
            { id: 121, days: "", title: "仮ポイント依頼", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 122, days: "180日", title: "着工金入金手続き", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 123, days: "", title: "着工金入金", role: "sales", purpose: "", procedure: `1.変更契約時にご案内しているが着工5日前に...`, manualUrl: "" },
            { id: 124, days: "", title: "補助金申請", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 125, days: "210日", title: "上棟金入金手続き", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 126, days: "", title: "上棟金入金", role: "sales", purpose: "", procedure: `1.手続きは着工金と同様...`, manualUrl: "" },
            { id: 127, days: "", title: "上棟立会連絡 (LINEコンシェルジュ)", role: "admin", purpose: "", procedure: "LINEコンシェルジュにてお客様へ上棟立会連絡を行う", manualUrl: "" },
            { id: 128, days: "240日", title: "最終立会", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 129, days: "", title: "精算書確認", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 130, days: "270日", title: "最終金入金確認", role: "sales", purpose: "", procedure: `1.引渡し45日前になれば引渡し案内資料をお客様へ...`, manualUrl: "" },
            { id: 131, days: "300日", title: "最終金入金手続き", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 132, days: "", title: "気密測定結果送付 (LINE)", role: "admin", purpose: "", procedure: "気密測定結果をお客様へLINEで送付する", manualUrl: "" },
            { id: 133, days: "", title: "引渡しBOX作成", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 33, days: "330日", title: "お引渡し", role: "sales", purpose: "", procedure: `1.鍵渡しの定義は最終金確認後...`, manualUrl: "" },
            { id: 134, days: "", title: "引渡し後書類送付", role: "admin", purpose: "", procedure: "", manualUrl: "" },
        ];

        const bankTemplate = {
          repaymentPeriod: "", loanPlan: "", handlingFee: "", groupCreditLifeInsurance: "", other: "", productSummaryLink: "",
          buildingCertIssued: "", buildingCertApplication: "", interimInspectionCert: "", completionInspectionCert: "",
          titleRegistration: "", bridgeLoan: "", constructionContract: "", additionalContract: "", exteriorContract: "",
          fireInsuranceApplication: "", contactList: "",
        };

        const initialBankData = [
          { id: 1, name: "りそな銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "40年以内", productSummaryLink: "りそな銀行 商品概要書 202502", buildingCertIssued: "金消までに", completionInspectionCert: "不要", titleRegistration: "実行日までに", bridgeLoan: "りそなにて着工・上棟、つなぎ融資対応可", contactList: "梅田ローンプラザ 06-6312-7680" } },
          { id: 2, name: "三井住友銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "35年以内", loanPlan: "融資手数料型", handlingFee: "借入額の2.2%", productSummaryLink: "三井住友銀行 商品概要書 202503", buildingCertIssued: "建物本申込時", buildingCertApplication: "建物本申込時", interimInspectionCert: "不要", completionInspectionCert: "不要", titleRegistration: "最終金の支払いの目までに", constructionContract: "建物本申込時", additionalContract: "建物本申込時", bridgeLoan: "なし 建物分割して融資可能", other: "・土地本申込時に請負契約不要", contactList: "梅田ローンプラザ 06-7711-0831" } },
          { id: 3, name: "住信SBIネット銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "35年以内", loanPlan: "融資手数料型", handlingFee: "借入額の2.2%", groupCreditLifeInsurance: "50歳以下であれば、\nガン50%・就業不能保障 上乗せなしで追加", productSummaryLink: "住信SBI 商品概要書 202010", buildingCertIssued: "金消の2週間前までに必要", buildingCertApplication: "建確と同じ", interimInspectionCert: "東北背事つなぎ融資の場合、上棟金1週間前までに必要", completionInspectionCert: "実行の4営業日前までに必要", titleRegistration: "実行日の前日までに必要", bridgeLoan: "東北背事 or SBIでのつなぎ融資対応", other: "・抵当権設定の指定司法書士あり（Wing）", contactList: "梅田ローンプラザ 福田さん 080-3021-9887" } },
          { id: 4, name: "京都銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "35年以内", handlingFee: "55,000円", groupCreditLifeInsurance: "45歳以下 がん100 上乗せなし", productSummaryLink: "京都銀行 商品概要書 202012", buildingCertIssued: "着工金の1週間前", interimInspectionCert: "不要", titleRegistration: "実行日までに必要", bridgeLoan: "不要 留保金対応", contactList: "伏見ローンプラザ 075-604-0010" } },
          { id: 5, name: "池田泉州銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "最長50年", loanPlan: "融資手数料型/保証料金利上乗せ型", handlingFee: "原則55,000円", groupCreditLifeInsurance: "就業不能保障 +0.1%\nガン100 +0.2% 三大疾病100 +0.2%", productSummaryLink: "池田泉州銀行 商品概要書 202401", buildingCertIssued: "建物の正式申込までに必要", buildingCertApplication: "1～6面、図面必要", interimInspectionCert: "不要", completionInspectionCert: "不要", titleRegistration: "実行日までに", constructionContract: "正式申込時に必要", additionalContract: "金消までに必要", bridgeLoan: "池泉にて着工・上棟、つなぎ融資", other: "・諸費用50万円まで使途自由金あり", contactList: "池田ローンプラザ 072-753-3741" } },
          { id: 6, name: "南都銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "40年以内", handlingFee: "55,000円", productSummaryLink: "南都銀行 商品概要書 202109", buildingCertIssued: "正式申込までに", completionInspectionCert: "不要", titleRegistration: "最終金の支払いの日までに", bridgeLoan: "なし 建物実行して留保金対応", contactList: "大阪エルプラザ" } },
          { id: 7, name: "フラット35（ドコモファイナンス）", type: 'main', details: { ...bankTemplate, repaymentPeriod: "最長50年", loanPlan: "固定金利", handlingFee: "2.2%", contactList: "中川さん 090-7130-9253" } },
          { id: 8, name: "但馬銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "40年以内", loanPlan: "保証料金利上乗せ型/手数料定率型", handlingFee: "55,000円～", productSummaryLink: "但馬銀行 商品概要書 202502", buildingCertIssued: "不要", completionInspectionCert: "不要", titleRegistration: "最終金の支払いの日までに", constructionContract: "金消契約時に必要", bridgeLoan: "なし 着工全枠に実行して留保金対応", other: "・金消の3日前までには確認済証が必要", contactList: "西宮ローンセンター 0798-64-6221" } },
          { id: 9, name: "山陰合同銀行", type: 'main', details: { ...bankTemplate, repaymentPeriod: "最長50年", loanPlan: "", handlingFee: "2.2%", contactList: "西宮支店 岩井さん 080-8247-5879" } },

          { id: 10, name: "紀陽銀行", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "40年以内", loanPlan: "保証料一括前払型/保証料金利上乗せ型", handlingFee: "55,000円", groupCreditLifeInsurance: "がん100 +0.15% 三大疾病100 +0.2%", productSummaryLink: "紀陽銀行 商品概要書 202404", buildingCertIssued: "正式申込時に必要", buildingCertApplication: "正式申込時に必要", completionInspectionCert: "実行日までにあれば送付", titleRegistration: "実行日までに必要", constructionContract: "正式申込時に必要", bridgeLoan: "つなぎ融資ない", contactList: "八戸ノ里住宅ローンセンター 06-6725-3451" } },
          { id: 11, name: "SBI新生銀行", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35年以内", other: "詳細は商品概要書を確認" } },
          { id: 12, name: "イオン銀行", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35年以内", loanPlan: "融資手数料型", handlingFee: "2.2%", groupCreditLifeInsurance: "がん100 +0.1%", productSummaryLink: "イオン銀行 商品概要書 202404", buildingCertIssued: "金消までに必要", completionInspectionCert: "実行2営業日前", titleRegistration: "登記申請書が必要", other: "指定司法書士あり", contactList: "東京営業所 03-6636-8001" } },
          { id: 13, name: "香川銀行", type: 'sub', details: { ...bankTemplate, productSummaryLink: "香川銀行 商品概要書 202507", buildingCertIssued: "必要", completionInspectionCert: "支払いまでに", other: "土地と建物一本実行", contactList: "大阪支店" } },
          { id: 14, name: "関西みらい銀行", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "40年以内", handlingFee: "55,000円", productSummaryLink: "関西みらい銀行 商品概要書 202409", buildingCertIssued: "正式申込時に必要", interimInspectionCert: "不要", titleRegistration: "実行日までに", bridgeLoan: "関西みらいにてつなぎ融資", contactList: "羽曳野JLC" } },
          { id: 15, name: "京都信用金庫", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "50年以内", handlingFee: "55,000円", groupCreditLifeInsurance: "3大疾病団信付", productSummaryLink: "京信 商品概要書", completionInspectionCert: "実行までに", contactList: "枚方支店 072-846-2111" } },
          { id: 16, name: "京都中央信用金庫", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35年以内", handlingFee: "55,000円", interimInspectionCert: "必要", completionInspectionCert: "支払日までに", bridgeLoan: "不要 留保金対応", contactList: "京都中央信用金庫" } },
          { id: 17, name: "近畿ろうきん", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "最長50年", handlingFee: "なし", groupCreditLifeInsurance: "がん団信 上乗せなし", productSummaryLink: "近畿ろうきん 商品概要書 202410", interimInspectionCert: "必要", titleRegistration: "実行の1週間前", bridgeLoan: "ろうきんにてつなぎ融資", contactList: "枚方支店" } },
          { id: 18, name: "みずほ銀行", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35年以内", productSummaryLink: "みずほ銀行 商品概要書 202503", buildingCertIssued: "送付してからの金消", buildingCertApplication: "必要", completionInspectionCert: "なくても可", titleRegistration: "最終金の支払いの日までに", bridgeLoan: "なし 建物分割して融資可能", contactList: "梅田ローンスクエア" } },
          { id: 19, name: "三菱UFJ銀行", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35年以内", handlingFee: "2.3%", productSummaryLink: "三菱UFJ銀行 商品概要書 202404", buildingCertIssued: "金消の4営業日前までに必要", completionInspectionCert: "不要", titleRegistration: "不要", bridgeLoan: "なし JIO利用あり", contactList: "神戸営業所" } },
          { id: 20, name: "ARUHI フラット", type: 'sub', details: { ...bankTemplate, buildingCertIssued: "金消までに確認が必要", completionInspectionCert: "不要 適合証明が必要", other: "指定の司法書士なし", contactList: "" } }
        ];

        // Initial Debut Training Data
        const initialDebutTrainingData = {
          'A研修 (デビュー)': [
            { id: 'da1', title: 'ビジネスマナー基礎', pdfs: [], urls: [] },
            { id: 'da2', title: '会社理念と歴史', pdfs: [], urls: [] },
            { id: 'da3', title: '接客ロールプレイング基礎', pdfs: [], urls: [] }
          ],
          'B研修 (1.5棟/月)': [
             { id: 'db1', title: '商品知識詳細', pdfs: [], urls: [] },
             { id: 'db2', title: '資金計画実践', pdfs: [], urls: [] },
             { id: 'db3', title: '競合比較分析', pdfs: [], urls: [] }
          ],
          'C研修 (独り立ち)': [
             { id: 'dc1', title: 'クロージング技術', pdfs: [], urls: [] },
             { id: 'dc2', title: '紹介営業手法', pdfs: [], urls: [] },
             { id: 'dc3', title: 'トラブルシューティング', pdfs: [], urls: [] }
          ]
        };

        const STATUS_OPTIONS = ['未着手', '研修中', 'テスト不合格後再研修', 'テスト合格'];
        const STATUS_VALUE = { '未着手': 0, '研修中': 0.3, 'テスト不合格後再研修': 0.6, 'テスト合格': 1 };
        const STATUS_COLOR = {
          '未着手': { text: 'text-gray-500', bg: 'bg-gray-200' },
          '研修中': { text: 'text-blue-500', bg: 'bg-blue-200' },
          'テスト不合格後再研修': { text: 'text-orange-500', bg: 'bg-orange-200' },
          'テスト合格': { text: 'text-green-500', bg: 'bg-green-200' }
        };

        // ==========================================
        //  3. Flow App Components (営業作業フロー)
        // ==========================================

        const StepSelector = ({ listTitle, steps, selectedStepId, onSelectStep, onAddStep, onRequestDeleteStep, draggingItem, setDraggingItem, dragOverItem, setDragOverItem, onDragSort }) => {
            const [isEditMode, setIsEditMode] = useState(false);

            const handleDragStart = (e, index) => { if (!isEditMode) return; setDraggingItem(index); e.dataTransfer.effectAllowed = 'move'; };
            const handleDragEnter = (index) => { if (!isEditMode) return; setDragOverItem(index); };
            const handleDragEnd = () => { if (!isEditMode) return; if (draggingItem !== null && dragOverItem !== null && draggingItem !== dragOverItem) onDragSort(); setDraggingItem(null); setDragOverItem(null); };
            const getDragStyle = (index) => { if (!isEditMode) return ''; if (index === draggingItem) return 'opacity-30'; if (index === dragOverItem) return 'border-t-2 border-blue-500'; return ''; };

            return (
                <div className="w-96 h-full bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0">
                    <div className="p-4 border-b border-gray-200 flex justify-between items-center group bg-white sticky top-0 z-10">
                        <h2 className="text-lg font-bold text-gray-900 truncate">{listTitle}</h2>
                        <button onClick={() => setIsEditMode(!isEditMode)} className={`flex-shrink-0 px-3 py-1 rounded text-xs font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{isEditMode ? '完了' : '編集'}</button>
                    </div>

                    {isEditMode ? (<>
                        <div className="flex-1 overflow-y-auto">
                            {steps.map((step, index) => (
                                <div key={step.id} draggable={true} onDragStart={(e) => handleDragStart(e, index)} onDragEnter={() => handleDragEnter(index)} onDragEnd={handleDragEnd} onDragOver={(e) => e.preventDefault()} className={`flex items-center justify-between p-3 border-b border-gray-200 group bg-white ${getDragStyle(index)} cursor-move`}>
                                    <div className="flex items-center w-full overflow-hidden">
                                        <LucideIcon name="grip-vertical" className="mr-2 text-gray-400 flex-shrink-0" size={16} />
                                        <div className="flex-1 min-w-0">
                                            <div className="flex gap-2 items-center mb-1">
                                                {step.days && <span className="text-[10px] font-bold text-gray-500 bg-gray-100 px-1 rounded">{step.days}</span>}
                                                <span className={`text-[10px] px-1 rounded border ${step.role === 'admin' ? 'bg-white text-gray-500 border-gray-300' : 'bg-amber-800 text-white border-transparent'}`}>{step.role === 'admin' ? '事務' : '営業'}</span>
                                            </div>
                                            <div className="text-sm font-medium text-gray-800 truncate">{step.title}</div>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); onRequestDeleteStep(step.id, step.title); }} className="text-gray-400 hover:text-red-500 ml-2 p-1"><LucideIcon name="trash-2" size={16} /></button>
                                    </div>
                                </div>
                            ))}
                            <div className="p-4 border-t border-gray-200 bg-white">
                                <button onClick={onAddStep} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors"><LucideIcon name="plus" className="mr-1" size={16} /> ステップを追加</button>
                            </div>
                        </div>
                        </>
                    ) : (<>
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar relative">
                             <div className="flex gap-2 mb-4 text-[10px] justify-center sticky top-0 bg-gray-50 pb-2 z-10">
                                <div className="flex items-center"><span className="w-3 h-3 bg-amber-800 rounded mr-1"></span>営業担当</div>
                                <div className="flex items-center"><span className="w-3 h-3 bg-white border border-gray-400 rounded mr-1"></span>営業事務</div>
                             </div>

                             <div className="relative pl-4 border-l-2 border-gray-300 min-h-[500px] pb-10 ml-4">
                                 {steps.map((step, index) => {
                                     const isTimelinePoint = step.days && step.days.includes("日") && !step.days.includes("随時");
                                     return (
                                         <>
                                             {isTimelinePoint && (
                                                <div className="absolute -left-[60px] top-2 flex flex-col items-end w-12">
                                                    <span className="text-[10px] font-bold text-gray-600 bg-gray-200 px-1 rounded whitespace-nowrap">{step.days}</span>
                                                    <div className="absolute -right-[23px] top-1.5 w-3 h-3 rounded-full bg-blue-500 border-2 border-white"></div>
                                                </div>
                                             )}
                                             {!isTimelinePoint && (
                                                 <div className="absolute -left-[23px] top-4 w-2 h-2 rounded-full bg-gray-300"></div>
                                             )}

                                             <div
                                                  key={step.id}
                                                  onClick={() => onSelectStep(step.id)}
                                                  className={`ml-2 p-3 rounded border cursor-pointer text-sm shadow-sm transition-all relative mb-6 ${selectedStepId === step.id ? 'ring-2 ring-blue-500 z-10 scale-[1.02]' : 'hover:shadow-md hover:scale-[1.01]'} ${step.role === 'admin' ? 'bg-white border-gray-300 text-gray-800' : 'bg-amber-800 text-white border-transparent'}`}
                                             >
                                                 {step.days && !isTimelinePoint && <span className="text-[10px] font-bold opacity-70 block mb-1">{step.days}</span>}
                                                 <div className="font-medium">{step.title}</div>
                                             </div>
                                         </>
                                     );
                                 })}                             </div>
                        </div>
                        </>
                    )}
                </div>
            );
        };

        const StepEditor = ({ step, onUpdateStep, isEditMode }) => {
          if (!step)
            return (
              <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 flex items-center justify-center text-gray-500">
                ステップを選択してください
              </div>
            );

          const handleFieldChange = (field, value) =>
            onUpdateStep(step.id, { ...step, [field]: value });

          return (
            <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 overflow-y-auto">
              <div className="p-6">
                {/* ヘッダー */}
                <div className="mb-6 pb-4 border-b">
                  <div className="flex items-center gap-2 mb-2">
                    <span
                      className={`px-2 py-1 rounded text-xs font-bold ${
                        step.role === "admin"
                          ? "bg-gray-100 text-gray-600 border border-gray-300"
                          : "bg-amber-800 text-white"
                      }`}
                    >
                      {step.role === "admin" ? "営業事務" : "営業担当"}
                    </span>
                    {step.days && (
                      <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                        {step.days}
                      </span>
                    )}
                  </div>

                  {isEditMode ? (
                    <input
                      type="text"
                      value={step.title}
                      onChange={(e) => handleFieldChange("title", e.target.value)}
                      className="text-2xl font-bold text-gray-900 w-full border-b border-transparent focus:border-blue-500 focus:outline-none py-1"
                    />
                  ) : (
                    <h2 className="text-2xl font-bold text-gray-900 py-1">{step.title}</h2>
                  )}
                </div>

                {/* 本文 */}
                {isEditMode ? (
                  <div className="space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-500 mb-1">時期目安</label>
                        <input
                          type="text"
                          value={step.days || ''}
                          onChange={(e) => handleFieldChange('days', e.target.value)}
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                          placeholder="例: 30日"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-500 mb-1">担当</label>
                        <select
                          value={step.role || 'sales'}
                          onChange={(e) => handleFieldChange('role', e.target.value)}
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                        >
                          <option value="sales">営業担当</option>
                          <option value="admin">営業事務</option>
                        </select>
                      </div>
                    </div>

                    <EditableField label="目的" iconName="check">
                      <AutoResizeTextarea
                        value={step.purpose}
                        onChange={(e) => handleFieldChange('purpose', e.target.value)}
                        placeholder="目的を入力..."
                      />
                    </EditableField>

                    <EditableField label="手順" iconName="file-text">
                      <AutoResizeTextarea
                        value={step.procedure}
                        onChange={(e) => handleFieldChange('procedure', e.target.value)}
                        placeholder="手順を入力..."
                        className="min-h-[100px]"
                      />
                    </EditableField>

                    <EditableField label="マニュアル (URL)" iconName="link">
                      <AutoResizeTextarea
                        value={step.manualUrl}
                        onChange={(e) => handleFieldChange('manualUrl', e.target.value)}
                        placeholder="URLを入力..."
                      />
                    </EditableField>
                  </div>
                ) : (
                  <div className="space-y-4 text-gray-800">
                    {step.days && (
                      <div className="text-sm">
                        <span className="font-semibold">時期目安:</span> {step.days}
                      </div>
                    )}
                    <div className="text-sm">
                      <span className="font-semibold">担当:</span> {step.role === 'sales' ? '営業担当' : '営業事務'}
                    </div>
                    {step.purpose && (
                      <div className="text-sm">
                        <span className="font-semibold">目的:</span>
                        <div className="mt-1 whitespace-pre-wrap">{step.purpose}</div>
                      </div>
                    )}
                    {step.procedure && (
                      <div className="text-sm">
                        <span className="font-semibold">手順:</span>
                        <div className="mt-1 whitespace-pre-wrap">{step.procedure}</div>
                      </div>
                    )}
                    {step.manualUrl && (
                      <div className="text-sm">
                        <span className="font-semibold">マニュアル:</span>
                        <a
                          href={step.manualUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-600 hover:underline ml-1"
                        >
                          {step.manualUrl}
                        </a>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        };

        const FlowManagementApp = () => {
            const [flowSteps, setFlowSteps] = usePersistentState('ghouse_flow_steps_v13', initialFlowSteps.map((step, index) => ({ ...step, masterIndex: index })));
            const [selectedStepId, setSelectedStepId] = useState(flowSteps[0]?.id || null);
            const [draggingItem, setDraggingItem] = useState(null);
            const [dragOverItem, setDragOverItem] = useState(null);
            const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });
            const [isEditMode, setIsEditMode] = useState(false);

            const selectedStep = flowSteps.find(s => s.id === selectedStepId);
            const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
            const closeModal = () => setModalState({ ...modalState, isOpen: false });

            const handleAddStep = () => {
                const newId = Math.max(...flowSteps.map(s => s.id), 0) + 1;
                const newStep = { id: newId, title: "新規ステップ", role: "sales", purpose: "", procedure: "", manualUrl: "" };
                setFlowSteps([...flowSteps, newStep]);
                setSelectedStepId(newId);
            };
            const handleUpdateStep = (id, updatedStep) => setFlowSteps(flowSteps.map(s => s.id === id ? updatedStep : s));
            const handleDragSort = () => {
                const items = [...flowSteps];
                const [reorderedItem] = items.splice(draggingItem, 1);
                items.splice(dragOverItem, 0, reorderedItem);
                setFlowSteps(items);
            };
            const handleRequestDeleteStep = (id, title) => {
                showModal("ステップ削除", `「${title}」を削除してもよろしいですか？`, () => {
                    const newSteps = flowSteps.filter(s => s.id !== id);
                    setFlowSteps(newSteps);
                    if (selectedStepId === id) setSelectedStepId(newSteps[0]?.id || null);
                    closeModal();
                });
            };

            return (
                <div className="flex h-full w-full bg-gray-100 font-sans">
                    <ErrorBoundary>
                        <StepSelector listTitle="営業作業フロー" steps={flowSteps} selectedStepId={selectedStepId} onSelectStep={setSelectedStepId} onAddStep={handleAddStep} onRequestDeleteStep={handleRequestDeleteStep} draggingItem={draggingItem} setDraggingItem={setDraggingItem} dragOverItem={dragOverItem} setDragOverItem={setDragOverItem} onDragSort={handleDragSort} />
                        <main className="flex-1 p-6 overflow-hidden h-full flex flex-col"><div className="flex justify-end mb-4"><button onClick={() => setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded text-sm font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{isEditMode ? '完了' : '編集'}</button></div><StepEditor step={selectedStep} onUpdateStep={handleUpdateStep} isEditMode={isEditMode} /></main>
                        <ConfirmModal isOpen={modalState.isOpen} title={modalState.title} message={modalState.message} onConfirm={modalState.onConfirm} onCancel={closeModal} />
                    </ErrorBoundary>
                </div>
            );
        };

        // ==========================================
        //  4. Bank App Components (各種銀行)
        // ==========================================

        const BankEditableRow = ({ label, value, onChange, placeholder, icon, onDelete, fieldKey }) => {
          return ( <div className="grid grid-cols-3 gap-4 items-start group"> <label className="flex items-center text-sm font-semibold text-gray-700 col-span-1 mt-2"> {icon} {label} </label> <div className="col-span-2 flex gap-2"> <AutoResizeTextarea value={value} onChange={onChange} placeholder={placeholder || "詳細を入力..."} className="min-h-[40px] flex-1" /> {onDelete && <button onClick={() => onDelete(fieldKey)} className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2"><LucideIcon name="trash-2" size={16}/></button>} </div> </div> );
        };

        const BankEditor = ({ bank, onUpdateBank, onAddDetailField, onDeleteDetailField }) => {
          const [newFieldName, setNewFieldName] = useState('');
          const [showAddField, setShowAddField] = useState(false);

          if (!bank) return <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 flex items-center justify-center"> <p className="text-gray-500 text-lg">左のリストから銀行を選択してください</p> </div>;

          // フィールド名の日本語マッピング
          const fieldLabels = {
              repaymentPeriod: '返済期間',
              loanPlan: '借入プラン',
              handlingFee: '事務取扱手数料',
              groupCreditLifeInsurance: '団体信用保険',
              other: 'その他',
              productSummaryLink: '商品概要リンク',
              buildingCertIssued: '建築確認済証',
              buildingCertApplication: '建築確認済証申請書',
              interimInspectionCert: '中間検査済証',
              completionInspectionCert: '完了検査済証',
              titleRegistration: '表題登記',
              bridgeLoan: 'つなぎ融資',
              constructionContract: '工事請負契約書',
              additionalContract: '追加工事請負契約書',
              exteriorContract: '外構工事請負契約書',
              fireInsuranceApplication: '火災保険申込書',
              contactList: '担当者一覧'
          };

          const details = bank.details || {};
          const handleDetailChange = (field, value) => { onUpdateBank(bank.id, { ...bank, details: { ...details, [field]: value } }); };
          const handleNameChange = (e) => { onUpdateBank(bank.id, { ...bank, name: e.target.value }); };
          const handleTypeChange = (e) => { onUpdateBank(bank.id, { ...bank, type: e.target.value }); };

          const handleAddField = () => {
              if (newFieldName.trim()) {
                  onAddDetailField(bank.id, newFieldName.trim());
                  setNewFieldName('');
                  setShowAddField(false);
              }
          };

          const detailFields = Object.keys(details);

          return ( <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 overflow-y-auto"> <div className="p-6">
              <div className="mb-6 pb-4 border-b border-gray-200">
                  <div className="flex items-center gap-4 mb-4">
                      <input type="text" value={bank.name} onChange={handleNameChange} className="text-3xl font-bold text-gray-800 border-b-2 border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none flex-1" />
                      <select value={bank.type} onChange={handleTypeChange} className="px-3 py-2 border border-gray-300 rounded-md text-sm font-semibold">
                          <option value="main">⭐ メインバンク</option>
                          <option value="sub">その他</option>
                      </select>
                  </div>
              </div>
              <div className="space-y-4">
                  {detailFields.map(fieldKey => (
                      <BankEditableRow
                          key={fieldKey}
                          label={fieldLabels[fieldKey] || fieldKey}
                          fieldKey={fieldKey}
                          icon={<LucideIcon name="file-text" size={20} />}
                          value={details[fieldKey]}
                          onChange={(e) => handleDetailChange(fieldKey, e.target.value)}
                          onDelete={onDeleteDetailField}
                      />
                  ))}

                  {showAddField ? (
                      <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                          <div className="flex gap-2">
                              <input
                                  type="text"
                                  value={newFieldName}
                                  onChange={(e) => setNewFieldName(e.target.value)}
                                  placeholder="新しい項目名を入力..."
                                  className="flex-1 p-2 border border-gray-300 rounded text-sm"
                                  onKeyDown={(e) => e.key === 'Enter' && handleAddField()}
                                  autoFocus
                              />
                              <button onClick={handleAddField} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold">追加</button>
                              <button onClick={() => { setShowAddField(false); setNewFieldName(''); }} className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">キャンセル</button>
                          </div>
                      </div>
                  ) : (
                      <button onClick={() => setShowAddField(true)} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 transition-colors flex items-center justify-center gap-2 font-semibold">
                          <LucideIcon name="plus" size={20} /> 新しい項目を追加
                      </button>
                  )}
              </div> </div> </div> );
        };

        const BankList = ({ banks, selectedBankId, onSelectBank, searchTerm, onSearchChange, onAddBank, onDeleteBank }) => {
          const filteredBanks = banks.filter(bank => bank.name.toLowerCase().includes(searchTerm.toLowerCase()));
          const mainBanks = filteredBanks.filter(b => b.type === 'main');
          const subBanks = filteredBanks.filter(b => b.type === 'sub');

          return (
             <div className="w-80 h-full bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0">
                 <div className="p-4 border-b border-gray-200">
                     <div className="relative mb-3">
                         <input type="text" value={searchTerm} onChange={onSearchChange} placeholder="銀行を検索..." className="w-full p-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" />
                         <LucideIcon name="search" className="text-gray-400 absolute left-3 top-3" size={16} />
                     </div>
                     <button onClick={onAddBank} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 text-sm">
                         <LucideIcon name="plus" size={16} /> 銀行を追加
                     </button>
                 </div>
                 <div className="flex-1 overflow-y-auto">
                     {/* Main Banks */}
                     {mainBanks.length > 0 && (
                         <div>
                             <div className="px-4 py-2 bg-blue-100 text-blue-800 text-xs font-bold uppercase tracking-wider">⭐ メインバンク</div>
                             {mainBanks.map((bank) => (
                                 <div key={bank.id} className={`group p-4 border-b border-gray-200 cursor-pointer flex items-center justify-between ${ selectedBankId === bank.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-gray-100' }`}>
                                     <h3 className={`font-medium truncate flex-1 ${selectedBankId === bank.id ? 'text-blue-800' : 'text-gray-700'}`} onClick={() => onSelectBank(bank.id)}> {bank.name} </h3>
                                     <button onClick={(e) => { e.stopPropagation(); onDeleteBank(bank.id, bank.name); }} className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                         <LucideIcon name="trash-2" size={16} />
                                     </button>
                                 </div>
                             ))}
                         </div>
                     )}

                     {/* Sub Banks */}
                     {subBanks.length > 0 && (
                         <div>
                             <div className="px-4 py-2 bg-gray-200 text-gray-700 text-xs font-bold uppercase tracking-wider">その他</div>
                             {subBanks.map((bank) => (
                                 <div key={bank.id} className={`group p-4 border-b border-gray-200 cursor-pointer flex items-center justify-between ${ selectedBankId === bank.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-gray-100' }`}>
                                     <h3 className={`font-medium truncate flex-1 ${selectedBankId === bank.id ? 'text-blue-800' : 'text-gray-700'}`} onClick={() => onSelectBank(bank.id)}> {bank.name} </h3>
                                     <button onClick={(e) => { e.stopPropagation(); onDeleteBank(bank.id, bank.name); }} className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                         <LucideIcon name="trash-2" size={16} />
                                     </button>
                                 </div>
                             ))}
                         </div>
                     )}
                 </div>
             </div>
          );
        };

        const BankManagementApp = () => {
             // Version 10: Add bank CRUD operations
             const [banks, setBanks] = usePersistentState('ghouse_banks_v10', initialBankData);
             const [selectedBankId, setSelectedBankId] = useState(banks[0]?.id || null);
             const [searchTerm, setSearchTerm] = useState("");
             const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });

             const selectedBank = banks.find(b => b.id === selectedBankId) || banks[0];

             const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
             const closeModal = () => setModalState({ ...modalState, isOpen: false });

             const handleAddBank = () => {
                 const newId = Math.max(...banks.map(b => b.id), 0) + 1;
                 const newBank = { id: newId, name: "新規銀行", type: 'sub', details: { ...bankTemplate } };
                 setBanks([...banks, newBank]);
                 setSelectedBankId(newId);
             };

             const handleDeleteBank = (id, name) => {
                 showModal("銀行削除", `「${name}」を削除してもよろしいですか？`, () => {
                     const newBanks = banks.filter(b => b.id !== id);
                     setBanks(newBanks);
                     if (selectedBankId === id) setSelectedBankId(newBanks[0]?.id || null);
                     closeModal();
                 });
             };

             const handleAddDetailField = (bankId, fieldName) => {
                 setBanks(banks.map(b => {
                     if (b.id === bankId) {
                         return { ...b, details: { ...b.details, [fieldName]: "" } };
                     }
                     return b;
                 }));
             };

             const handleDeleteDetailField = (bankId, fieldName) => {
                 showModal("項目削除", `「${fieldName}」を削除してもよろしいですか？`, () => {
                     setBanks(banks.map(b => {
                         if (b.id === bankId) {
                             const newDetails = { ...b.details };
                             delete newDetails[fieldName];
                             return { ...b, details: newDetails };
                         }
                         return b;
                     }));
                     closeModal();
                 });
             };

             return (
                 <div className="flex h-full w-full bg-gray-100">
                     <ErrorBoundary>
                         <BankList
                             banks={banks}
                             selectedBankId={selectedBankId}
                             onSelectBank={setSelectedBankId}
                             searchTerm={searchTerm}
                             onSearchChange={(e) => setSearchTerm(e.target.value)}
                             onAddBank={handleAddBank}
                             onDeleteBank={handleDeleteBank}
                         />
                         <main className="flex-1 p-6 overflow-hidden h-full">
                             <BankEditor
                                 bank={selectedBank}
                                 onUpdateBank={(id, updated) => setBanks(banks.map(b => b.id === id ? updated : b))}
                                 onAddDetailField={handleAddDetailField}
                                 onDeleteDetailField={handleDeleteDetailField}
                             />
                         </main>
                         <ConfirmModal isOpen={modalState.isOpen} title={modalState.title} message={modalState.message} onConfirm={modalState.onConfirm} onCancel={closeModal} />
                     </ErrorBoundary>
                 </div>
             );
        };

        // ==========================================
        //  5. Sales App Components (営業育成)
        // ==========================================

        const EducationScheduleHeader = () => (
            <div className="bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200">
                <h2 className="text-2xl font-bold text-center text-blue-900 mb-6">教育プログラムスケジュール</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="border rounded-xl overflow-hidden shadow-sm bg-white">
                        <div className="bg-blue-900 text-white text-center py-2"><h3 className="font-bold">A研修</h3><span className="text-xs">デビュー研修</span></div>
                        <div className="p-4 text-center"><span className="text-blue-600 font-bold border border-blue-200 px-3 py-1 rounded-full text-xs">1.5ヶ月</span><p className="font-bold mt-2">接客デビュー</p></div>
                    </div>
                    <div className="border rounded-xl overflow-hidden shadow-sm bg-white">
                        <div className="bg-blue-800 text-white text-center py-2"><h3 className="font-bold">B研修</h3><span className="text-xs">1.5棟受注研修</span></div>
                        <div className="p-4 text-center"><span className="text-blue-600 font-bold border border-blue-200 px-3 py-1 rounded-full text-xs">2.5ヶ月</span><p className="font-bold mt-2">1.5棟 / 月</p></div>
                    </div>
                     <div className="border rounded-xl overflow-hidden shadow-sm bg-white">
                        <div className="bg-blue-700 text-white text-center py-2"><h3 className="font-bold">C研修</h3><span className="text-xs">2.5棟受注研修</span></div>
                        <div className="p-4 text-center"><span className="text-blue-600 font-bold border border-blue-200 px-3 py-1 rounded-full text-xs">3ヶ月</span><p className="font-bold mt-2">2.5棟 / 月</p></div>
                    </div>
                </div>
                <div className="relative pb-2 overflow-x-auto px-2">
                    <div className="relative h-6 text-xs font-bold text-gray-600 min-w-[600px] mb-1">
                        <div className="absolute left-0">入社月</div>
                        <div className="absolute left-[12.5%] -translate-x-1/2">1.5ヶ月後</div>
                        <div className="absolute left-[33.3%] -translate-x-1/2">4ヶ月後</div>
                        <div className="absolute left-[58.3%] -translate-x-1/2">7ヶ月後</div>
                        <div className="absolute right-0">7ヶ月目以降 C研修継続</div>
                    </div>
                    <div className="flex h-8 text-white text-xs font-bold min-w-[600px] rounded-full overflow-hidden shadow-sm">
                        <div className="w-[12.5%] bg-blue-400 flex items-center justify-center border-r">A研修</div>
                        <div className="w-[20.8%] bg-blue-600 flex items-center justify-center border-r">B研修</div>
                        <div className="w-[25.0%] bg-blue-800 flex items-center justify-center border-r">C研修完了</div>
                        <div className="flex-1 bg-orange-400 flex items-center justify-center">C研修 反復継続</div>
                    </div>
                </div>
            </div>
        );

        // 月次契約数管理コンポーネント（8月起算）
        const MonthlyContractsCard = ({ repId, contracts, onUpdateContract, isEditMode }) => {
            const [showPastYears, setShowPastYears] = useState(false);
            const [selectedYear, setSelectedYear] = useState(null);

            // 現在の年度を取得（8月起算）
            const getCurrentFiscalYear = () => {
                const now = new Date();
                const month = now.getMonth() + 1; // 1-12
                const year = now.getFullYear();
                return month >= 8 ? year : year - 1;
            };

            const currentFiscalYear = getCurrentFiscalYear();
            const repContracts = contracts[repId] || {};

            // 利用可能な年度リストを取得（降順）
            const availableYears = Object.keys(repContracts).map(Number).sort((a, b) => b - a);
            // 過去10年分の年度オプションを生成
            const yearOptions = Array.from({ length: 10 }, (_, i) => currentFiscalYear - i);

            const yearsToShow = showPastYears ? availableYears : [currentFiscalYear];

            // 年度を追加
            const handleAddYear = () => {
                if (selectedYear && !repContracts[selectedYear]) {
                    ensureYearData(selectedYear);
                    setSelectedYear(null);
                    setShowPastYears(true);
                }
            };

            // 月のラベル（8月〜7月）
            const monthLabels = ['8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月', '7月'];
            const monthKeys = ['8', '9', '10', '11', '12', '1', '2', '3', '4', '5', '6', '7'];

            // 年度のデータを初期化（空の状態で作成）
            const ensureYearData = (year) => {
                if (!repContracts[year]) {
                    const newContracts = { ...contracts };
                    if (!newContracts[repId]) newContracts[repId] = {};
                    newContracts[repId][year] = {};
                    onUpdateContract(newContracts);
                }
            };

            // 現在年度のデータを確保
            if (!repContracts[currentFiscalYear]) {
                ensureYearData(currentFiscalYear);
            }

            // 契約数を更新
            const handleContractChange = (year, month, value) => {
                const newContracts = { ...contracts };
                if (!newContracts[repId]) newContracts[repId] = {};
                if (!newContracts[repId][year]) {
                    newContracts[repId][year] = {};
                }

                // 空文字の場合は削除、それ以外は数値として保存
                if (value === '' || value === null || value === undefined) {
                    delete newContracts[repId][year][month];
                } else {
                    const numValue = parseInt(value);
                    if (!isNaN(numValue) && numValue >= 0) {
                        newContracts[repId][year][month] = numValue;
                    }
                }
                onUpdateContract(newContracts);
            };

            // 合計と平均を計算（入力がある月のみ）
            const calculateStats = (yearData) => {
                if (!yearData) return { total: 0, average: '-', inputCount: 0 };

                // 入力がある月のみを取得
                const inputValues = monthKeys
                    .map(m => yearData[m])
                    .filter(val => val !== undefined && val !== null);

                if (inputValues.length === 0) {
                    return { total: 0, average: '-', inputCount: 0 };
                }

                const total = inputValues.reduce((sum, val) => sum + val, 0);
                const average = (total / inputValues.length).toFixed(1);
                return { total, average, inputCount: inputValues.length };
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <LucideIcon name="trending-up" className="text-blue-600" size={20} />
                            月次契約棟数管理（8月起算）
                        </h3>
                        <div className="flex gap-2 items-center">
                            {isEditMode && (
                                <div className="flex gap-2 items-center">
                                    <select
                                        value={selectedYear || ''}
                                        onChange={(e) => setSelectedYear(Number(e.target.value))}
                                        className="px-3 py-1 text-sm border border-gray-300 rounded-md"
                                    >
                                        <option value="">過去年度を追加...</option>
                                        {yearOptions.filter(y => y !== currentFiscalYear && !repContracts[y]).map(year => (
                                            <option key={year} value={year}>{year}年度</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={handleAddYear}
                                        disabled={!selectedYear}
                                        className="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        追加
                                    </button>
                                </div>
                            )}
                            {availableYears.length > 1 && (
                                <button
                                    onClick={() => setShowPastYears(!showPastYears)}
                                    className="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md transition-colors flex items-center gap-1"
                                >
                                    <LucideIcon name={showPastYears ? 'eye-off' : 'eye'} size={14} />
                                    {showPastYears ? '最新年度のみ' : '過去年度も表示'}
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="space-y-6">
                        {yearsToShow.map(year => {
                            const yearData = repContracts[year] || {};
                            const stats = calculateStats(yearData);
                            const isCurrent = year === currentFiscalYear;

                            return (
                                <div key={year} className={`border rounded-lg p-4 ${isCurrent ? 'border-blue-400 bg-blue-50' : 'border-gray-300'}`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-bold text-gray-700">
                                            {year}年度 ({year}年8月 〜 {year + 1}年7月)
                                            {isCurrent && <span className="ml-2 text-xs bg-blue-600 text-white px-2 py-1 rounded">最新</span>}
                                        </h4>
                                        <div className="flex gap-4 text-sm">
                                            <span className="font-semibold">合計: <span className="text-blue-600 text-lg">{stats.total}</span>棟</span>
                                            <span className="font-semibold">平均: <span className="text-green-600 text-lg">{stats.average}</span>棟/月</span>
                                            {stats.inputCount > 0 && <span className="text-xs text-gray-500">({stats.inputCount}ヶ月分)</span>}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-6 gap-3">
                                        {monthKeys.map((month, idx) => {
                                            const value = yearData[month];
                                            const hasValue = value !== undefined && value !== null;

                                            return (
                                                <div key={month} className="flex flex-col">
                                                    <label className="text-xs font-medium text-gray-600 mb-1">{monthLabels[idx]}</label>
                                                    {isEditMode ? (
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            value={hasValue ? value : ''}
                                                            onChange={(e) => handleContractChange(year, month, e.target.value)}
                                                            placeholder="-"
                                                            className="w-full px-2 py-1 border border-blue-300 rounded text-center focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        />
                                                    ) : (
                                                        <div className={`w-full px-2 py-1 rounded text-center font-medium ${hasValue ? 'bg-gray-100 border border-gray-200' : 'bg-white border border-gray-200 text-gray-400'}`}>
                                                            {hasValue ? value : '-'}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TrainingItemCard = ({ item, repId, progress, onStatusUpdate, onAddComment, onDeleteComment, isEditMode, onUpdateItem, onDeleteItem }) => {
            const [newComment, setNewComment] = useState('');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedVideo, setSelectedVideo] = useState(null);
            const [videoPreview, setVideoPreview] = useState(null);
            const [isDescOpen, setIsDescOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [editingCommentId, setEditingCommentId] = useState(null);
            const [editingText, setEditingText] = useState('');
            const [editingDate, setEditingDate] = useState('');
            const [editingVideo, setEditingVideo] = useState(null);
            const [editingVideoPreview, setEditingVideoPreview] = useState(null);

            // 安全装置: progress が undefined の場合を考慮、古いステータス値も正規化
            const rawProgress = progress || { status: '未着手', comments: [] };
            const validStatus = STATUS_OPTIONS.includes(rawProgress.status) ? rawProgress.status : '未着手';
            const currentProgress = { ...rawProgress, status: validStatus };
            const itemPercentage = (STATUS_VALUE[currentProgress.status] || 0) * 100;
            const sortedComments = useMemo(() => (currentProgress.comments || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)), [currentProgress.comments]);

            const handleVideoSelect = async (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('video/')) {
                    if (file.size > 500 * 1024 * 1024) { // 500MB制限
                        alert('動画ファイルは500MB以下にしてください');
                        return;
                    }
                    const videoId = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    try {
                        await saveVideoToDB(videoId, file);
                        const videoURL = URL.createObjectURL(file);
                        setSelectedVideo(videoId);
                        setVideoPreview(videoURL);
                    } catch (error) {
                        console.error('動画保存エラー:', error);
                        alert('動画の保存に失敗しました');
                    }
                } else {
                    alert('動画ファイルを選択してください');
                }
            };

            const handleRemoveVideo = async () => {
                if (selectedVideo) {
                    try {
                        await deleteVideoFromDB(selectedVideo);
                    } catch (error) {
                        console.error('動画削除エラー:', error);
                    }
                }
                if (videoPreview) {
                    URL.revokeObjectURL(videoPreview);
                }
                setSelectedVideo(null);
                setVideoPreview(null);
            };

            const handleAddCommentClick = () => {
                if (newComment.trim() && selectedDate) {
                    onAddComment(repId, item.id, newComment.trim(), selectedDate, selectedVideo);
                    setNewComment('');
                    setSelectedVideo(null);
                    setVideoPreview(null);
                    setIsHistoryOpen(true);
                }
            };

            const handleEditClick = (comment) => {
                setEditingCommentId(comment.id);
                setEditingText(comment.text);
                setEditingDate(comment.date);
                setEditingVideo(comment.video || null);
                setEditingVideoPreview(null);
            };

            const handleCancelEdit = async () => {
                if (editingVideoPreview) {
                    URL.revokeObjectURL(editingVideoPreview);
                }
                setEditingCommentId(null);
                setEditingText('');
                setEditingDate('');
                setEditingVideo(null);
                setEditingVideoPreview(null);
            };

            const handleEditVideoSelect = async (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('video/')) {
                    if (file.size > 500 * 1024 * 1024) {
                        alert('動画ファイルは500MB以下にしてください');
                        return;
                    }
                    const videoId = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    try {
                        await saveVideoToDB(videoId, file);
                        const videoURL = URL.createObjectURL(file);
                        setEditingVideo(videoId);
                        setEditingVideoPreview(videoURL);
                    } catch (error) {
                        console.error('動画保存エラー:', error);
                        alert('動画の保存に失敗しました');
                    }
                }
            };

            const handleRemoveEditVideo = async () => {
                if (editingVideo) {
                    try {
                        await deleteVideoFromDB(editingVideo);
                    } catch (error) {
                        console.error('動画削除エラー:', error);
                    }
                }
                if (editingVideoPreview) {
                    URL.revokeObjectURL(editingVideoPreview);
                }
                setEditingVideo(null);
                setEditingVideoPreview(null);
            };

            const handleSaveEdit = (commentId) => {
                if (editingText.trim() && editingDate) {
                    onUpdateComment(repId, item.id, commentId, {
                        text: editingText.trim(),
                        date: editingDate,
                        video: editingVideo
                    });
                    handleCancelEdit();
                }
            };

            return (
                <div className={`p-4 border-2 rounded-lg hover:shadow-lg transition-all flex flex-col bg-white relative group ${isEditMode ? 'border-blue-300 bg-blue-50' : 'border-gray-200'}`}>
                    {isEditMode && (
                        <div className="absolute -top-3 -right-3 flex gap-1 z-10">
                            <div className="bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-bold shadow-md flex items-center gap-1">
                                <LucideIcon name="edit-3" size={12}/> 編集中
                            </div>
                            <button onClick={() => onDeleteItem(item.id, item.name)} className="bg-red-500 text-white hover:bg-red-600 p-1.5 rounded-full transition-colors shadow-md" title="この項目を削除">
                                <LucideIcon name="trash-2" size={14}/>
                            </button>
                        </div>
                    )}
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                            {isEditMode ? (
                                <div className="space-y-2 bg-white p-3 rounded-lg border border-blue-200">
                                    <div>
                                        <label className="text-xs font-bold text-blue-600 mb-1 block">項目名</label>
                                        <input
                                            type="text"
                                            value={item.name}
                                            onChange={(e) => onUpdateItem(item.id, { ...item, name: e.target.value })}
                                            className="font-semibold text-gray-700 w-full border-2 border-blue-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                                            placeholder="研修項目名を入力"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-blue-600 mb-1 block">カテゴリ</label>
                                        <select
                                            value={item.category}
                                            onChange={(e) => onUpdateItem(item.id, { ...item, category: e.target.value })}
                                            className="text-sm text-gray-700 border-2 border-blue-300 rounded px-2 py-1 w-full focus:border-blue-500 focus:outline-none"
                                        >
                                            <option value="A研修 (デビュー)">A研修 (デビュー)</option>
                                            <option value="B研修 (1.5棟/月)">B研修 (1.5棟/月)</option>
                                            <option value="C研修 (独り立ち)">C研修 (独り立ち)</option>
                                        </select>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <p className="font-semibold text-gray-700">{item.name}</p>
                                    <p className="text-sm text-gray-500">{item.category}</p>
                                </>
                            )}
                        </div>
                        {!isEditMode && (
                            <div className="ml-2 w-12 h-12 relative flex items-center justify-center">
                               <div className="absolute inset-0 rounded-full border-4 border-gray-100"></div>
                               <div className={`absolute inset-0 rounded-full border-4 border-blue-500 transition-all duration-500`} style={{ clipPath: `inset(${100 - itemPercentage}% 0 0 0)` }}></div>
                               <span className="text-xs font-bold text-gray-700 z-10">{Math.round(itemPercentage)}%</span>
                            </div>
                        )}
                    </div>

                    <div className={`mb-2 text-xs text-gray-600 p-2 rounded border ${isEditMode ? 'bg-white border-blue-200' : 'bg-gray-50 border-gray-100'}`}>
                        <div className="font-bold flex justify-between items-center cursor-pointer hover:text-blue-600 transition-colors" onClick={() => setIsDescOpen(!isDescOpen)}>
                            <span className="flex items-center gap-1"><LucideIcon name="book-open" size={16}/> 学習内容・ポイント</span>
                            <span>{isDescOpen ? <LucideIcon name="chevron-up" size={16}/> : <LucideIcon name="chevron-down" size={16}/>}</span>
                        </div>
                        {isDescOpen && (
                            isEditMode ? (
                                <div className="mt-2">
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">詳細説明</label>
                                    <textarea
                                        value={item.description || ''}
                                        onChange={(e) => onUpdateItem(item.id, { ...item, description: e.target.value })}
                                        className="w-full p-2 border-2 border-blue-300 rounded text-sm resize-none h-32 focus:border-blue-500 focus:outline-none"
                                        placeholder="学習内容・ポイントを入力..."
                                    />
                                </div>
                            ) : (
                                <div className="whitespace-pre-wrap mt-2 pt-2 border-t border-gray-200 animate-fade-in leading-relaxed">{item.description || "詳細内容は登録されていません。"}</div>
                            )
                        )}
                    </div>

                    <div className="mb-4 text-xs text-gray-600 bg-blue-50 p-2 rounded border border-blue-100">
                        <div className="font-bold flex justify-between items-center cursor-pointer hover:text-blue-600 transition-colors" onClick={() => setIsHistoryOpen(!isHistoryOpen)}>
                            <span className="flex items-center gap-1"><LucideIcon name="history" size={16}/> 活動履歴 ({sortedComments.length})</span>
                            <span>{isHistoryOpen ? <LucideIcon name="chevron-up" size={16}/> : <LucideIcon name="chevron-down" size={16}/>}</span>
                        </div>
                        {isHistoryOpen && (
                            <div className="mt-2 pt-2 border-t border-blue-200 animate-fade-in">
                                {sortedComments.length === 0 ? <p className="text-gray-400 text-center py-2">履歴はありません。</p> : (
                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                                        {sortedComments.map(c => (
                                            <div key={c.id} className="bg-white p-2 rounded border border-blue-100 shadow-sm relative group">
                                                {editingCommentId === c.id ? (
                                                    <div className="flex flex-col gap-2">
                                                        <label className="text-[10px] text-gray-500 font-bold">日付</label>
                                                        <input type="date" value={editingDate} onChange={(e) => setEditingDate(e.target.value)} className="w-full p-1.5 border rounded text-xs" />
                                                        <label className="text-[10px] text-gray-500 font-bold">内容</label>
                                                        <textarea value={editingText} onChange={(e) => setEditingText(e.target.value)} className="w-full p-1.5 border rounded text-xs resize-none h-16" />
                                                        <label className="text-[10px] text-gray-500 font-bold">動画</label>
                                                        {editingVideo && !editingVideoPreview && (
                                                            <div className="relative">
                                                                <VideoPlayer videoId={editingVideo} className="w-full max-h-32 rounded border" />
                                                                <button onClick={handleRemoveEditVideo} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors" title="動画を削除">
                                                                    <LucideIcon name="x" size={14} />
                                                                </button>
                                                            </div>
                                                        )}
                                                        {editingVideoPreview && (
                                                            <div className="relative">
                                                                <video src={editingVideoPreview} controls className="w-full max-h-32 rounded border" />
                                                                <button onClick={handleRemoveEditVideo} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors" title="動画を削除">
                                                                    <LucideIcon name="x" size={14} />
                                                                </button>
                                                            </div>
                                                        )}
                                                        {!editingVideo && (
                                                            <input type="file" accept="video/*" onChange={handleEditVideoSelect} className="w-full p-1.5 border rounded text-xs file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                                        )}
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleSaveEdit(c.id)} className="flex-1 bg-green-600 text-white py-1.5 rounded text-xs font-bold hover:bg-green-700 transition-colors" disabled={!editingText.trim() || !editingDate}>保存</button>
                                                            <button onClick={handleCancelEdit} className="flex-1 bg-gray-400 text-white py-1.5 rounded text-xs font-bold hover:bg-gray-500 transition-colors">キャンセル</button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="font-bold text-blue-800">{c.date}</span>
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleEditClick(c)} className="text-gray-400 hover:text-blue-500" title="編集"><LucideIcon name="edit" size={14}/></button>
                                                                <button onClick={() => onDeleteComment(repId, item.id, c.id)} className="text-gray-400 hover:text-red-500" title="削除"><LucideIcon name="trash-2" size={14}/></button>
                                                            </div>
                                                        </div>
                                                        <p className="text-gray-700 whitespace-pre-wrap">{c.text}</p>
                                                        {c.video && (
                                                            <div className="mt-2">
                                                                <VideoPlayer videoId={c.video} className="w-full max-h-48 rounded border border-gray-200" />
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="mt-3 pt-2 border-t border-blue-200 flex flex-col gap-2">
                                    <label className="text-[10px] text-gray-500 font-bold">新規履歴追加</label>
                                    <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full p-1.5 border rounded text-xs" />
                                    <textarea placeholder="活動内容・フィードバック..." value={newComment} onChange={(e) => setNewComment(e.target.value)} className="w-full p-1.5 border rounded text-xs resize-none h-16" ></textarea>
                                    <div className="flex flex-col gap-2">
                                        <label className="text-[10px] text-gray-500 font-bold">動画アップロード (任意)</label>
                                        <input type="file" accept="video/*" onChange={handleVideoSelect} className="w-full p-1.5 border rounded text-xs file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                        {videoPreview && (
                                            <div className="relative">
                                                <video src={videoPreview} controls className="w-full max-h-32 rounded border" />
                                                <button onClick={handleRemoveVideo} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors" title="動画を削除">
                                                    <LucideIcon name="x" size={14} />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={handleAddCommentClick} className="w-full bg-blue-600 text-white py-1.5 rounded text-xs font-bold hover:bg-blue-700 transition-colors disabled:opacity-50" disabled={!newComment.trim() || !selectedDate}>記録を追加</button>
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="mt-auto space-y-3">
                        <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div className={`${STATUS_COLOR[currentProgress.status].bg} h-2.5 rounded-full`} style={{ width: `${itemPercentage}%` }}></div>
                        </div>
                        <select value={currentProgress.status} onChange={(e) => onStatusUpdate(repId, item.id, 'status', e.target.value)} className={`w-full p-2 border rounded-md ${STATUS_COLOR[currentProgress.status].text}`}>
                            {STATUS_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    </div>
                </div>
            );
        };

        const SalesApp = () => {
             // Version 19: Add CRUD for reps and training items
             const [salesReps, setSalesReps] = usePersistentState('ghouse_sales_reps_v19', salesInitialData.salesReps);
             const [trainingItems, setTrainingItems] = usePersistentState('ghouse_training_items_v19', salesInitialData.trainingItems);
             const [progress, setProgress] = usePersistentState('ghouse_sales_progress_v19', salesInitialData.progress);
             const [contracts, setContracts] = usePersistentState('ghouse_contracts_v1', salesInitialData.contracts);
             const [activeRepId, setActiveRepId] = useState(null);
             const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });
             const [isApiKeyModalOpen, setIsApiKeyModalOpen] = useState(false);
             const [isAIModalOpen, setIsAIModalOpen] = useState(false);
             const [apiKey, setApiKey] = useState(localStorage.getItem('ghouse_api_key') || '');
             const [toast, setToast] = useState({ message: '', type: 'success' });
             const [isEditMode, setIsEditMode] = useState(false);
             const [isRepManagementOpen, setIsRepManagementOpen] = useState(false);

             // activeRepIdが有効なIDであることを確認
             useEffect(() => {
                 if (salesReps.length > 0 && (!activeRepId || !salesReps.find(r => r.id === activeRepId))) {
                     setActiveRepId(salesReps[0].id);
                 }
             }, [salesReps]);

             const showToast = (message, type) => setToast({ message, type });
             const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
             const closeModal = () => setModalState({ ...modalState, isOpen: false });
             const activeRep = salesReps.find(r => r.id === activeRepId);

             // 営業担当者の管理
             const handleAddRep = () => {
                 const newId = 'rep' + (Math.max(...salesReps.map(r => parseInt(r.id.replace('rep', ''))), 0) + 1);
                 const newRep = { id: newId, name: '新規担当者' };
                 setSalesReps([...salesReps, newRep]);
                 setActiveRepId(newId);
                 showToast('担当者を追加しました', 'success');
             };

             const handleUpdateRep = (repId, newName) => {
                 setSalesReps(salesReps.map(r => r.id === repId ? { ...r, name: newName } : r));
             };

             const handleDeleteRep = (repId, name) => {
                 showModal('担当者削除', `「${name}」を削除してもよろしいですか？\n進捗データも削除されます。`, () => {
                     const newReps = salesReps.filter(r => r.id !== repId);
                     setSalesReps(newReps);
                     const newProgress = { ...progress };
                     delete newProgress[repId];
                     setProgress(newProgress);
                     if (activeRepId === repId) setActiveRepId(newReps[0]?.id || null);
                     closeModal();
                     showToast('担当者を削除しました', 'success');
                 });
             };

             // 研修項目の管理
             const handleAddTrainingItem = (category) => {
                 const newId = 'item' + Date.now();
                 const newItem = { id: newId, name: '新規研修項目', category: category, description: '' };
                 setTrainingItems([...trainingItems, newItem]);
                 showToast('研修項目を追加しました', 'success');
             };

             const handleUpdateTrainingItem = (itemId, updatedItem) => {
                 setTrainingItems(trainingItems.map(item => item.id === itemId ? updatedItem : item));
             };

             const handleDeleteTrainingItem = (itemId, name) => {
                 showModal('研修項目削除', `「${name}」を削除してもよろしいですか？\n全担当者の進捗データも削除されます。`, () => {
                     setTrainingItems(trainingItems.filter(item => item.id !== itemId));
                     const newProgress = { ...progress };
                     Object.keys(newProgress).forEach(repId => {
                         if (newProgress[repId][itemId]) {
                             delete newProgress[repId][itemId];
                         }
                     });
                     setProgress(newProgress);
                     closeModal();
                     showToast('研修項目を削除しました', 'success');
                 });
             };

             const handleStatusUpdate = (repId, itemId, field, value) => {
                 setProgress(prev => ({ ...prev, [repId]: { ...prev[repId], [itemId]: { ...(prev[repId]?.[itemId] || { status: '未着手', comments: [] }), [field]: value } } }));
             };

             const handleAddComment = (repId, itemId, text, date, videoData = null) => {
                 const newComment = { id: Date.now(), date, text, video: videoData };
                 setProgress(prev => {
                     const p = prev[repId] || {};
                     const itemP = p[itemId] || { status: '未着手', comments: [] };
                     return { ...prev, [repId]: { ...p, [itemId]: { ...itemP, comments: [...(itemP.comments||[]), newComment] } } };
                 });
                 showToast("コメントを追加しました", "success");
             };

             const handleUpdateComment = async (repId, itemId, commentId, updatedData) => {
                 const oldComment = progress[repId]?.[itemId]?.comments?.find(c => c.id === commentId);

                 // 古い動画があり、新しい動画IDと異なる場合は削除
                 if (oldComment?.video && oldComment.video !== updatedData.video) {
                     try {
                         await deleteVideoFromDB(oldComment.video);
                     } catch (error) {
                         console.error('古い動画削除エラー:', error);
                     }
                 }

                 setProgress(prev => {
                     const p = JSON.parse(JSON.stringify(prev));
                     if(p[repId] && p[repId][itemId]) {
                         p[repId][itemId].comments = p[repId][itemId].comments.map(c =>
                             c.id === commentId
                                 ? { ...c, text: updatedData.text, date: updatedData.date, video: updatedData.video }
                                 : c
                         );
                     }
                     return p;
                 });
                 showToast("履歴を更新しました", "success");
             };

             const handleDeleteComment = async (repId, itemId, commentId) => {
                 showModal("コメント削除", "本当に削除しますか？", async () => {
                     // 削除するコメントを取得
                     const comment = progress[repId]?.[itemId]?.comments?.find(c => c.id === commentId);

                     // 動画が含まれていればIndexedDBから削除
                     if (comment?.video) {
                         try {
                             await deleteVideoFromDB(comment.video);
                         } catch (error) {
                             console.error('動画削除エラー:', error);
                         }
                     }

                     setProgress(prev => {
                         const p = JSON.parse(JSON.stringify(prev));
                         if(p[repId] && p[repId][itemId]) {
                            p[repId][itemId].comments = p[repId][itemId].comments.filter(c => c.id !== commentId);
                         }
                         return p;
                     });
                     closeModal();
                     showToast("コメントを削除しました", "success");
                 });
             };

             const calculateProgress = (repId) => {
                 if (!trainingItems || trainingItems.length === 0) return 0;
                 const p = progress[repId] || {};
                 // ここでデータが存在しない場合のガードを入れる
                 const total = trainingItems.reduce((acc, item) => {
                     const status = p[item.id]?.status || '未着手';
                     return acc + (STATUS_VALUE[status] || 0);
                 }, 0);
                 return (total / trainingItems.length) * 100;
             };

             const CircularProgress = ({ percentage }) => {
                 const radius = 40; const stroke = 8; const normalizedRadius = radius - stroke * 2; const circumference = normalizedRadius * 2 * Math.PI; const strokeDashoffset = circumference - (percentage / 100) * circumference;
                 return ( <div className="relative flex items-center justify-center w-32 h-32"> <svg height={radius * 2} width={radius * 2} className="transform -rotate-90"> <circle stroke="#e5e7eb" strokeWidth={stroke} fill="transparent" r={normalizedRadius} cx={radius} cy={radius} /> <circle stroke="#2563eb" strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset }} strokeLinecap="round" fill="transparent" r={normalizedRadius} cx={radius} cy={radius} className="transition-all duration-500 ease-in-out" /> </svg> <div className="absolute text-2xl font-bold text-gray-700">{Math.round(percentage)}%</div> </div> );
             };

             const CategoryProgressBar = ({ category, percentage }) => (
                 <div className="flex items-center w-full text-xs mb-2"> <span className="text-gray-600 w-24 truncate pr-2 text-right">{category}</span> <div className="flex-grow bg-gray-200 rounded-full h-2"> <div className="bg-blue-500 h-2 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }}></div> </div> <span className="font-semibold text-gray-700 w-10 text-left pl-2">{Math.round(percentage)}%</span> </div>
             );

             const itemsByCategory = useMemo(() => {
                 if (!trainingItems) return {};
                 return trainingItems.reduce((acc, item) => {
                     (acc[item.category] = acc[item.category] || []).push(item);
                     return acc;
                 }, {});
             }, [trainingItems]);

             const categoryOrder = ['A研修 (デビュー)', 'B研修 (1.5棟/月)', 'C研修 (独り立ち)'];

             const categoryProgresses = useMemo(() => {
                 return categoryOrder.map(category => {
                     const items = itemsByCategory[category] || [];
                     if (items.length === 0) return { category, percentage: 0 };
                     const total = items.reduce((acc, item) => {
                         const status = (progress[activeRepId] || {})[item.id]?.status || '未着手';
                         return acc + (STATUS_VALUE[status] || 0);
                     }, 0);
                     return { category, percentage: (total / items.length) * 100 };
                 });
             }, [itemsByCategory, progress, activeRepId]);


             return (
                 <div className="bg-gray-100 h-full overflow-y-auto font-sans">
                     <Toast {...toast} onDismiss={() => setToast({ ...toast, message: '' })} />
                     <ConfirmModal {...modalState} onCancel={closeModal} />
                     <ApiKeyModal isOpen={isApiKeyModalOpen} onClose={() => setIsApiKeyModalOpen(false)} onSave={(key) => { localStorage.setItem('ghouse_api_key', key); setApiKey(key); setIsApiKeyModalOpen(false); }} />
                     <AIConsultModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} apiKey={apiKey} />
                     <RepresentativeManagementModal
                        isOpen={isRepManagementOpen}
                        onClose={() => setIsRepManagementOpen(false)}
                        salesReps={salesReps}
                        onAddRep={handleAddRep}
                        onUpdateRep={handleUpdateRep}
                        onDeleteRep={handleDeleteRep}
                     />

                     <div className="container mx-auto px-4 py-8">
                        <header className={`flex justify-between items-center mb-8 p-4 rounded-lg transition-all ${isEditMode ? 'bg-blue-50 border-2 border-blue-300' : ''}`}>
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">営業育成管理ダッシュボード</h1>
                                {isEditMode && <p className="text-sm text-blue-600 font-semibold mt-1"><LucideIcon name="edit-3" size={14} className="inline mr-1"/> 編集モード中 - 担当者名や研修項目をクリックして編集できます</p>}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsRepManagementOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-bold shadow-sm text-sm">
                                    <LucideIcon name="users" size={18} /> 担当者管理
                                </button>
                                <button onClick={() => setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded-md font-bold shadow-sm text-sm transition-all ${isEditMode ? 'bg-green-600 text-white hover:bg-green-700 animate-pulse' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                    <LucideIcon name={isEditMode ? 'check' : 'edit'} size={18} className="inline mr-1" /> {isEditMode ? '編集を完了' : '編集モード'}
                                </button>
                                <button onClick={() => apiKey ? setIsAIModalOpen(true) : setIsApiKeyModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-bold shadow-sm text-sm"><LucideIcon name="brain" size={18} /> AI相談</button>
                                <button onClick={() => setIsApiKeyModalOpen(true)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-md"><LucideIcon name="settings" size={20} /></button>
                            </div>
                        </header>
                         <EducationScheduleHeader />
                         <div className="mb-6 border-b border-gray-200 bg-white sticky top-0 z-10 overflow-x-auto whitespace-nowrap p-2 flex items-center gap-2">
                             {salesReps.map(rep => (
                                 <button key={rep.id} onClick={() => setActiveRepId(rep.id)} className={`px-4 py-3 border-b-2 font-medium text-sm transition-colors ${activeRepId === rep.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                     {rep.name}
                                 </button>
                             ))}
                         </div>
                         {activeRep && (
                             <div className="animate-fade-in">
                                 <ErrorBoundary>
                                     {/* Dashboard Top Section */}
                                     <div className="bg-white p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row gap-8">
                                         <div className="flex flex-col items-center justify-center p-4 min-w-[200px]">
                                             <h3 className="text-lg font-bold text-gray-700 mb-4">総合達成度</h3>
                                             <CircularProgress percentage={calculateProgress(activeRep.id)} />
                                         </div>
                                         <div className="flex-1 border-l border-gray-100 pl-8">
                                             <h3 className="text-lg font-bold text-gray-700 mb-4">カテゴリ別進捗</h3>
                                             <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2">
                                                 {categoryProgresses.map(cp => (
                                                     <CategoryProgressBar key={cp.category} category={cp.category} percentage={cp.percentage} />
                                                 ))}
                                             </div>
                                         </div>
                                     </div>

                                     {/* Monthly Contracts Section */}
                                     <MonthlyContractsCard
                                        repId={activeRep.id}
                                        contracts={contracts}
                                        onUpdateContract={setContracts}
                                        isEditMode={isEditMode}
                                     />

                                     {/* Training Items List by Category */}
                                     <div className="space-y-8">
                                         {categoryOrder.map(category => {
                                             const items = itemsByCategory[category] || [];
                                             return (
                                                 <div key={category}>
                                                     <div className="flex items-center justify-between mb-4">
                                                         <h3 className="text-xl font-bold text-gray-800 border-l-4 border-blue-500 pl-3">{category}</h3>
                                                         {isEditMode && (
                                                             <button onClick={() => handleAddTrainingItem(category)} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-bold flex items-center gap-1">
                                                                 <LucideIcon name="plus" size={16} /> 研修項目追加
                                                             </button>
                                                         )}
                                                     </div>
                                                     {items.length > 0 ? (
                                                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                             {items.map(item => (
                                                                 <TrainingItemCard
                                                                     key={item.id}
                                                                     item={item}
                                                                     repId={activeRep.id}
                                                                     progress={(progress[activeRep.id] || {})[item.id]}
                                                                     onStatusUpdate={handleStatusUpdate}
                                                                     onAddComment={handleAddComment}
                                                                     onDeleteComment={handleDeleteComment}
                                                                    onUpdateComment={handleUpdateComment}
                                                                     isEditMode={isEditMode}
                                                                     onUpdateItem={handleUpdateTrainingItem}
                                                                     onDeleteItem={handleDeleteTrainingItem}
                                                                 />
                                                             ))}
                                                         </div>
                                                     ) : (
                                                         <div className="text-center text-gray-400 py-8 border-2 border-dashed border-gray-200 rounded-lg">
                                                             このカテゴリには研修項目がありません
                                                         </div>
                                                     )}
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 </ErrorBoundary>
                             </div>
                         )}
                     </div>
                 </div>
             );
        };

        // ==========================================
        //  6. Debut Training App Components
        // ==========================================
        const DebutTrainingApp = () => {
             const [trainingData, setTrainingData] = usePersistentState('ghouse_debut_training_v19', initialDebutTrainingData);
             const [toast, setToast] = useState({ message: '', type: 'success' });
             const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });
             const [isEditMode, setIsEditMode] = useState(false);

             const showToast = (message, type) => setToast({ message, type });
             const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
             const closeModal = () => setModalState({ ...modalState, isOpen: false });

             const handleUploadPdf = async (category, itemId, file) => {
                 try {
                     const uploadedFile = await mockApi.uploadFile(file);
                     setTrainingData(prev => {
                         const newData = {...prev};
                         newData[category] = newData[category].map(item => {
                             if(item.id === itemId) {
                                 return {...item, pdfs: [...item.pdfs, uploadedFile]};
                             }
                             return item;
                         });
                         return newData;
                     });
                     showToast('PDFを追加しました', 'success');
                 } catch (e) {
                     showToast('アップロードに失敗しました', 'error');
                 }
             };

             const handleDeletePdf = (category, itemId, pdfIndex) => {
                 showModal('PDF削除', 'このPDFを削除してもよろしいですか？', () => {
                     setTrainingData(prev => {
                         const newData = {...prev};
                         newData[category] = newData[category].map(item => {
                             if(item.id === itemId) {
                                 const newPdfs = [...item.pdfs];
                                 newPdfs.splice(pdfIndex, 1);
                                 return {...item, pdfs: newPdfs};
                             }
                             return item;
                         });
                         return newData;
                     });
                     showToast('PDFを削除しました', 'success');
                     closeModal();
                 });
             };

             const handleAddUrl = (category, itemId, url) => {
                 if (!url) return;
                 setTrainingData(prev => {
                     const newData = {...prev};
                     newData[category] = newData[category].map(item => {
                         if (item.id === itemId) {
                             return { ...item, urls: [...(item.urls || []), url] };
                         }
                         return item;
                     });
                     return newData;
                 });
                 showToast('URLを追加しました', 'success');
             };

             const handleDeleteUrl = (category, itemId, urlIndex) => {
                 showModal('URL削除', 'このURLを削除してもよろしいですか？', () => {
                    setTrainingData(prev => {
                        const newData = {...prev};
                        newData[category] = newData[category].map(item => {
                            if (item.id === itemId) {
                                const newUrls = [...(item.urls || [])];
                                newUrls.splice(urlIndex, 1);
                                return { ...item, urls: newUrls };
                            }
                            return item;
                        });
                        return newData;
                    });
                    showToast('URLを削除しました', 'success');
                    closeModal();
                 });
             };


             const handleUpdateTitle = (category, itemId, newTitle) => {
                 setTrainingData(prev => {
                     const newData = {...prev};
                     newData[category] = newData[category].map(item =>
                         item.id === itemId ? {...item, title: newTitle} : item
                     );
                     return newData;
                 });
             };

             const handleAddItem = (category) => {
                 const newId = `new_${Date.now()}`;
                 setTrainingData(prev => ({
                     ...prev,
                     [category]: [...prev[category], { id: newId, title: '新規項目', pdfs: [], urls: [] }]
                 }));
             };

             const handleDeleteItem = (category, itemId) => {
                 showModal('項目削除', 'この項目を削除してもよろしいですか？', () => {
                     setTrainingData(prev => ({
                         ...prev,
                         [category]: prev[category].filter(item => item.id !== itemId)
                     }));
                     closeModal();
                 });
             };

             const handleOpenPdf = async (doc) => {
                try {
                    if (doc.url && doc.url.startsWith('data:')) {
                        const blobUrl = dataUrlToBlobUrl(doc.url);
                        const win = window.open(blobUrl, '_blank');
                        if (win) {
                            win.addEventListener('beforeunload', () => URL.revokeObjectURL(blobUrl));
                            return;
                        }
                    }
                    alert('PDFを開きます: ' + doc.name);
                } catch (e) {
                    alert('ファイルを開けませんでした');
                }
             };

             // Items reordering logic
             const handleDragStart = (e, category, index) => {
                 e.dataTransfer.setData("category", category);
                 e.dataTransfer.setData("index", index);
             };

             const handleDragOver = (e) => {
                 e.preventDefault();
             };

             const handleDrop = (e, targetCategory, targetIndex) => {
                 const sourceCategory = e.dataTransfer.getData("category");
                 const sourceIndex = parseInt(e.dataTransfer.getData("index"), 10);

                 if (sourceCategory === targetCategory && sourceIndex !== targetIndex) {
                     setTrainingData(prev => {
                         const newItems = [...prev[sourceCategory]];
                         const [reorderedItem] = newItems.splice(sourceIndex, 1);
                         newItems.splice(targetIndex, 0, reorderedItem);
                         return { ...prev, [sourceCategory]: newItems };
                     });
                 }
             };

             return (
                 <div className="bg-gray-100 h-full font-sans p-8 overflow-y-auto">
                     <Toast {...toast} onDismiss={() => setToast({ ...toast, message: '' })} />
                     <ConfirmModal {...modalState} onCancel={closeModal} />
                     <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                <LucideIcon name="graduation-cap" className="text-indigo-600" size={32}/> デビュー研修一覧
                            </h1>
                            <button
                                onClick={() => setIsEditMode(!isEditMode)}
                                className={`px-4 py-2 rounded text-sm font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                            >
                                {isEditMode ? '完了' : '編集'}
                            </button>
                        </div>

                         <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                             {['A研修 (デビュー)', 'B研修 (1.5棟/月)', 'C研修 (独り立ち)'].map(category => (
                                 <div key={category} className="bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-full">
                                     <div className={`p-4 font-bold text-white text-center text-lg ${category === 'A研修 (デビュー)' ? 'bg-blue-600' : category === 'B研修 (1.5棟/月)' ? 'bg-indigo-600' : 'bg-purple-600'}`}>
                                         {category}
                                     </div>
                                     <div className="p-4 flex-1 overflow-y-auto">
                                         <div className="space-y-4">
                                             {trainingData[category].map((item, index) => (
                                                 <div
                                                    key={item.id}
                                                    className={`border rounded-lg p-3 bg-gray-50 hover:shadow-sm transition-shadow ${isEditMode ? "cursor-move" : ""}`}
                                                    draggable={isEditMode}
                                                    onDragStart={(e) => handleDragStart(e, category, index)}
                                                    onDragOver={handleDragOver}
                                                    onDrop={(e) => handleDrop(e, category, index)}
                                                 >
                                                     <div className="flex justify-between items-start mb-2">
                                                         <div className="flex items-center flex-1 mr-2">
                                                            {isEditMode && <LucideIcon name="grip-vertical" className="mr-2 text-gray-400 flex-shrink-0" size={16}/>}
                                                             <input
                                                                 type="text"
                                                                 value={item.title}
                                                                 onChange={(e) => handleUpdateTitle(category, item.id, e.target.value)}
                                                                 className={`font-bold text-gray-700 bg-transparent ${isEditMode ? "" : "pointer-events-none"} border-b ${isEditMode ? "border-transparent hover:border-gray-300" : "border-transparent"} focus:border-blue-500 focus:outline-none w-full`}
                                                             />
                                                         </div>
                                                        {isEditMode && (
                                                            <button type="button" onClick={() => handleDeleteItem(category, item.id)} className="text-gray-400 hover:text-red-500"><LucideIcon name="trash-2" size={16}/></button>
                                                        )}
                                                     </div>

                                                     {/* PDF List */}
                                                     <div className="space-y-2 mb-3">
                                                         {item.pdfs.map((pdf, idx) => (
                                                             <div key={idx} className="flex items-center justify-between text-xs bg-white p-2 rounded border border-gray-200">
                                                                 <div onClick={() => handleOpenPdf(pdf)} className="flex items-center cursor-pointer hover:text-blue-600 truncate flex-1 mr-2">
                                                                     <LucideIcon name="file-text" size={14} className="mr-1 text-red-500 flex-shrink-0"/>
                                                                     <span className="truncate">{pdf.name}</span>
                                                                 </div>
                                                                {isEditMode && (
                                                                    <button type="button" onClick={() => handleDeletePdf(category, item.id, idx)} className="text-gray-400 hover:text-red-500">00d7</button>
                                                                )}
                                                             </div>
                                                         ))}
                                                     </div>
                                                    {isEditMode && (
                                                    
                                                                                                         {/* Upload Button */}
                                                                                                         <label className="flex items-center justify-center w-full p-2 border-2 border-dashed border-gray-300 rounded cursor-pointer hover:bg-gray-100 hover:border-blue-400 transition-colors text-xs text-gray-500 mb-3">
                                                                                                             <LucideIcon name="upload" size={14} className="mr-1"/> 資料を追加
                                                                                                             <input type="file" accept=".pdf" className="hidden" onChange={(e) => e.target.files[0] && handleUploadPdf(category, item.id, e.target.files[0])} />
                                                                                                         </label>
                                                    )}

                                                     {/* URL List */}
                                                     <div className="space-y-2 mb-3">
                                                        {(item.urls || []).map((url, idx) => (
                                                            <div key={idx} className="flex items-center justify-between text-xs bg-white p-2 rounded border border-gray-200">
                                                                <a href={url} target="_blank" rel="noopener noreferrer" className="flex items-center cursor-pointer hover:text-blue-600 truncate flex-1 mr-2 text-blue-500">
                                                                    <LucideIcon name="link" size={14} className="mr-1 flex-shrink-0"/>
                                                                    <span className="truncate">{url}</span>
                                                                </a>
                                                                {isEditMode && (
                                                                    <button onClick={() => handleDeleteUrl(category, item.id, idx)} className="text-gray-400 hover:text-red-500">00d7</button>
                                                                )}
                                                            </div>
                                                        ))}
                                                     </div>

                                                     {/* Add URL Input */}
                                                    {isEditMode && (
                                                     <div className="flex items-center gap-1">
                                                        <input
                                                            type="text"
                                                            placeholder="https://..."
                                                            className="flex-1 p-1.5 border rounded text-xs"
                                                            id={`url-input-${item.id}`}
                                                            onKeyDown={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    handleAddUrl(category, item.id, e.target.value);
                                                                    e.target.value = '';
                                                                }
                                                            }}
                                                        />
                                                        <button
                                                            onClick={() => {
                                                                const input = document.getElementById(`url-input-${item.id}`);
                                                                handleAddUrl(category, item.id, input.value);
                                                                input.value = '';
                                                            }}
                                                            className="bg-gray-100 border border-gray-300 text-gray-600 p-1.5 rounded hover:bg-gray-200"
                                                        >
                                                            <LucideIcon name="plus" size={14} />
                                                        </button>
                                                     </div>
                                                    )}
                                                 </div>
                                             ))}
                                         </div>
                                     </div>
                                     <div className="p-4 border-t bg-gray-50">
                                        {isEditMode && (
                                                                                 <button type="button" onClick={() => handleAddItem(category)} className="w-full py-2 bg-white border border-gray-300 rounded text-gray-600 hover:bg-gray-100 text-sm font-bold flex items-center justify-center">
                                                                                     <LucideIcon name="plus" size={16} className="mr-1"/> 項目追加
                                                                                 </button>
                                        )}
                                     </div>
                                 </div>
                             ))}
                         </div>
                     </div>
                 </div>
             );
        };

        // ==========================================
        //  6. Root App & Unified App
        // ==========================================

        const HomePage = ({ onNavigate }) => (
            <div className="h-full overflow-y-auto bg-gradient-to-br from-slate-50 to-blue-50 p-8 flex items-center justify-center">
              <div className="max-w-5xl w-full">
                <h1 className="text-4xl font-bold text-center text-slate-800 mb-12">G-house | 営業サイト</h1>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {[
                        { id: 'sales', title: '営業育成管理', icon: <LucideIcon name="users" className="text-blue-600" size={32}/>, desc: 'スタッフのスキル習得状況、AIロープレ支援' },
                        { id: 'flow', title: '営業作業フロー', icon: <LucideIcon name="file-text" className="text-green-600" size={32}/>, desc: '契約までの標準工程とマニュアル管理' },
                        { id: 'bank', title: '各種銀行', icon: <LucideIcon name="dollar-sign" className="text-yellow-600" size={32}/>, desc: '提携金融機関の金利・手数料・必要書類DB' },
                        { id: 'debut', title: 'デビュー研修一覧', icon: <LucideIcon name="graduation-cap" className="text-indigo-600" size={32}/>, desc: '新人営業マン向けの標準研修カリキュラム' },
                    ].map(card => (
                        <div key={card.id} onClick={() => onNavigate(card.id)} className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all cursor-pointer border-t-4 border-blue-500 transform hover:-translate-y-1 flex flex-col h-full">
                            <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mb-6">{card.icon}</div>
                            <h2 className="text-xl font-bold text-slate-800 mb-3">{card.title}</h2>
                            <p className="text-gray-500 mb-6 flex-grow text-sm">{card.desc}</p>
                            <div className="flex items-center text-blue-600 font-bold mt-auto">開く <LucideIcon name="chevron-down" className="ml-1 -rotate-90" size={16}/></div>
                        </div>
                    ))}
                </div>
              </div>
            </div>
        );

        const UnifiedApp = () => {
          const [currentView, setCurrentView] = useState('home');

          return (
            <div className="h-full flex flex-col">
              <nav className="bg-white shadow-md flex-shrink-0 z-20">
                <div className="container mx-auto px-4">
                  <div className="flex items-center h-16">
                    <div className="text-xl font-bold text-gray-800 mr-8">G-house | 営業サイト</div>
                    <div className="flex items-center space-x-2">
                       {['home', 'sales', 'flow', 'bank', 'debut'].map(view => (
                           <button key={view} onClick={() => setCurrentView(view)} className={`px-4 py-2 rounded-md font-medium transition-colors ${currentView === view ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}>
                             {view === 'home' ? 'ホーム' : view === 'sales' ? '営業育成' : view === 'flow' ? '営業フロー' : view === 'bank' ? '各種銀行' : 'デビュー研修'}
                           </button>
                       ))}
                    </div>
                  </div>
                </div>
              </nav>

              <div className="flex-1 overflow-auto bg-gray-100">
                <ErrorBoundary>
                    {currentView === 'home' && <HomePage onNavigate={setCurrentView} />}
                    {currentView === 'sales' && <SalesApp />}
                    {currentView === 'flow' && <FlowManagementApp />}
                    {currentView === 'bank' && <BankManagementApp />}
                    {currentView === 'debut' && <DebutTrainingApp />}
                </ErrorBoundary>
              </div>
            </div>
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<UnifiedApp />);
    </script>
</body>
</html>
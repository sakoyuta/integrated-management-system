<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-house | å–¶æ¥­ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        html, body, #root { height: 100%; margin: 0; }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body strong { color: #2563eb; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;

        // ==========================================
        //  0. Error Boundary & Hooks
        // ==========================================

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }

            handleReset = () => {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('ghouse_')) localStorage.removeItem(key);
                    });
                    window.location.reload();
                } catch (e) {
                    console.error("Reset failed", e);
                }
            };

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center h-full min-h-[300px] bg-red-50 p-6 rounded-lg border border-red-200 m-4">
                            <div className="text-center max-w-md">
                                <h2 className="text-lg font-bold text-red-700 mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                                <p className="text-sm text-gray-600 mb-4">ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆãŒèµ·ãã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                                <div className="bg-white p-2 rounded border border-red-100 text-left text-xs text-red-500 overflow-auto max-h-24 mb-4 font-mono">
                                    {this.state.error?.toString()}
                                </div>
                                <button onClick={this.handleReset} className="text-sm bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50 transition">
                                    ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å¾©æ—§
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // ==========================================
        //  Firebase Configuration & Initialization
        // ==========================================

        const firebaseConfig = {
            apiKey: "AIzaSyCxOFvB8h8ChcJJsEq7s7-hVCzbpfmkwA",
            authDomain: "ghouse-management.firebaseapp.com",
            databaseURL: "https://ghouse-management-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ghouse-management",
            storageBucket: "ghouse-management.firebasestorage.app",
            messagingSenderId: "790035889164",
            appId: "1:790035889164:web:e0fe2f032dd68acdb3c229",
            measurementId: "G-8EGTWS4HZM"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Firebase State Hook - Replaces usePersistentState with Firebase sync
        const useFirebaseState = (path, initialValue) => {
            const [state, setState] = useState(initialValue);
            const [isLoading, setIsLoading] = useState(true);
            const hasInitializedRef = useRef(false);

            useEffect(() => {
                const dbRef = database.ref(path);

                // Safety timeout - force loading to complete after 5 seconds
                const safetyTimeout = setTimeout(() => {
                    console.warn(`Safety timeout triggered for ${path} - forcing loading complete`);
                    setIsLoading(false);
                    if (!hasInitializedRef.current) {
                        setState(initialValue);
                        hasInitializedRef.current = true;
                    }
                }, 5000);

                // Listen for realtime updates
                const listener = dbRef.on('value', snapshot => {
                    try {
                        clearTimeout(safetyTimeout); // Clear safety timeout since listener fired
                        const data = snapshot.val();
                        console.log(`=== Firebase Listener Triggered for ${path} ===`);
                        console.log('Data from Firebase:', data ? 'exists' : 'null');
                        console.log('hasInitializedRef.current:', hasInitializedRef.current);

                        if (data !== null && data !== undefined) {
                            console.log(`âœ“ Firebase data exists for ${path}, loading...`);
                            try {
                                console.log('Data keys:', Object.keys(data || {}).join(', '));
                            } catch (e) {
                                console.log('Could not get data keys');
                            }
                            setState(data);
                            hasInitializedRef.current = true;
                            setIsLoading(false);
                        } else if (!hasInitializedRef.current) {
                            // If no data in Firebase on first load, save initial value
                            console.log(`âš  No data in Firebase for ${path}, saving initial value`);
                            setState(initialValue);
                            setIsLoading(false);
                            dbRef.set(initialValue).then(() => {
                                console.log(`âœ“ Initial value saved to Firebase for ${path}`);
                                hasInitializedRef.current = true;
                            }).catch(error => {
                                console.error('âœ— Failed to save initial value:', error);
                                hasInitializedRef.current = true; // Mark as initialized even on error
                            });
                        } else {
                            console.log(`âš  Firebase returned null but already initialized for ${path}`);
                            setIsLoading(false);
                        }
                    } catch (error) {
                        console.error('Error in Firebase listener:', error);
                        setState(initialValue);
                        setIsLoading(false);
                        hasInitializedRef.current = true;
                    }
                }, error => {
                    console.error('âœ— Firebase load error:', error);
                    clearTimeout(safetyTimeout);
                    setState(initialValue);
                    setIsLoading(false);
                    hasInitializedRef.current = true;
                });

                return () => {
                    clearTimeout(safetyTimeout);
                    dbRef.off('value', listener);
                };
            }, [path]);

            const updateState = (newState) => {
                let finalState;
                setState(prevState => {
                    finalState = typeof newState === 'function' ? newState(prevState) : newState;

                    // Save to Firebase immediately with the computed state
                    const dbRef = database.ref(path);
                    console.log('=== Saving to Firebase ===');
                    console.log('Path:', path);
                    console.log('Data:', JSON.stringify(finalState, null, 2));

                    dbRef.set(finalState)
                        .then(() => {
                            console.log('âœ“ Firebase save successful');
                        })
                        .catch(error => {
                            console.error('âœ— Firebase save error:', error);
                            console.error('Error details:', error.message, error.code);
                        });

                    return finalState;
                });
            };

            return [state, updateState, isLoading];
        };

        // LocalStorage fallback for non-critical data (videos)
        const usePersistentState = (key, initialValue) => {
            const [state, setState] = useState(() => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    return initialValue;
                }
            });
            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (e) {
                    console.error(`Error writing localStorage key "${key}":`, e);
                }
            }, [key, state]);
            return [state, setState];
        };

        // ==========================================
        //  IndexedDB Helper Functions
        // ==========================================

        const DB_NAME = 'ghouse_videos';
        const DB_VERSION = 1;
        const STORE_NAME = 'videos';

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        };

        const saveVideoToDB = async (id, videoBlob) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id, blob: videoBlob });
                request.onsuccess = () => resolve(id);
                request.onerror = () => reject(request.error);
            });
        };

        const getVideoFromDB = async (id) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result?.blob);
                request.onerror = () => reject(request.error);
            });
        };

        const deleteVideoFromDB = async (id) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        const AI_SYSTEM_PROMPT = `ã‚ãªãŸã¯é«˜æ€§èƒ½æ³¨æ–‡ä½å®…ã€ŒG HOUSEã€ã®å„ªç§€ãªå–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™ã€‚`;

        // ==========================================
        //  1. Icons & Shared UI Components
        // ==========================================

        // Simple icon component using Unicode emoji - avoids DOM manipulation conflicts
        const LucideIcon = ({ name, className, size = 20 }) => {
            const iconMap = {
                'users': 'ğŸ‘¥',
                'file-text': 'ğŸ“„',
                'dollar-sign': 'ğŸ’°',
                'graduation-cap': 'ğŸ“',
                'grip-vertical': 'â‹®',
                'trash-2': 'ğŸ—‘ï¸',
                'upload': 'â¬†ï¸',
                'link': 'ğŸ”—',
                'plus': 'â•',
                'alert-triangle': 'âš ï¸',
                'x': 'âŒ',
                'check': 'âœ“',
                'edit': 'âœï¸',
                'save': 'ğŸ’¾',
                'home': 'ğŸ ',
                'settings': 'âš™ï¸',
                'search': 'ğŸ”',
                'menu': 'â˜°'
            };

            const icon = iconMap[name] || 'â—';

            return (
                <span
                    className={className}
                    style={{
                        fontSize: size,
                        display: 'inline-block',
                        lineHeight: 1,
                        verticalAlign: 'middle'
                    }}
                >
                    {icon}
                </span>
            );
        };

        const VideoPlayer = ({ videoId, className }) => {
            const [videoURL, setVideoURL] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadVideo = async () => {
                    try {
                        const blob = await getVideoFromDB(videoId);
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            setVideoURL(url);
                        }
                    } catch (error) {
                        console.error('å‹•ç”»èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                loadVideo();
                return () => {
                    if (videoURL) URL.revokeObjectURL(videoURL);
                };
            }, [videoId]);

            if (loading) {
                return <div className="flex items-center justify-center p-4 text-gray-500 text-xs">å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>;
            }

            if (!videoURL) {
                return <div className="flex items-center justify-center p-4 text-red-500 text-xs">å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>;
            }

            return <video src={videoURL} controls className={className} />;
        };

        const Toast = ({ message, type, onDismiss }) => {
            useEffect(() => {
                if (message) {
                    const timer = setTimeout(onDismiss, 3000);
                    return () => clearTimeout(timer);
                }
            }, [message, onDismiss]);

            if (!message) return null;
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            return ( <div className="fixed top-5 right-5 z-50 animate-fade-in"> <div className={`${bgColor} text-white font-bold rounded-lg shadow-lg py-3 px-5 flex items-center`}> <span className="flex-grow">{message}</span> </div> </div> );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 transition-opacity">
                    <div className="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-all animate-fade-in">
                        <div className="p-6">
                            <div className="flex items-start">
                                <div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <LucideIcon name="alert-triangle" className="text-red-600" size={24} />
                                </div>
                                <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 className="text-lg leading-6 font-medium text-gray-900">{title}</h3>
                                    <div className="mt-2"> <p className="text-sm text-gray-500 whitespace-pre-wrap">{message}</p> </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                            <button type="button" onClick={onConfirm} className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">å‰Šé™¤</button>
                            <button type="button" onClick={onCancel} className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AutoResizeTextarea = ({ value, onChange, placeholder, className = "" }) => {
            const textareaRef = useRef(null);
            useLayoutEffect(() => {
                const el = textareaRef.current;
                if (el) { el.style.height = "auto"; el.style.height = `${el.scrollHeight}px`; }
            }, [value]);
            return ( <textarea ref={textareaRef} value={value || ''} onChange={onChange} placeholder={placeholder} className={`w-full p-2 border border-gray-300 rounded-md shadow-sm resize-none focus:ring-blue-500 focus:border-blue-500 text-sm overflow-hidden ${className}`} rows="1" /> );
        };

        const EditableField = ({ label, iconName, children }) => (
            <div>
                <label className="flex items-center text-sm font-semibold text-gray-500 mb-2"> <LucideIcon name={iconName} size={16} /> <span className="ml-2">{label}</span> </label>
                {children}
            </div>
        );

        function dataUrlToBlobUrl(dataUrl) {
          try {
            if (!dataUrl) return null;
            const [header, base64] = dataUrl.split(',');
            const mime = (header.match(/data:(.*?);base64/) || [])[1] || 'application/pdf';
            const bin = atob(base64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const blobUrl = URL.createObjectURL(new Blob([bytes], { type: mime }));
            return blobUrl;
          } catch (e) {
            console.error("Blob conversion failed", e);
            return null;
          }
        }

        const mockApi = {
            uploadFile: (file) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const reader = new FileReader();
                        reader.onload = () => resolve({ name: file.name, url: reader.result, storageKey: `materials/${Date.now()}-${file.name}` });
                        reader.onerror = (error) => reject({ status: 500, message: 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' });
                        reader.readAsDataURL(file);
                    }, 500);
                });
            }
        };

        const ApiKeyModal = ({ isOpen, onClose, onSave }) => {
            const [apiKey, setApiKey] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">APIã‚­ãƒ¼ã®è¨­å®š</h3>
                        <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-2 border rounded mb-4" placeholder="AIza..." />
                        <div className="flex justify-end space-x-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onClick={() => { if(apiKey.trim()) onSave(apiKey.trim()); }} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AIConsultModal = ({ isOpen, onClose, apiKey }) => {
            const [input, setInput] = useState('');
            const [response, setResponse] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            if (!isOpen) return null;

            const handleConsult = async () => {
                if (!input.trim()) return;
                setIsLoading(true);
                setResponse('');
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: AI_SYSTEM_PROMPT + "\n\nã€ãŠå®¢æ§˜çŠ¶æ³ã€‘\n" + input }] }] })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    setResponse(data.candidates?.[0]?.content?.parts?.[0]?.text || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                } catch (error) { setResponse(`ã‚¨ãƒ©ãƒ¼: ${error.message}`); } finally { setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><LucideIcon name="brain" className="text-purple-600"/> AIå–¶æ¥­ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div className="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                            <div className="flex-1 flex flex-col min-h-0">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">ãŠå®¢æ§˜ã®çŠ¶æ³</label>
                                <textarea value={input} onChange={(e) => setInput(e.target.value)} className="flex-1 w-full p-4 border rounded-lg resize-none focus:ring-2 focus:ring-purple-500 text-sm" placeholder="ä¾‹ï¼š30ä»£å¤«å©¦..." />
                                <button onClick={handleConsult} disabled={isLoading || !input.trim()} className="mt-4 w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 disabled:bg-gray-300 transition-colors flex justify-center items-center gap-2">{isLoading ? 'æ€è€ƒä¸­...' : 'ç›¸è«‡ã™ã‚‹'}</button>
                            </div>
                            <div className="flex-1 flex flex-col min-h-0 bg-gray-50 rounded-lg border p-4 overflow-y-auto">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">AIã‚¢ãƒ‰ãƒã‚¤ã‚¹</label>
                                {response ? <div className="markdown-body text-sm leading-relaxed" dangerouslySetInnerHTML={{ __html: marked.parse(response) }} /> : <div className="flex-1 flex items-center justify-center text-gray-400 text-sm">ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const RepresentativeManagementModal = ({ isOpen, onClose, salesReps, onAddRep, onUpdateRep, onDeleteRep }) => {
            const [editingId, setEditingId] = useState(null);
            const [editingName, setEditingName] = useState('');

            if (!isOpen) return null;
            if (!salesReps || !Array.isArray(salesReps)) return null;

            const handleStartEdit = (rep) => {
                setEditingId(rep.id);
                setEditingName(rep.name);
            };

            const handleSaveEdit = (repId) => {
                if (editingName.trim()) {
                    onUpdateRep(repId, editingName.trim());
                }
                setEditingId(null);
                setEditingName('');
            };

            const handleCancelEdit = () => {
                setEditingId(null);
                setEditingName('');
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <LucideIcon name="users" className="text-indigo-600" size={24} />
                                æ‹…å½“è€…ç®¡ç†
                            </h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-gray-100">
                                &times;
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="space-y-3">
                                {salesReps.map((rep) => (
                                    <div key={rep.id} className="flex items-center gap-3 p-4 border rounded-lg hover:shadow-md transition-shadow bg-gray-50">
                                        {editingId === rep.id ? (
                                            <>
                                                <input
                                                    type="text"
                                                    value={editingName}
                                                    onChange={(e) => setEditingName(e.target.value)}
                                                    className="flex-1 px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    autoFocus
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter') handleSaveEdit(rep.id);
                                                        if (e.key === 'Escape') handleCancelEdit();
                                                    }}
                                                />
                                                <button
                                                    onClick={() => handleSaveEdit(rep.id)}
                                                    className="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm font-medium"
                                                >
                                                    <LucideIcon name="check" size={16} />
                                                </button>
                                                <button
                                                    onClick={handleCancelEdit}
                                                    className="px-3 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition-colors text-sm font-medium"
                                                >
                                                    <LucideIcon name="x" size={16} />
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                <div className="flex-1 font-medium text-gray-800">{rep.name}</div>
                                                <button
                                                    onClick={() => handleStartEdit(rep)}
                                                    className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium flex items-center gap-1"
                                                >
                                                    <LucideIcon name="edit-2" size={14} />
                                                    ç·¨é›†
                                                </button>
                                                <button
                                                    onClick={() => onDeleteRep(rep.id, rep.name)}
                                                    className="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-1"
                                                >
                                                    <LucideIcon name="trash-2" size={14} />
                                                    å‰Šé™¤
                                                </button>
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                            <button
                                onClick={onAddRep}
                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-bold shadow-sm"
                            >
                                <LucideIcon name="user-plus" size={18} />
                                æ–°è¦æ‹…å½“è€…ã‚’è¿½åŠ 
                            </button>
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors font-medium"
                            >
                                é–‰ã˜ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        //  2. Data Definitions (VERSION 18 - FIXED)
        // ==========================================
        const salesInitialData = {
            salesReps: [
                { id: 'rep1', name: 'å¾·ç”° è€•æ˜' }, { id: 'rep2', name: 'ç”°ç•‘ ç¾é¦™' }, { id: 'rep3', name: 'é‡‘æ‘ æ™ƒåŠŸ' },
                { id: 'rep4', name: 'æ¹¯è°· æ†²ä¸€' }, { id: 'rep5', name: 'å…‰å· å®Ÿç·’' }, { id: 'rep6', name: 'è¥¿æ‘ è²´è£•' },
                { id: 'rep7', name: 'å‰ç”° ç¥' }, { id: 'rep8', name: 'å°æ¾ å¤§æ¨¹' }, { id: 'rep9', name: 'ç¨²å°¾ æ‹“æ…' },
                { id: 'rep10', name: 'èˆŸæ©‹ è£•ä¹Ÿ' }, { id: 'rep11', name: 'é«™æœ¨ å¾¹' }, { id: 'rep12', name: 'æ‰æ‘ æ‚ æ–—' },
                { id: 'rep13', name: 'è‘‰å±± ä¸€è¼' }, { id: 'rep14', name: 'é˜¿éƒ¨ æ¾„äºº' },
            ],
            // IDã‚’ 'chap1', 'chap2'... ã«çµ±ä¸€
            trainingItems: [
                { id: 'chap1', name: 'ç¬¬ä¸€ç« ã€€åŸç†åŸå‰‡ãƒ»å¿ƒæ§‹ãˆ', category: 'Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼', description: 'å–¶æ¥­ã¨ã—ã¦ã®ãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆã€G HOUSEã®ç†å¿µã€ãŠå®¢æ§˜ã¸ã®åŸºæœ¬å§¿å‹¢ã‚’å­¦ã¶ã€‚\n\nã€ç›®æ¨™ã€‘\nãƒ»æ¥å®¢ãƒ‡ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹çŠ¶æ…‹\nãƒ»åŸºæœ¬å‹•ä½œã®ç¿’å¾—', documents: [] },
                { id: 'chap2', name: 'ç¬¬äºŒç« ã€€è¦‹å­¦èª¬æ˜ä¼šï¼ˆã‚»ãƒŸãƒŠãƒ¼ï¼‰', category: 'Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼', description: 'ãƒ¢ãƒ‡ãƒ«ãƒã‚¦ã‚¹æ¡ˆå†…ã‚„ã‚»ãƒŸãƒŠãƒ¼ã§ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹ã€‚\n\nã€ç›®æ¨™ã€‘\nãƒ»1ãƒ¶æœˆç›®ã§ã‚»ãƒŸãƒŠãƒ¼ãƒ‡ãƒ“ãƒ¥ãƒ¼\nãƒ»æ¨™æº–ãƒˆãƒ¼ã‚¯ã®å®Œé‚', documents: [] },
                { id: 'chap3', name: 'ç¬¬ä¸‰ç« ã€€å€‹åˆ¥ç›¸è«‡ãƒ»ææ¡ˆåŠ›', category: 'Bç ”ä¿®_1_5æ£Ÿæœˆ', description: 'ãŠå®¢æ§˜ã”ã¨ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãƒ’ã‚¢ãƒªãƒ³ã‚°èƒ½åŠ›ã¨ã€æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã™ã‚‹åŠ›ã‚’é¤Šã†ã€‚\n\nã€ç›®æ¨™ã€‘\nãƒ»å®Ÿè·µã‚¹ã‚­ãƒ«ã®ç¿’å¾—\nãƒ»ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‹ã‚‰ã®èª²é¡Œç‰¹å®š', documents: [] },
                { id: 'chap4', name: 'ç¬¬å››ç« ã€€å…¨ä½“åƒã®æŠŠæ¡', category: 'Bç ”ä¿®_1_5æ£Ÿæœˆ', description: 'è³‡é‡‘è¨ˆç”»ã€åœŸåœ°æ¢ã—ã€å¥‘ç´„ã‹ã‚‰å¼•ãæ¸¡ã—ã¾ã§ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼ã‚’ç†è§£ã—ã€ãŠå®¢æ§˜ã‚’ãƒªãƒ¼ãƒ‰ã™ã‚‹ã€‚\n\nã€ç›®æ¨™ã€‘\nãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã®ãªã„é€²è¡Œç®¡ç†\nãƒ»è³‡é‡‘è¨ˆç”»ã®ç²¾åº¦å‘ä¸Š', documents: [] },
                { id: 'chap5', name: 'ç¬¬äº”ç« ã€€æ€§èƒ½çŸ¥è­˜ï¼ˆYouTubeå­¦ç¿’ï¼‰ãƒ»ã‚·ãƒ§ãƒ¼ãƒ«ãƒ¼ãƒ è¦‹å­¦', category: 'Bç ”ä¿®_1_5æ£Ÿæœˆ', description: 'G HOUSEã®æ ¸å¿ƒã§ã‚ã‚‹é«˜æ€§èƒ½ï¼ˆæ°—å¯†ãƒ»æ–­ç†±ãƒ»è€éœ‡ï¼‰ã‚’æ·±ãç†è§£ã—ã€ä»–ç¤¾ã¨ã®å·®åˆ¥åŒ–ã‚’èªã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚YouTubeå‹•ç”»æ•™æã‚„ã‚·ãƒ§ãƒ¼ãƒ«ãƒ¼ãƒ ã§ã®å®Ÿåœ°å­¦ç¿’ã‚’å«ã‚€ã€‚\n\nã€ç›®æ¨™ã€‘\nãƒ»æ€§èƒ½ãƒ¡ãƒªãƒƒãƒˆã®è¨€èªåŒ–\nãƒ»ç«¶åˆå¯¾ç­–', documents: [] },
                { id: 'chap6', name: 'ç¬¬å…­ç« ã€€æˆé•·ç·¨ï¼ˆ2.5æ£Ÿ/æœˆç›®æ¨™ï¼‰', category: 'Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡', description: 'å®‰å®šã—ã¦æœˆ2.5æ£Ÿã‚’å—æ³¨ã™ã‚‹ãŸã‚ã®é«˜åº¦ãªã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°æŠ€è¡“ã¨ã€ç´¹ä»‹å—æ³¨ã‚’ç”Ÿã‚€äººé–“åŠ›ã‚’ç£¨ãã€‚Cç ”ä¿®ã‚’åå¾©ç¶™ç¶šã—ã€ãƒˆãƒƒãƒ—ã‚»ãƒ¼ãƒ«ã‚¹ã‚’ç›®æŒ‡ã™ã€‚\n\nã€ç›®æ¨™ã€‘\nãƒ»ç‹¬ã‚Šç«‹ã¡\nãƒ»ã‚³ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆãªå—æ³¨', documents: [] },
            ],
            // Progressã®ã‚­ãƒ¼ã‚‚ 'chap1', 'chap2'... ã«çµ±ä¸€
            progress: {
              rep1: {
                  chap1: { status: 'â—', comments: [{id: 1, date: '2025-09-20', text: 'åˆæ ¼ã€‚'}] },
                  chap2: { status: 'â—', comments: [] },
                  chap3: { status: 'â–³', comments: [] },
                  chap4: { status: 'æœªç€æ‰‹', comments: [] },
                  chap5: { status: 'æœªç€æ‰‹', comments: [] },
                  chap6: { status: 'æœªç€æ‰‹', comments: [] }
              },
            },
            // æœˆæ¬¡å¥‘ç´„æ•°ãƒ‡ãƒ¼ã‚¿ï¼ˆ8æœˆèµ·ç®—ã®å¹´åº¦ç®¡ç†ï¼‰
            contracts: {
                // rep1: { '2024': { '8': 0, '9': 0, '10': 0, '11': 0, '12': 0, '1': 0, '2': 0, '3': 0, '4': 0, '5': 0, '6': 0, '7': 0 } }
            }
        };

        // Flow Data (çœç•¥ã›ãšè¨˜è¿°)
        const initialFlowSteps = [
            { id: 101, days: "éšæ™‚", title: "è³‡æ–™è«‹æ±‚å¯¾å¿œ", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 102, days: "", title: "ç´¹ä»‹åˆ¶åº¦ï¼ˆåéŸ¿å‡¦ç†ï¼‰", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 103, days: "", title: "é¡§å®¢ç®¡ç†", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 104, days: "0æ—¥", title: "ã‚»ãƒŸãƒŠãƒ¼è³‡æ–™æº–å‚™ãƒ»ãƒ¢ãƒ‡ãƒ«ãƒã‚¦ã‚¹å‚™å“æº–å‚™", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 1, days: "", title: "ãƒ¢ãƒ‡ãƒ«ãƒã‚¦ã‚¹è¦‹å­¦èª¬æ˜ä¼š", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 2, days: "", title: "Gãƒã‚¦ã‚¹é™å®šä¼šå“¡å…¥ä¼š", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 105, days: "", title: "ä¼šå“¡ã¸ãŠç¤¼é€£çµ¡", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 3, days: "30æ—¥", title: "åˆå›é¢è«‡", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 106, days: "", title: "äº‹å‰å¯©æŸ»", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 4, days: "", title: "åœŸåœ°æ¢ã—", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 5, days: "", title: "ã„ãˆãƒ—ãƒ­é€å®¢", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 107, days: "60æ—¥", title: "å•†è«‡2", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 108, days: "", title: "å•†è«‡3", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 6, days: "", title: "å»ºç¯‰ç”³è¾¼ï¼ˆ3ä¸‡å††ï¼‰", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 109, days: "", title: "å»ºç¯‰ç”³è¾¼é‡‘ã®è¿”é‡‘ç”³ã—è¾¼ã¿å¯¾å¿œ", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 110, days: "", title: "å»ºç¯‰ç”³è¾¼é‡‘ã®è¿”é‡‘æ™‚ã®å–¶æ¥­äº‹å‹™å´è¿”é‡‘å¯¾å¿œ", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 111, days: "", title: "æ–°è¦ãƒ—ãƒ©ãƒ³ä¾é ¼ï¼ˆæ¥­è€…ã¸è¦‹ç©ã‚‚ã‚Šä¾é ¼ï¼‰", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 7, days: "", title: "ãƒ—ãƒ©ãƒ³ææ¡ˆ", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 34, days: "", title: "å¥‘ç´„å†…å®š (å†…å®šå ±å‘Š)", role: "sales", purpose: "", procedure: `å†…å®šãŒæ±ºã¾ã£ãŸéš›ã«ä¸‹è¨˜å†…å®¹ã‚’å ±å‘Šã™ã‚‹ã€‚\n\nâ–ªï¸ãŠå®¢æ§˜åï¼š\nâ–ªï¸å¥‘ç´„æ—¥ã€€ï¼š\nâ–ªï¸æ™‚é–“ã€€_ï¼š\nâ–ªï¸å¥‘ç´„å ´æ‰€ï¼š\nâ–ªï¸åˆå›ãƒ’ã‚¢ãƒªãƒ³ã‚°äºˆå®šæ—¥ï¼š\nâ–ªï¸æ‰“ã¡åˆã‚ã›å¸Œæœ›åº—èˆ—ã€€ï¼š\nâ–ªï¸æ‰“ã¡åˆã‚ã›å¯èƒ½æ›œæ—¥ã€€ï¼š\nâ–ªï¸é–“å–ã‚Šç¢ºå®šæ—¥æ•°ã€€ã€€ã€€ï¼š\nâ–ªï¸å•†å“åã€€ï¼š\nâ–ªï¸ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å†…å®¹ã€€ã€€ï¼š\nâ–ªï¸2026å¹´7æœˆæœ«å®Œæˆæ¡ˆä»¶ã‹ï¼š\nâ–ªï¸éŠ€è¡Œåã€€ï¼š\nâ–ªï¸æœ¬ç”³ã—è¾¼ã¿ã«å»ºç¯‰ç¢ºèªæ¸ˆè¨¼ãŒå¿…è¦ã‹ï¼š\nâ–ªï¸ç€å·¥é‡‘ã«å»ºç¯‰ç¢ºèªæ¸ˆè¨¼ãŒå¿…è¦ã‹ï¼š\nâ–ªï¸æœ€çµ‚é‡‘ã®é‡‘æ¶ˆã«è¡¨é¡Œç™»è¨˜å®Œäº†ãŒå¿…è¦ã‹ï¼š\nâ–ªï¸æœ€çµ‚é‡‘ã®æ‰‹ç¶šãã¯æ¤œæŸ»æ¸ˆè¨¼ãŒå¿…è¦ã‹ï¼š\nâ–ªï¸è§£ä½“æ¥­è€…ï¼š\nè§£ä½“å·¥æœŸï¼š\nâ–ªï¸æ¸¬é‡æ—¥ã€€ï¼š\nâ–ªï¸è¾²åœ°è»¢ç”¨ã‚„å¸‚è¡—åŒ–èª¿æ•´åŒºåŸŸã€43ç”³è«‹ãªã©ï¼š\nâ–ªï¸åœŸåœ°æ±ºæ¸ˆæ—¥ï¼š\nâ–ªï¸é€ æˆå®Œäº†æ—¥ï¼š\nâ–ªï¸åˆ†ç­†å®Œäº†æ—¥ã€èª°ãŒåˆ†ç­†ã™ã‚‹ã‹ï¼š\nâ–ªï¸æ‡¸å¿µäº‹é …ã€€ï¼š\nâ–ªï¸LIFEXã®å ´åˆã®ãƒ—ãƒ©ãƒ³ç•ªå·ï¼š`, manualUrl: "" },
            { id: 13, days: "", title: "æœ¬å¯©æŸ»", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 112, days: "", title: "ãƒ€ãƒ³ãƒ‰ãƒªãƒ¯ãƒ¼ã‚¯ã®ä½œæˆ", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 8, days: "", title: "å¥‘ç´„å‰è³‡æ–™ã®æº–å‚™", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 113, days: "", title: "è«‹è² å¥‘ç´„æ›¸ä½œæˆ", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 12, days: "", title: "è«‹è² å¥‘ç´„", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 114, days: "90æ—¥", title: "å¥‘ç´„æ›¸ç· çµå¾Œã®å‡¦ç†", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 115, days: "91æ—¥", title: "å–¶æ¥­ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã®ãŠå®¢æ§˜LINEã‚°ãƒ«ãƒ¼ãƒ—ã¸å‚åŠ ", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 116, days: "", title: "ãŠç”³ã—å‡ºç™ºç”Ÿæ™‚ã®å¯¾å¿œ", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 117, days: "", title: "å„ç¨®ç”³è«‹äº‹é …", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 118, days: "120æ—¥", title: "é–“å–ã‚Šå¤‰æ›´è³‡æ–™ä½œæˆ", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 119, days: "", title: "æ¥­è€…è³é‡‘è¨¼æ˜æ›¸æå‡º", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 120, days: "", title: "å¤‰æ›´å¥‘ç´„æ›¸ä½œæˆ", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 25, days: "150æ—¥", title: "å¤‰æ›´å¥‘ç´„", role: "sales", purpose: "", procedure: `1.å¤‰æ›´å¥‘ç´„æ™‚ã«æ‰“åˆã›æ™‚ã«ç¢ºå®šã—ãŸè²»ç”¨ã®ç¢ºèª...`, manualUrl: "" },
            { id: 121, days: "", title: "ä»®ãƒã‚¤ãƒ³ãƒˆä¾é ¼", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 122, days: "180æ—¥", title: "ç€å·¥é‡‘å…¥é‡‘æ‰‹ç¶šã", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 123, days: "", title: "ç€å·¥é‡‘å…¥é‡‘", role: "sales", purpose: "", procedure: `1.å¤‰æ›´å¥‘ç´„æ™‚ã«ã”æ¡ˆå†…ã—ã¦ã„ã‚‹ãŒç€å·¥5æ—¥å‰ã«...`, manualUrl: "" },
            { id: 124, days: "", title: "è£œåŠ©é‡‘ç”³è«‹", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 125, days: "210æ—¥", title: "ä¸Šæ£Ÿé‡‘å…¥é‡‘æ‰‹ç¶šã", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 126, days: "", title: "ä¸Šæ£Ÿé‡‘å…¥é‡‘", role: "sales", purpose: "", procedure: `1.æ‰‹ç¶šãã¯ç€å·¥é‡‘ã¨åŒæ§˜...`, manualUrl: "" },
            { id: 127, days: "", title: "ä¸Šæ£Ÿç«‹ä¼šé€£çµ¡ (LINEã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥)", role: "admin", purpose: "", procedure: "LINEã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã«ã¦ãŠå®¢æ§˜ã¸ä¸Šæ£Ÿç«‹ä¼šé€£çµ¡ã‚’è¡Œã†", manualUrl: "" },
            { id: 128, days: "240æ—¥", title: "æœ€çµ‚ç«‹ä¼š", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 129, days: "", title: "ç²¾ç®—æ›¸ç¢ºèª", role: "sales", purpose: "", procedure: "", manualUrl: "" },
            { id: 130, days: "270æ—¥", title: "æœ€çµ‚é‡‘å…¥é‡‘ç¢ºèª", role: "sales", purpose: "", procedure: `1.å¼•æ¸¡ã—45æ—¥å‰ã«ãªã‚Œã°å¼•æ¸¡ã—æ¡ˆå†…è³‡æ–™ã‚’ãŠå®¢æ§˜ã¸...`, manualUrl: "" },
            { id: 131, days: "300æ—¥", title: "æœ€çµ‚é‡‘å…¥é‡‘æ‰‹ç¶šã", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 132, days: "", title: "æ°—å¯†æ¸¬å®šçµæœé€ä»˜ (LINE)", role: "admin", purpose: "", procedure: "æ°—å¯†æ¸¬å®šçµæœã‚’ãŠå®¢æ§˜ã¸LINEã§é€ä»˜ã™ã‚‹", manualUrl: "" },
            { id: 133, days: "", title: "å¼•æ¸¡ã—BOXä½œæˆ", role: "admin", purpose: "", procedure: "", manualUrl: "" },
            { id: 33, days: "330æ—¥", title: "ãŠå¼•æ¸¡ã—", role: "sales", purpose: "", procedure: `1.éµæ¸¡ã—ã®å®šç¾©ã¯æœ€çµ‚é‡‘ç¢ºèªå¾Œ...`, manualUrl: "" },
            { id: 134, days: "", title: "å¼•æ¸¡ã—å¾Œæ›¸é¡é€ä»˜", role: "admin", purpose: "", procedure: "", manualUrl: "" },
        ];

        const bankTemplate = {
          bankUrl: "",
          repaymentPeriod: "", loanPlan: "", handlingFee: "", groupCreditLifeInsurance: "", other: "", productSummaryLink: "",
          buildingCertIssued: "", buildingCertApplication: "", interimInspectionCert: "", completionInspectionCert: "",
          titleRegistration: "", bridgeLoan: "", constructionContract: "", additionalContract: "", exteriorContract: "",
          fireInsuranceApplication: "", contactList: "",
        };

        const initialBankData = [
          { id: 1, name: "ã‚ŠããªéŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "40å¹´ä»¥å†…", productSummaryLink: "ã‚ŠããªéŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202502", buildingCertIssued: "é‡‘æ¶ˆã¾ã§ã«", completionInspectionCert: "ä¸è¦", titleRegistration: "å®Ÿè¡Œæ—¥ã¾ã§ã«", bridgeLoan: "ã‚Šããªã«ã¦ç€å·¥ãƒ»ä¸Šæ£Ÿã€ã¤ãªãèè³‡å¯¾å¿œå¯", contactList: "æ¢…ç”°ãƒ­ãƒ¼ãƒ³ãƒ—ãƒ©ã‚¶ 06-6312-7680" } },
          { id: 2, name: "ä¸‰äº•ä½å‹éŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", loanPlan: "èè³‡æ‰‹æ•°æ–™å‹", handlingFee: "å€Ÿå…¥é¡ã®2.2%", productSummaryLink: "ä¸‰äº•ä½å‹éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202503", buildingCertIssued: "å»ºç‰©æœ¬ç”³è¾¼æ™‚", buildingCertApplication: "å»ºç‰©æœ¬ç”³è¾¼æ™‚", interimInspectionCert: "ä¸è¦", completionInspectionCert: "ä¸è¦", titleRegistration: "æœ€çµ‚é‡‘ã®æ”¯æ‰•ã„ã®ç›®ã¾ã§ã«", constructionContract: "å»ºç‰©æœ¬ç”³è¾¼æ™‚", additionalContract: "å»ºç‰©æœ¬ç”³è¾¼æ™‚", bridgeLoan: "ãªã— å»ºç‰©åˆ†å‰²ã—ã¦èè³‡å¯èƒ½", other: "ãƒ»åœŸåœ°æœ¬ç”³è¾¼æ™‚ã«è«‹è² å¥‘ç´„ä¸è¦", contactList: "æ¢…ç”°ãƒ­ãƒ¼ãƒ³ãƒ—ãƒ©ã‚¶ 06-7711-0831" } },
          { id: 3, name: "ä½ä¿¡SBIãƒãƒƒãƒˆéŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", loanPlan: "èè³‡æ‰‹æ•°æ–™å‹", handlingFee: "å€Ÿå…¥é¡ã®2.2%", groupCreditLifeInsurance: "50æ­³ä»¥ä¸‹ã§ã‚ã‚Œã°ã€\nã‚¬ãƒ³50%ãƒ»å°±æ¥­ä¸èƒ½ä¿éšœ ä¸Šä¹—ã›ãªã—ã§è¿½åŠ ", productSummaryLink: "ä½ä¿¡SBI å•†å“æ¦‚è¦æ›¸ 202010", buildingCertIssued: "é‡‘æ¶ˆã®2é€±é–“å‰ã¾ã§ã«å¿…è¦", buildingCertApplication: "å»ºç¢ºã¨åŒã˜", interimInspectionCert: "æ±åŒ—èƒŒäº‹ã¤ãªãèè³‡ã®å ´åˆã€ä¸Šæ£Ÿé‡‘1é€±é–“å‰ã¾ã§ã«å¿…è¦", completionInspectionCert: "å®Ÿè¡Œã®4å–¶æ¥­æ—¥å‰ã¾ã§ã«å¿…è¦", titleRegistration: "å®Ÿè¡Œæ—¥ã®å‰æ—¥ã¾ã§ã«å¿…è¦", bridgeLoan: "æ±åŒ—èƒŒäº‹ or SBIã§ã®ã¤ãªãèè³‡å¯¾å¿œ", other: "ãƒ»æŠµå½“æ¨©è¨­å®šã®æŒ‡å®šå¸æ³•æ›¸å£«ã‚ã‚Šï¼ˆWingï¼‰", contactList: "æ¢…ç”°ãƒ­ãƒ¼ãƒ³ãƒ—ãƒ©ã‚¶ ç¦ç”°ã•ã‚“ 080-3021-9887" } },
          { id: 4, name: "äº¬éƒ½éŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", handlingFee: "55,000å††", groupCreditLifeInsurance: "45æ­³ä»¥ä¸‹ ãŒã‚“100 ä¸Šä¹—ã›ãªã—", productSummaryLink: "äº¬éƒ½éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202012", buildingCertIssued: "ç€å·¥é‡‘ã®1é€±é–“å‰", interimInspectionCert: "ä¸è¦", titleRegistration: "å®Ÿè¡Œæ—¥ã¾ã§ã«å¿…è¦", bridgeLoan: "ä¸è¦ ç•™ä¿é‡‘å¯¾å¿œ", contactList: "ä¼è¦‹ãƒ­ãƒ¼ãƒ³ãƒ—ãƒ©ã‚¶ 075-604-0010" } },
          { id: 5, name: "æ± ç”°æ³‰å·éŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "æœ€é•·50å¹´", loanPlan: "èè³‡æ‰‹æ•°æ–™å‹/ä¿è¨¼æ–™é‡‘åˆ©ä¸Šä¹—ã›å‹", handlingFee: "åŸå‰‡55,000å††", groupCreditLifeInsurance: "å°±æ¥­ä¸èƒ½ä¿éšœ +0.1%\nã‚¬ãƒ³100 +0.2% ä¸‰å¤§ç–¾ç—…100 +0.2%", productSummaryLink: "æ± ç”°æ³‰å·éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202401", buildingCertIssued: "å»ºç‰©ã®æ­£å¼ç”³è¾¼ã¾ã§ã«å¿…è¦", buildingCertApplication: "1ï½6é¢ã€å›³é¢å¿…è¦", interimInspectionCert: "ä¸è¦", completionInspectionCert: "ä¸è¦", titleRegistration: "å®Ÿè¡Œæ—¥ã¾ã§ã«", constructionContract: "æ­£å¼ç”³è¾¼æ™‚ã«å¿…è¦", additionalContract: "é‡‘æ¶ˆã¾ã§ã«å¿…è¦", bridgeLoan: "æ± æ³‰ã«ã¦ç€å·¥ãƒ»ä¸Šæ£Ÿã€ã¤ãªãèè³‡", other: "ãƒ»è«¸è²»ç”¨50ä¸‡å††ã¾ã§ä½¿é€”è‡ªç”±é‡‘ã‚ã‚Š", contactList: "æ± ç”°ãƒ­ãƒ¼ãƒ³ãƒ—ãƒ©ã‚¶ 072-753-3741" } },
          { id: 6, name: "å—éƒ½éŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "40å¹´ä»¥å†…", handlingFee: "55,000å††", productSummaryLink: "å—éƒ½éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202109", buildingCertIssued: "æ­£å¼ç”³è¾¼ã¾ã§ã«", completionInspectionCert: "ä¸è¦", titleRegistration: "æœ€çµ‚é‡‘ã®æ”¯æ‰•ã„ã®æ—¥ã¾ã§ã«", bridgeLoan: "ãªã— å»ºç‰©å®Ÿè¡Œã—ã¦ç•™ä¿é‡‘å¯¾å¿œ", contactList: "å¤§é˜ªã‚¨ãƒ«ãƒ—ãƒ©ã‚¶" } },
          { id: 7, name: "ãƒ•ãƒ©ãƒƒãƒˆ35ï¼ˆãƒ‰ã‚³ãƒ¢ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ï¼‰", type: 'main', details: { ...bankTemplate, repaymentPeriod: "æœ€é•·50å¹´", loanPlan: "å›ºå®šé‡‘åˆ©", handlingFee: "2.2%", contactList: "ä¸­å·ã•ã‚“ 090-7130-9253" } },
          { id: 8, name: "ä½†é¦¬éŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "40å¹´ä»¥å†…", loanPlan: "ä¿è¨¼æ–™é‡‘åˆ©ä¸Šä¹—ã›å‹/æ‰‹æ•°æ–™å®šç‡å‹", handlingFee: "55,000å††ï½", productSummaryLink: "ä½†é¦¬éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202502", buildingCertIssued: "ä¸è¦", completionInspectionCert: "ä¸è¦", titleRegistration: "æœ€çµ‚é‡‘ã®æ”¯æ‰•ã„ã®æ—¥ã¾ã§ã«", constructionContract: "é‡‘æ¶ˆå¥‘ç´„æ™‚ã«å¿…è¦", bridgeLoan: "ãªã— ç€å·¥å…¨æ ã«å®Ÿè¡Œã—ã¦ç•™ä¿é‡‘å¯¾å¿œ", other: "ãƒ»é‡‘æ¶ˆã®3æ—¥å‰ã¾ã§ã«ã¯ç¢ºèªæ¸ˆè¨¼ãŒå¿…è¦", contactList: "è¥¿å®®ãƒ­ãƒ¼ãƒ³ã‚»ãƒ³ã‚¿ãƒ¼ 0798-64-6221" } },
          { id: 9, name: "å±±é™°åˆåŒéŠ€è¡Œ", type: 'main', details: { ...bankTemplate, repaymentPeriod: "æœ€é•·50å¹´", loanPlan: "", handlingFee: "2.2%", contactList: "è¥¿å®®æ”¯åº— å²©äº•ã•ã‚“ 080-8247-5879" } },

          { id: 10, name: "ç´€é™½éŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "40å¹´ä»¥å†…", loanPlan: "ä¿è¨¼æ–™ä¸€æ‹¬å‰æ‰•å‹/ä¿è¨¼æ–™é‡‘åˆ©ä¸Šä¹—ã›å‹", handlingFee: "55,000å††", groupCreditLifeInsurance: "ãŒã‚“100 +0.15% ä¸‰å¤§ç–¾ç—…100 +0.2%", productSummaryLink: "ç´€é™½éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202404", buildingCertIssued: "æ­£å¼ç”³è¾¼æ™‚ã«å¿…è¦", buildingCertApplication: "æ­£å¼ç”³è¾¼æ™‚ã«å¿…è¦", completionInspectionCert: "å®Ÿè¡Œæ—¥ã¾ã§ã«ã‚ã‚Œã°é€ä»˜", titleRegistration: "å®Ÿè¡Œæ—¥ã¾ã§ã«å¿…è¦", constructionContract: "æ­£å¼ç”³è¾¼æ™‚ã«å¿…è¦", bridgeLoan: "ã¤ãªãèè³‡ãªã„", contactList: "å…«æˆ¸ãƒé‡Œä½å®…ãƒ­ãƒ¼ãƒ³ã‚»ãƒ³ã‚¿ãƒ¼ 06-6725-3451" } },
          { id: 11, name: "SBIæ–°ç”ŸéŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", other: "è©³ç´°ã¯å•†å“æ¦‚è¦æ›¸ã‚’ç¢ºèª" } },
          { id: 12, name: "ã‚¤ã‚ªãƒ³éŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", loanPlan: "èè³‡æ‰‹æ•°æ–™å‹", handlingFee: "2.2%", groupCreditLifeInsurance: "ãŒã‚“100 +0.1%", productSummaryLink: "ã‚¤ã‚ªãƒ³éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202404", buildingCertIssued: "é‡‘æ¶ˆã¾ã§ã«å¿…è¦", completionInspectionCert: "å®Ÿè¡Œ2å–¶æ¥­æ—¥å‰", titleRegistration: "ç™»è¨˜ç”³è«‹æ›¸ãŒå¿…è¦", other: "æŒ‡å®šå¸æ³•æ›¸å£«ã‚ã‚Š", contactList: "æ±äº¬å–¶æ¥­æ‰€ 03-6636-8001" } },
          { id: 13, name: "é¦™å·éŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, productSummaryLink: "é¦™å·éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202507", buildingCertIssued: "å¿…è¦", completionInspectionCert: "æ”¯æ‰•ã„ã¾ã§ã«", other: "åœŸåœ°ã¨å»ºç‰©ä¸€æœ¬å®Ÿè¡Œ", contactList: "å¤§é˜ªæ”¯åº—" } },
          { id: 14, name: "é–¢è¥¿ã¿ã‚‰ã„éŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "40å¹´ä»¥å†…", handlingFee: "55,000å††", productSummaryLink: "é–¢è¥¿ã¿ã‚‰ã„éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202409", buildingCertIssued: "æ­£å¼ç”³è¾¼æ™‚ã«å¿…è¦", interimInspectionCert: "ä¸è¦", titleRegistration: "å®Ÿè¡Œæ—¥ã¾ã§ã«", bridgeLoan: "é–¢è¥¿ã¿ã‚‰ã„ã«ã¦ã¤ãªãèè³‡", contactList: "ç¾½æ›³é‡JLC" } },
          { id: 15, name: "äº¬éƒ½ä¿¡ç”¨é‡‘åº«", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "50å¹´ä»¥å†…", handlingFee: "55,000å††", groupCreditLifeInsurance: "3å¤§ç–¾ç—…å›£ä¿¡ä»˜", productSummaryLink: "äº¬ä¿¡ å•†å“æ¦‚è¦æ›¸", completionInspectionCert: "å®Ÿè¡Œã¾ã§ã«", contactList: "æšæ–¹æ”¯åº— 072-846-2111" } },
          { id: 16, name: "äº¬éƒ½ä¸­å¤®ä¿¡ç”¨é‡‘åº«", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", handlingFee: "55,000å††", interimInspectionCert: "å¿…è¦", completionInspectionCert: "æ”¯æ‰•æ—¥ã¾ã§ã«", bridgeLoan: "ä¸è¦ ç•™ä¿é‡‘å¯¾å¿œ", contactList: "äº¬éƒ½ä¸­å¤®ä¿¡ç”¨é‡‘åº«" } },
          { id: 17, name: "è¿‘ç•¿ã‚ã†ãã‚“", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "æœ€é•·50å¹´", handlingFee: "ãªã—", groupCreditLifeInsurance: "ãŒã‚“å›£ä¿¡ ä¸Šä¹—ã›ãªã—", productSummaryLink: "è¿‘ç•¿ã‚ã†ãã‚“ å•†å“æ¦‚è¦æ›¸ 202410", interimInspectionCert: "å¿…è¦", titleRegistration: "å®Ÿè¡Œã®1é€±é–“å‰", bridgeLoan: "ã‚ã†ãã‚“ã«ã¦ã¤ãªãèè³‡", contactList: "æšæ–¹æ”¯åº—" } },
          { id: 18, name: "ã¿ãšã»éŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", productSummaryLink: "ã¿ãšã»éŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202503", buildingCertIssued: "é€ä»˜ã—ã¦ã‹ã‚‰ã®é‡‘æ¶ˆ", buildingCertApplication: "å¿…è¦", completionInspectionCert: "ãªãã¦ã‚‚å¯", titleRegistration: "æœ€çµ‚é‡‘ã®æ”¯æ‰•ã„ã®æ—¥ã¾ã§ã«", bridgeLoan: "ãªã— å»ºç‰©åˆ†å‰²ã—ã¦èè³‡å¯èƒ½", contactList: "æ¢…ç”°ãƒ­ãƒ¼ãƒ³ã‚¹ã‚¯ã‚¨ã‚¢" } },
          { id: 19, name: "ä¸‰è±UFJéŠ€è¡Œ", type: 'sub', details: { ...bankTemplate, repaymentPeriod: "35å¹´ä»¥å†…", handlingFee: "2.3%", productSummaryLink: "ä¸‰è±UFJéŠ€è¡Œ å•†å“æ¦‚è¦æ›¸ 202404", buildingCertIssued: "é‡‘æ¶ˆã®4å–¶æ¥­æ—¥å‰ã¾ã§ã«å¿…è¦", completionInspectionCert: "ä¸è¦", titleRegistration: "ä¸è¦", bridgeLoan: "ãªã— JIOåˆ©ç”¨ã‚ã‚Š", contactList: "ç¥æˆ¸å–¶æ¥­æ‰€" } },
          { id: 20, name: "ARUHI ãƒ•ãƒ©ãƒƒãƒˆ", type: 'sub', details: { ...bankTemplate, buildingCertIssued: "é‡‘æ¶ˆã¾ã§ã«ç¢ºèªãŒå¿…è¦", completionInspectionCert: "ä¸è¦ é©åˆè¨¼æ˜ãŒå¿…è¦", other: "æŒ‡å®šã®å¸æ³•æ›¸å£«ãªã—", contactList: "" } }
        ];

        // Initial Debut Training Data
        const initialDebutTrainingData = {
          'Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼': [
            { id: 'da1', title: 'ãƒ“ã‚¸ãƒã‚¹ãƒãƒŠãƒ¼åŸºç¤', pdfs: [], urls: [] },
            { id: 'da2', title: 'ä¼šç¤¾ç†å¿µã¨æ­´å²', pdfs: [], urls: [] },
            { id: 'da3', title: 'æ¥å®¢ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ³ã‚°åŸºç¤', pdfs: [], urls: [] }
          ],
          'Bç ”ä¿®_1_5æ£Ÿæœˆ': [
             { id: 'db1', title: 'å•†å“çŸ¥è­˜è©³ç´°', pdfs: [], urls: [] },
             { id: 'db2', title: 'è³‡é‡‘è¨ˆç”»å®Ÿè·µ', pdfs: [], urls: [] },
             { id: 'db3', title: 'ç«¶åˆæ¯”è¼ƒåˆ†æ', pdfs: [], urls: [] }
          ],
          'Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡': [
             { id: 'dc1', title: 'ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°æŠ€è¡“', pdfs: [], urls: [] },
             { id: 'dc2', title: 'ç´¹ä»‹å–¶æ¥­æ‰‹æ³•', pdfs: [], urls: [] },
             { id: 'dc3', title: 'ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°', pdfs: [], urls: [] }
          ]
        };

        const STATUS_OPTIONS = ['æœªç€æ‰‹', 'ç ”ä¿®ä¸­', 'ãƒ†ã‚¹ãƒˆä¸åˆæ ¼å¾Œå†ç ”ä¿®', 'ãƒ†ã‚¹ãƒˆåˆæ ¼'];
        const STATUS_VALUE = { 'æœªç€æ‰‹': 0, 'ç ”ä¿®ä¸­': 0.3, 'ãƒ†ã‚¹ãƒˆä¸åˆæ ¼å¾Œå†ç ”ä¿®': 0.6, 'ãƒ†ã‚¹ãƒˆåˆæ ¼': 1 };
        const STATUS_COLOR = {
          'æœªç€æ‰‹': { text: 'text-gray-500', bg: 'bg-gray-200' },
          'ç ”ä¿®ä¸­': { text: 'text-blue-500', bg: 'bg-blue-200' },
          'ãƒ†ã‚¹ãƒˆä¸åˆæ ¼å¾Œå†ç ”ä¿®': { text: 'text-orange-500', bg: 'bg-orange-200' },
          'ãƒ†ã‚¹ãƒˆåˆæ ¼': { text: 'text-green-500', bg: 'bg-green-200' }
        };

        // ==========================================
        //  3. Flow App Components (å–¶æ¥­ä½œæ¥­ãƒ•ãƒ­ãƒ¼)
        // ==========================================

        const StepSelector = ({ listTitle, steps, selectedStepId, onSelectStep, onAddStep, onRequestDeleteStep, draggingItem, setDraggingItem, dragOverItem, setDragOverItem, onDragSort }) => {
            const [isEditMode, setIsEditMode] = useState(false);

            const handleDragStart = (e, index) => { if (!isEditMode) return; setDraggingItem(index); e.dataTransfer.effectAllowed = 'move'; };
            const handleDragEnter = (index) => { if (!isEditMode) return; setDragOverItem(index); };
            const handleDragEnd = () => { if (!isEditMode) return; if (draggingItem !== null && dragOverItem !== null && draggingItem !== dragOverItem) onDragSort(); setDraggingItem(null); setDragOverItem(null); };
            const getDragStyle = (index) => { if (!isEditMode) return ''; if (index === draggingItem) return 'opacity-30'; if (index === dragOverItem) return 'border-t-2 border-blue-500'; return ''; };

            return (
                <div className="w-96 h-full bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0">
                    <div className="p-4 border-b border-gray-200 flex justify-between items-center group bg-white sticky top-0 z-10">
                        <h2 className="text-lg font-bold text-gray-900 truncate">{listTitle}</h2>
                        <button onClick={() => setIsEditMode(!isEditMode)} className={`flex-shrink-0 px-3 py-1 rounded text-xs font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{isEditMode ? 'å®Œäº†' : 'ç·¨é›†'}</button>
                    </div>

                    {isEditMode ? (<>
                        <div className="flex-1 overflow-y-auto">
                            {steps.map((step, index) => (
                                <div key={step.id} draggable={true} onDragStart={(e) => handleDragStart(e, index)} onDragEnter={() => handleDragEnter(index)} onDragEnd={handleDragEnd} onDragOver={(e) => e.preventDefault()} className={`flex items-center justify-between p-3 border-b border-gray-200 group bg-white ${getDragStyle(index)} cursor-move`}>
                                    <div className="flex items-center w-full overflow-hidden">
                                        <LucideIcon name="grip-vertical" className="mr-2 text-gray-400 flex-shrink-0" size={16} />
                                        <div className="flex-1 min-w-0">
                                            <div className="flex gap-2 items-center mb-1">
                                                {step.days && <span className="text-[10px] font-bold text-gray-500 bg-gray-100 px-1 rounded">{step.days}</span>}
                                                <span className={`text-[10px] px-1 rounded border ${step.role === 'admin' ? 'bg-white text-gray-500 border-gray-300' : 'bg-amber-800 text-white border-transparent'}`}>{step.role === 'admin' ? 'äº‹å‹™' : 'å–¶æ¥­'}</span>
                                            </div>
                                            <div className="text-sm font-medium text-gray-800 truncate">{step.title}</div>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); onRequestDeleteStep(step.id, step.title); }} className="text-gray-400 hover:text-red-500 ml-2 p-1"><LucideIcon name="trash-2" size={16} /></button>
                                    </div>
                                </div>
                            ))}
                            <div className="p-4 border-t border-gray-200 bg-white">
                                <button onClick={onAddStep} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors"><LucideIcon name="plus" className="mr-1" size={16} /> ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ </button>
                            </div>
                        </div>
                        </>
                    ) : (<>
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar relative">
                             <div className="flex gap-2 mb-4 text-[10px] justify-center sticky top-0 bg-gray-50 pb-2 z-10">
                                <div className="flex items-center"><span className="w-3 h-3 bg-amber-800 rounded mr-1"></span>å–¶æ¥­æ‹…å½“</div>
                                <div className="flex items-center"><span className="w-3 h-3 bg-white border border-gray-400 rounded mr-1"></span>å–¶æ¥­äº‹å‹™</div>
                             </div>

                             <div className="relative pl-4 border-l-2 border-gray-300 min-h-[500px] pb-10 ml-4">
                                 {steps.map((step, index) => {
                                     const isTimelinePoint = step.days && step.days.includes("æ—¥") && !step.days.includes("éšæ™‚");
                                     return (
                                         <React.Fragment key={step.id}>
                                             {isTimelinePoint && (
                                                <div className="absolute -left-[60px] top-2 flex flex-col items-end w-12">
                                                    <span className="text-[10px] font-bold text-gray-600 bg-gray-200 px-1 rounded whitespace-nowrap">{step.days}</span>
                                                    <div className="absolute -right-[23px] top-1.5 w-3 h-3 rounded-full bg-blue-500 border-2 border-white"></div>
                                                </div>
                                             )}
                                             {!isTimelinePoint && (
                                                 <div className="absolute -left-[23px] top-4 w-2 h-2 rounded-full bg-gray-300"></div>
                                             )}

                                             <div
                                                  onClick={() => onSelectStep(step.id)}
                                                  className={`ml-2 p-3 rounded border cursor-pointer text-sm shadow-sm transition-all relative mb-6 ${selectedStepId === step.id ? 'ring-2 ring-blue-500 z-10 scale-[1.02]' : 'hover:shadow-md hover:scale-[1.01]'} ${step.role === 'admin' ? 'bg-white border-gray-300 text-gray-800' : 'bg-amber-800 text-white border-transparent'}`}
                                             >
                                                 {step.days && !isTimelinePoint && <span className="text-[10px] font-bold opacity-70 block mb-1">{step.days}</span>}
                                                 <div className="font-medium">{step.title}</div>
                                             </div>
                                         </React.Fragment>
                                     );
                                 })}                             </div>
                        </div>
                        </>
                    )}
                </div>
            );
        };

        const StepEditor = ({ step, onUpdateStep, isEditMode }) => {
          if (!step)
            return (
              <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 flex items-center justify-center text-gray-500">
                ã‚¹ãƒ†ãƒƒãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„
              </div>
            );

          const handleFieldChange = (field, value) =>
            onUpdateStep(step.id, { ...step, [field]: value });

          return (
            <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 overflow-y-auto">
              <div className="p-6">
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className="mb-6 pb-4 border-b">
                  <div className="flex items-center gap-2 mb-2">
                    <span
                      className={`px-2 py-1 rounded text-xs font-bold ${
                        step.role === "admin"
                          ? "bg-gray-100 text-gray-600 border border-gray-300"
                          : "bg-amber-800 text-white"
                      }`}
                    >
                      {step.role === "admin" ? "å–¶æ¥­äº‹å‹™" : "å–¶æ¥­æ‹…å½“"}
                    </span>
                    {step.days && (
                      <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                        {step.days}
                      </span>
                    )}
                  </div>

                  {isEditMode ? (
                    <input
                      type="text"
                      value={step.title}
                      onChange={(e) => handleFieldChange("title", e.target.value)}
                      className="text-2xl font-bold text-gray-900 w-full border-b border-transparent focus:border-blue-500 focus:outline-none py-1"
                    />
                  ) : (
                    <h2 className="text-2xl font-bold text-gray-900 py-1">{step.title}</h2>
                  )}
                </div>

                {/* æœ¬æ–‡ */}
                {isEditMode ? (
                  <div className="space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-500 mb-1">æ™‚æœŸç›®å®‰</label>
                        <input
                          type="text"
                          value={step.days || ''}
                          onChange={(e) => handleFieldChange('days', e.target.value)}
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                          placeholder="ä¾‹: 30æ—¥"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-500 mb-1">æ‹…å½“</label>
                        <select
                          value={step.role || 'sales'}
                          onChange={(e) => handleFieldChange('role', e.target.value)}
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                        >
                          <option value="sales">å–¶æ¥­æ‹…å½“</option>
                          <option value="admin">å–¶æ¥­äº‹å‹™</option>
                        </select>
                      </div>
                    </div>

                    <EditableField label="ç›®çš„" iconName="check">
                      <AutoResizeTextarea
                        value={step.purpose}
                        onChange={(e) => handleFieldChange('purpose', e.target.value)}
                        placeholder="ç›®çš„ã‚’å…¥åŠ›..."
                      />
                    </EditableField>

                    <EditableField label="æ‰‹é †" iconName="file-text">
                      <AutoResizeTextarea
                        value={step.procedure}
                        onChange={(e) => handleFieldChange('procedure', e.target.value)}
                        placeholder="æ‰‹é †ã‚’å…¥åŠ›..."
                        className="min-h-[100px]"
                      />
                    </EditableField>

                    <EditableField label="ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (URL)" iconName="link">
                      <AutoResizeTextarea
                        value={step.manualUrl}
                        onChange={(e) => handleFieldChange('manualUrl', e.target.value)}
                        placeholder="URLã‚’å…¥åŠ›..."
                      />
                    </EditableField>
                  </div>
                ) : (
                  <div className="space-y-4 text-gray-800">
                    {step.days && (
                      <div className="text-sm">
                        <span className="font-semibold">æ™‚æœŸç›®å®‰:</span> {step.days}
                      </div>
                    )}
                    <div className="text-sm">
                      <span className="font-semibold">æ‹…å½“:</span> {step.role === 'sales' ? 'å–¶æ¥­æ‹…å½“' : 'å–¶æ¥­äº‹å‹™'}
                    </div>
                    {step.purpose && (
                      <div className="text-sm">
                        <span className="font-semibold">ç›®çš„:</span>
                        <div className="mt-1 whitespace-pre-wrap">{step.purpose}</div>
                      </div>
                    )}
                    {step.procedure && (
                      <div className="text-sm">
                        <span className="font-semibold">æ‰‹é †:</span>
                        <div className="mt-1 whitespace-pre-wrap">{step.procedure}</div>
                      </div>
                    )}
                    {step.manualUrl && (
                      <div className="text-sm">
                        <span className="font-semibold">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«:</span>
                        <a
                          href={step.manualUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-600 hover:underline ml-1"
                        >
                          {step.manualUrl}
                        </a>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        };

        const FlowManagementApp = () => {
            const [flowSteps, setFlowSteps, isLoadingFlowSteps] = useFirebaseState('flowSteps', initialFlowSteps.map((step, index) => ({ ...step, masterIndex: index })));
            const [selectedStepId, setSelectedStepId] = useState(null);
            const [draggingItem, setDraggingItem] = useState(null);
            const [dragOverItem, setDragOverItem] = useState(null);
            const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });
            const [isEditMode, setIsEditMode] = useState(false);

            // Set initial selected step after data loads
            useEffect(() => {
                if (!isLoadingFlowSteps && flowSteps.length > 0 && !selectedStepId) {
                    setSelectedStepId(flowSteps[0]?.id);
                }
            }, [isLoadingFlowSteps, flowSteps, selectedStepId]);

            const selectedStep = flowSteps.find(s => s.id === selectedStepId);

            // Show loading state
            if (isLoadingFlowSteps) {
                return (
                    <div className="flex h-full w-full items-center justify-center bg-gray-100">
                        <div className="text-center">
                            <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent mb-4"></div>
                            <p className="text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                );
            }
            const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
            const closeModal = () => setModalState({ ...modalState, isOpen: false });

            const handleAddStep = () => {
                const newId = Math.max(...flowSteps.map(s => s.id), 0) + 1;
                const newStep = { id: newId, title: "æ–°è¦ã‚¹ãƒ†ãƒƒãƒ—", role: "sales", purpose: "", procedure: "", manualUrl: "" };
                setFlowSteps([...flowSteps, newStep]);
                setSelectedStepId(newId);
            };
            const handleUpdateStep = (id, updatedStep) => setFlowSteps(flowSteps.map(s => s.id === id ? updatedStep : s));
            const handleDragSort = () => {
                const items = [...flowSteps];
                const [reorderedItem] = items.splice(draggingItem, 1);
                items.splice(dragOverItem, 0, reorderedItem);
                setFlowSteps(items);
            };
            const handleRequestDeleteStep = (id, title) => {
                showModal("ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤", `ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`, () => {
                    const newSteps = flowSteps.filter(s => s.id !== id);
                    setFlowSteps(newSteps);
                    if (selectedStepId === id) setSelectedStepId(newSteps[0]?.id || null);
                    closeModal();
                });
            };

            return (
                <div className="flex h-full w-full bg-gray-100 font-sans">
                    <ErrorBoundary>
                        <StepSelector listTitle="å–¶æ¥­ä½œæ¥­ãƒ•ãƒ­ãƒ¼" steps={flowSteps} selectedStepId={selectedStepId} onSelectStep={setSelectedStepId} onAddStep={handleAddStep} onRequestDeleteStep={handleRequestDeleteStep} draggingItem={draggingItem} setDraggingItem={setDraggingItem} dragOverItem={dragOverItem} setDragOverItem={setDragOverItem} onDragSort={handleDragSort} />
                        <main className="flex-1 p-6 overflow-hidden h-full flex flex-col"><div className="flex justify-end mb-4"><button onClick={() => setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded text-sm font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{isEditMode ? 'å®Œäº†' : 'ç·¨é›†'}</button></div><StepEditor step={selectedStep} onUpdateStep={handleUpdateStep} isEditMode={isEditMode} /></main>
                        <ConfirmModal isOpen={modalState.isOpen} title={modalState.title} message={modalState.message} onConfirm={modalState.onConfirm} onCancel={closeModal} />
                    </ErrorBoundary>
                </div>
            );
        };

        // ==========================================
        //  4. Bank App Components (å„ç¨®éŠ€è¡Œ)
        // ==========================================

        const BankEditableRow = ({ label, value, onChange, placeholder, icon, onDelete, fieldKey }) => {
          return ( <div className="grid grid-cols-3 gap-4 items-start group"> <label className="flex items-center text-sm font-semibold text-gray-700 col-span-1 mt-2"> {icon} {label} </label> <div className="col-span-2 flex gap-2"> <AutoResizeTextarea value={value} onChange={onChange} placeholder={placeholder || "è©³ç´°ã‚’å…¥åŠ›..."} className="min-h-[40px] flex-1" /> {onDelete && <button onClick={() => onDelete(fieldKey)} className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2"><LucideIcon name="trash-2" size={16}/></button>} </div> </div> );
        };

        const BankEditor = ({ bank, isEditMode, onUpdateBank, onAddDetailField, onDeleteDetailField }) => {
          const [newFieldName, setNewFieldName] = useState('');
          const [showAddField, setShowAddField] = useState(false);

          if (!bank) return <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 flex items-center justify-center"> <p className="text-gray-500 text-lg">å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰éŠ€è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</p> </div>;

          // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®æ—¥æœ¬èªãƒãƒƒãƒ”ãƒ³ã‚°
          const fieldLabels = {
              bankUrl: 'éŠ€è¡Œå…¬å¼URL',
              repaymentPeriod: 'è¿”æ¸ˆæœŸé–“',
              loanPlan: 'å€Ÿå…¥ãƒ—ãƒ©ãƒ³',
              handlingFee: 'äº‹å‹™å–æ‰±æ‰‹æ•°æ–™',
              groupCreditLifeInsurance: 'å›£ä½“ä¿¡ç”¨ä¿é™º',
              other: 'ãã®ä»–',
              productSummaryLink: 'å•†å“æ¦‚è¦ãƒªãƒ³ã‚¯',
              buildingCertIssued: 'å»ºç¯‰ç¢ºèªæ¸ˆè¨¼',
              buildingCertApplication: 'å»ºç¯‰ç¢ºèªæ¸ˆè¨¼ç”³è«‹æ›¸',
              interimInspectionCert: 'ä¸­é–“æ¤œæŸ»æ¸ˆè¨¼',
              completionInspectionCert: 'å®Œäº†æ¤œæŸ»æ¸ˆè¨¼',
              titleRegistration: 'è¡¨é¡Œç™»è¨˜',
              bridgeLoan: 'ã¤ãªãèè³‡',
              constructionContract: 'å·¥äº‹è«‹è² å¥‘ç´„æ›¸',
              additionalContract: 'è¿½åŠ å·¥äº‹è«‹è² å¥‘ç´„æ›¸',
              exteriorContract: 'å¤–æ§‹å·¥äº‹è«‹è² å¥‘ç´„æ›¸',
              fireInsuranceApplication: 'ç«ç½ä¿é™ºç”³è¾¼æ›¸',
              contactList: 'æ‹…å½“è€…ä¸€è¦§'
          };

          const details = bank.details || {};
          const handleDetailChange = (field, value) => { onUpdateBank(bank.id, { ...bank, details: { ...details, [field]: value } }); };
          const handleNameChange = (e) => { onUpdateBank(bank.id, { ...bank, name: e.target.value }); };
          const handleTypeChange = (e) => { onUpdateBank(bank.id, { ...bank, type: e.target.value }); };

          const handleAddField = () => {
              if (newFieldName.trim()) {
                  onAddDetailField(bank.id, newFieldName.trim());
                  setNewFieldName('');
                  setShowAddField(false);
              }
          };

          const detailFields = Object.keys(details);
          const urlField = 'bankUrl';
          const otherFields = detailFields.filter(f => f !== urlField);

          if (isEditMode) {
              // Edit Mode
              return ( <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 overflow-y-auto"> <div className="p-6">
                  <div className="mb-6 pb-4 border-b border-gray-200">
                      <div className="flex items-center gap-4 mb-4">
                          <input type="text" value={bank.name} onChange={handleNameChange} className="text-3xl font-bold text-gray-800 border-b-2 border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none flex-1" />
                          <select value={bank.type} onChange={handleTypeChange} className="px-3 py-2 border border-gray-300 rounded-md text-sm font-semibold">
                              <option value="main">â­ ãƒ¡ã‚¤ãƒ³ãƒãƒ³ã‚¯</option>
                              <option value="sub">ãã®ä»–</option>
                          </select>
                      </div>
                  </div>
                  <div className="space-y-4">
                      {/* URL Field - Special treatment */}
                      <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                          <label className="flex items-center text-sm font-bold text-blue-800 mb-2">
                              <LucideIcon name="link" size={20} className="mr-2" />
                              {fieldLabels[urlField]}
                          </label>
                          <input
                              type="url"
                              value={details[urlField] || ''}
                              onChange={(e) => handleDetailChange(urlField, e.target.value)}
                              placeholder="https://..."
                              className="w-full p-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                          />
                      </div>

                      {/* Other Fields */}
                      {otherFields.map(fieldKey => (
                          <BankEditableRow
                              key={fieldKey}
                              label={fieldLabels[fieldKey] || fieldKey}
                              fieldKey={fieldKey}
                              icon={<LucideIcon name="file-text" size={20} />}
                              value={details[fieldKey]}
                              onChange={(e) => handleDetailChange(fieldKey, e.target.value)}
                              onDelete={(fKey) => onDeleteDetailField(bank.id, fKey)}
                          />
                      ))}

                      {showAddField ? (
                          <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                              <div className="flex gap-2">
                                  <input
                                      type="text"
                                      value={newFieldName}
                                      onChange={(e) => setNewFieldName(e.target.value)}
                                      placeholder="æ–°ã—ã„é …ç›®åã‚’å…¥åŠ›..."
                                      className="flex-1 p-2 border border-gray-300 rounded text-sm"
                                      onKeyDown={(e) => e.key === 'Enter' && handleAddField()}
                                      autoFocus
                                  />
                                  <button onClick={handleAddField} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold">è¿½åŠ </button>
                                  <button onClick={() => { setShowAddField(false); setNewFieldName(''); }} className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                              </div>
                          </div>
                      ) : (
                          <button onClick={() => setShowAddField(true)} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 transition-colors flex items-center justify-center gap-2 font-semibold">
                              <LucideIcon name="plus" size={20} /> æ–°ã—ã„é …ç›®ã‚’è¿½åŠ 
                          </button>
                      )}
                  </div> </div> </div> );
          } else {
              // Read-only Mode
              return ( <div className="flex-1 h-full bg-white rounded-xl shadow-lg border border-gray-200 overflow-y-auto"> <div className="p-6">
                  <div className="mb-6 pb-4 border-b border-gray-200">
                      <div className="flex items-center gap-4 mb-4">
                          <h2 className="text-3xl font-bold text-gray-800 flex-1">{bank.name}</h2>
                          <span className="px-3 py-2 bg-blue-100 text-blue-800 rounded-md text-sm font-semibold">
                              {bank.type === 'main' ? 'â­ ãƒ¡ã‚¤ãƒ³ãƒãƒ³ã‚¯' : 'ãã®ä»–'}
                          </span>
                      </div>
                  </div>
                  <div className="space-y-4">
                      {/* URL Field - Special treatment with hyperlink */}
                      {details[urlField] && (
                          <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                              <label className="flex items-center text-sm font-bold text-blue-800 mb-2">
                                  <LucideIcon name="link" size={20} className="mr-2" />
                                  {fieldLabels[urlField]}
                              </label>
                              <a
                                  href={details[urlField]}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-blue-600 hover:text-blue-800 underline hover:no-underline font-medium flex items-center gap-2 break-all"
                              >
                                  {details[urlField]}
                                  <LucideIcon name="external-link" size={16} className="flex-shrink-0" />
                              </a>
                          </div>
                      )}

                      {/* Other Fields */}
                      {otherFields.map(fieldKey => (
                          <div key={fieldKey} className="grid grid-cols-3 gap-4">
                              <label className="flex items-center text-sm font-semibold text-gray-700 col-span-1">
                                  <LucideIcon name="file-text" size={20} />
                                  {fieldLabels[fieldKey] || fieldKey}
                              </label>
                              <div className="col-span-2 text-gray-800 whitespace-pre-wrap">
                                  {details[fieldKey] || <span className="text-gray-400">æœªè¨­å®š</span>}
                              </div>
                          </div>
                      ))}
                  </div>
              </div> </div> );
          }
        };

        const BankList = ({ banks, selectedBankId, onSelectBank, searchTerm, onSearchChange, onAddBank, onDeleteBank, isEditMode }) => {
          const filteredBanks = banks.filter(bank => bank.name.toLowerCase().includes(searchTerm.toLowerCase()));
          const mainBanks = filteredBanks.filter(b => b.type === 'main');
          const subBanks = filteredBanks.filter(b => b.type === 'sub');

          return (
             <div className="w-80 h-full bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0">
                 <div className="p-4 border-b border-gray-200">
                     <div className="relative mb-3">
                         <input type="text" value={searchTerm} onChange={onSearchChange} placeholder="éŠ€è¡Œã‚’æ¤œç´¢..." className="w-full p-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" />
                         <LucideIcon name="search" className="text-gray-400 absolute left-3 top-3" size={16} />
                     </div>
                     {isEditMode && (
                         <button onClick={onAddBank} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 text-sm">
                             <LucideIcon name="plus" size={16} /> éŠ€è¡Œã‚’è¿½åŠ 
                         </button>
                     )}
                 </div>
                 <div className="flex-1 overflow-y-auto">
                     {/* Main Banks */}
                     {mainBanks.length > 0 && (
                         <div>
                             <div className="px-4 py-2 bg-blue-100 text-blue-800 text-xs font-bold uppercase tracking-wider">â­ ãƒ¡ã‚¤ãƒ³ãƒãƒ³ã‚¯</div>
                             {mainBanks.map((bank) => (
                                 <div key={bank.id} className={`group p-4 border-b border-gray-200 cursor-pointer flex items-center justify-between ${ selectedBankId === bank.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-gray-100' }`}>
                                     <h3 className={`font-medium truncate flex-1 ${selectedBankId === bank.id ? 'text-blue-800' : 'text-gray-700'}`} onClick={() => onSelectBank(bank.id)}> {bank.name} </h3>
                                     {isEditMode && (
                                         <button onClick={(e) => { e.stopPropagation(); onDeleteBank(bank.id, bank.name); }} className="text-gray-400 hover:text-red-500 transition-opacity p-1">
                                             <LucideIcon name="trash-2" size={16} />
                                         </button>
                                     )}
                                 </div>
                             ))}
                         </div>
                     )}

                     {/* Sub Banks */}
                     {subBanks.length > 0 && (
                         <div>
                             <div className="px-4 py-2 bg-gray-200 text-gray-700 text-xs font-bold uppercase tracking-wider">ãã®ä»–</div>
                             {subBanks.map((bank) => (
                                 <div key={bank.id} className={`group p-4 border-b border-gray-200 cursor-pointer flex items-center justify-between ${ selectedBankId === bank.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-gray-100' }`}>
                                     <h3 className={`font-medium truncate flex-1 ${selectedBankId === bank.id ? 'text-blue-800' : 'text-gray-700'}`} onClick={() => onSelectBank(bank.id)}> {bank.name} </h3>
                                     {isEditMode && (
                                         <button onClick={(e) => { e.stopPropagation(); onDeleteBank(bank.id, bank.name); }} className="text-gray-400 hover:text-red-500 transition-opacity p-1">
                                             <LucideIcon name="trash-2" size={16} />
                                         </button>
                                     )}
                                 </div>
                             ))}
                         </div>
                     )}
                 </div>
             </div>
          );
        };

        const BankManagementApp = () => {
             // Version 11: Firebase integration for real-time sync
             const [banks, setBanks, isLoadingBanks] = useFirebaseState('banks', initialBankData);
             const [selectedBankId, setSelectedBankId] = useState(null);
             const [searchTerm, setSearchTerm] = useState("");
             const [isEditMode, setIsEditMode] = useState(false);
             const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });

             // Set initial selected bank after data loads
             useEffect(() => {
                 if (!isLoadingBanks && banks.length > 0 && !selectedBankId) {
                     setSelectedBankId(banks[0]?.id);
                 }
             }, [isLoadingBanks, banks, selectedBankId]);

             // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«bankUrlãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã¯è¿½åŠ ã™ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼‰
             useEffect(() => {
                 if (!isLoadingBanks && banks.length > 0) {
                     const needsUpdate = banks.some(bank => !bank.details.hasOwnProperty('bankUrl'));
                     if (needsUpdate) {
                         const updatedBanks = banks.map(bank => ({
                             ...bank,
                             details: {
                                 bankUrl: bank.details.bankUrl || '',
                                 ...bank.details
                             }
                         }));
                         setBanks(updatedBanks);
                     }
                 }
             }, [isLoadingBanks]);

             const selectedBank = banks.find(b => b.id === selectedBankId) || banks[0];

             // Show loading state
             if (isLoadingBanks) {
                 return (
                     <div className="flex h-full w-full items-center justify-center bg-gray-100">
                         <div className="text-center">
                             <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent mb-4"></div>
                             <p className="text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                         </div>
                     </div>
                 );
             }

             const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
             const closeModal = () => setModalState({ ...modalState, isOpen: false });

             const handleAddBank = () => {
                 const newId = Math.max(...banks.map(b => b.id), 0) + 1;
                 const newBank = { id: newId, name: "æ–°è¦éŠ€è¡Œ", type: 'sub', details: { ...bankTemplate } };
                 setBanks([...banks, newBank]);
                 setSelectedBankId(newId);
             };

             const handleDeleteBank = (id, name) => {
                 showModal("éŠ€è¡Œå‰Šé™¤", `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`, () => {
                     const newBanks = banks.filter(b => b.id !== id);
                     setBanks(newBanks);
                     if (selectedBankId === id) setSelectedBankId(newBanks[0]?.id || null);
                     closeModal();
                 });
             };

             const handleAddDetailField = (bankId, fieldName) => {
                 setBanks(banks.map(b => {
                     if (b.id === bankId) {
                         return { ...b, details: { ...b.details, [fieldName]: "" } };
                     }
                     return b;
                 }));
             };

             const handleDeleteDetailField = (bankId, fieldName) => {
                 showModal("é …ç›®å‰Šé™¤", `ã€Œ${fieldName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`, () => {
                     setBanks(banks.map(b => {
                         if (b.id === bankId) {
                             const newDetails = { ...b.details };
                             delete newDetails[fieldName];
                             return { ...b, details: newDetails };
                         }
                         return b;
                     }));
                     closeModal();
                 });
             };

             return (
                 <div className="flex h-full w-full bg-gray-100 font-sans">
                     <ErrorBoundary>
                         <BankList
                             banks={banks}
                             selectedBankId={selectedBankId}
                             onSelectBank={setSelectedBankId}
                             searchTerm={searchTerm}
                             onSearchChange={(e) => setSearchTerm(e.target.value)}
                             onAddBank={handleAddBank}
                             onDeleteBank={handleDeleteBank}
                             isEditMode={isEditMode}
                         />
                         <main className="flex-1 p-6 overflow-hidden h-full flex flex-col">
                             <div className="flex justify-end mb-4">
                                 <button
                                     onClick={() => setIsEditMode(!isEditMode)}
                                     className={`px-4 py-2 rounded text-sm font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                 >
                                     {isEditMode ? 'å®Œäº†' : 'ç·¨é›†'}
                                 </button>
                             </div>
                             <BankEditor
                                 bank={selectedBank}
                                 isEditMode={isEditMode}
                                 onUpdateBank={(id, updated) => setBanks(banks.map(b => b.id === id ? updated : b))}
                                 onAddDetailField={handleAddDetailField}
                                 onDeleteDetailField={handleDeleteDetailField}
                             />
                         </main>
                         <ConfirmModal isOpen={modalState.isOpen} title={modalState.title} message={modalState.message} onConfirm={modalState.onConfirm} onCancel={closeModal} />
                     </ErrorBoundary>
                 </div>
             );
        };

        // ==========================================
        //  5. Sales App Components (å–¶æ¥­è‚²æˆ)
        // ==========================================

        const EducationScheduleHeader = () => (
            <div className="bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200">
                <h2 className="text-2xl font-bold text-center text-blue-900 mb-6">æ•™è‚²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="border rounded-xl overflow-hidden shadow-sm bg-white">
                        <div className="bg-blue-900 text-white text-center py-2"><h3 className="font-bold">Aç ”ä¿®</h3><span className="text-xs">ãƒ‡ãƒ“ãƒ¥ãƒ¼ç ”ä¿®</span></div>
                        <div className="p-4 text-center"><span className="text-blue-600 font-bold border border-blue-200 px-3 py-1 rounded-full text-xs">1.5ãƒ¶æœˆ</span><p className="font-bold mt-2">æ¥å®¢ãƒ‡ãƒ“ãƒ¥ãƒ¼</p></div>
                    </div>
                    <div className="border rounded-xl overflow-hidden shadow-sm bg-white">
                        <div className="bg-blue-800 text-white text-center py-2"><h3 className="font-bold">Bç ”ä¿®</h3><span className="text-xs">1.5æ£Ÿå—æ³¨ç ”ä¿®</span></div>
                        <div className="p-4 text-center"><span className="text-blue-600 font-bold border border-blue-200 px-3 py-1 rounded-full text-xs">2.5ãƒ¶æœˆ</span><p className="font-bold mt-2">1.5æ£Ÿ / æœˆ</p></div>
                    </div>
                     <div className="border rounded-xl overflow-hidden shadow-sm bg-white">
                        <div className="bg-blue-700 text-white text-center py-2"><h3 className="font-bold">Cç ”ä¿®</h3><span className="text-xs">2.5æ£Ÿå—æ³¨ç ”ä¿®</span></div>
                        <div className="p-4 text-center"><span className="text-blue-600 font-bold border border-blue-200 px-3 py-1 rounded-full text-xs">3ãƒ¶æœˆ</span><p className="font-bold mt-2">2.5æ£Ÿ / æœˆ</p></div>
                    </div>
                </div>
                <div className="relative pb-2 overflow-x-auto px-2">
                    <div className="relative h-6 text-xs font-bold text-gray-600 min-w-[600px] mb-1">
                        <div className="absolute left-0">å…¥ç¤¾æœˆ</div>
                        <div className="absolute left-[12.5%] -translate-x-1/2">1.5ãƒ¶æœˆå¾Œ</div>
                        <div className="absolute left-[33.3%] -translate-x-1/2">4ãƒ¶æœˆå¾Œ</div>
                        <div className="absolute left-[58.3%] -translate-x-1/2">7ãƒ¶æœˆå¾Œ</div>
                        <div className="absolute right-0">7ãƒ¶æœˆç›®ä»¥é™ Cç ”ä¿®ç¶™ç¶š</div>
                    </div>
                    <div className="flex h-8 text-white text-xs font-bold min-w-[600px] rounded-full overflow-hidden shadow-sm">
                        <div className="w-[12.5%] bg-blue-400 flex items-center justify-center border-r">Aç ”ä¿®</div>
                        <div className="w-[20.8%] bg-blue-600 flex items-center justify-center border-r">Bç ”ä¿®</div>
                        <div className="w-[25.0%] bg-blue-800 flex items-center justify-center border-r">Cç ”ä¿®å®Œäº†</div>
                        <div className="flex-1 bg-orange-400 flex items-center justify-center">Cç ”ä¿® åå¾©ç¶™ç¶š</div>
                    </div>
                </div>
            </div>
        );

        // æœˆæ¬¡å¥‘ç´„æ•°ç®¡ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ8æœˆèµ·ç®—ï¼‰
        const MonthlyContractsCard = ({ repId, contracts, onUpdateContract, isEditMode }) => {
            const [showPastYears, setShowPastYears] = useState(false);
            const [selectedYear, setSelectedYear] = useState(null);

            // ç¾åœ¨ã®å¹´åº¦ã‚’å–å¾—ï¼ˆ8æœˆèµ·ç®—ï¼‰
            const getCurrentFiscalYear = () => {
                const now = new Date();
                const month = now.getMonth() + 1; // 1-12
                const year = now.getFullYear();
                return month >= 8 ? year : year - 1;
            };

            const currentFiscalYear = getCurrentFiscalYear();
            const repContracts = contracts[repId] || {};

            // åˆ©ç”¨å¯èƒ½ãªå¹´åº¦ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆé™é †ï¼‰
            const availableYears = Object.keys(repContracts).map(Number).sort((a, b) => b - a);
            // éå»10å¹´åˆ†ã®å¹´åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            const yearOptions = Array.from({ length: 10 }, (_, i) => currentFiscalYear - i);

            const yearsToShow = showPastYears ? availableYears : [currentFiscalYear];

            // å¹´åº¦ã‚’è¿½åŠ 
            const handleAddYear = () => {
                if (selectedYear && !repContracts[selectedYear]) {
                    ensureYearData(selectedYear);
                    setSelectedYear(null);
                    setShowPastYears(true);
                }
            };

            // æœˆã®ãƒ©ãƒ™ãƒ«ï¼ˆ8æœˆã€œ7æœˆï¼‰
            const monthLabels = ['8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ'];
            const monthKeys = ['8', '9', '10', '11', '12', '1', '2', '3', '4', '5', '6', '7'];

            // å¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ï¼ˆç©ºã®çŠ¶æ…‹ã§ä½œæˆï¼‰
            const ensureYearData = (year) => {
                if (!repContracts[year]) {
                    const newContracts = { ...contracts };
                    if (!newContracts[repId]) newContracts[repId] = {};
                    newContracts[repId][year] = {};
                    onUpdateContract(newContracts);
                }
            };

            // ç¾åœ¨å¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºä¿
            if (!repContracts[currentFiscalYear]) {
                ensureYearData(currentFiscalYear);
            }

            // å¥‘ç´„æ•°ã‚’æ›´æ–°
            const handleContractChange = (year, month, value) => {
                const newContracts = { ...contracts };
                if (!newContracts[repId]) newContracts[repId] = {};
                if (!newContracts[repId][year]) {
                    newContracts[repId][year] = {};
                }

                // ç©ºæ–‡å­—ã®å ´åˆã¯å‰Šé™¤ã€ãã‚Œä»¥å¤–ã¯æ•°å€¤ã¨ã—ã¦ä¿å­˜
                if (value === '' || value === null || value === undefined) {
                    delete newContracts[repId][year][month];
                } else {
                    const numValue = parseInt(value);
                    if (!isNaN(numValue) && numValue >= 0) {
                        newContracts[repId][year][month] = numValue;
                    }
                }
                onUpdateContract(newContracts);
            };

            // åˆè¨ˆã¨å¹³å‡ã‚’è¨ˆç®—ï¼ˆå…¥åŠ›ãŒã‚ã‚‹æœˆã®ã¿ï¼‰
            const calculateStats = (yearData) => {
                if (!yearData) return { total: 0, average: '-', inputCount: 0 };

                // å…¥åŠ›ãŒã‚ã‚‹æœˆã®ã¿ã‚’å–å¾—
                const inputValues = monthKeys
                    .map(m => yearData[m])
                    .filter(val => val !== undefined && val !== null);

                if (inputValues.length === 0) {
                    return { total: 0, average: '-', inputCount: 0 };
                }

                const total = inputValues.reduce((sum, val) => sum + val, 0);
                const average = (total / inputValues.length).toFixed(1);
                return { total, average, inputCount: inputValues.length };
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <LucideIcon name="trending-up" className="text-blue-600" size={20} />
                            æœˆæ¬¡å¥‘ç´„æ£Ÿæ•°ç®¡ç†ï¼ˆ8æœˆèµ·ç®—ï¼‰
                        </h3>
                        <div className="flex gap-2 items-center">
                            {isEditMode && (
                                <div className="flex gap-2 items-center">
                                    <select
                                        value={selectedYear || ''}
                                        onChange={(e) => setSelectedYear(Number(e.target.value))}
                                        className="px-3 py-1 text-sm border border-gray-300 rounded-md"
                                    >
                                        <option value="">éå»å¹´åº¦ã‚’è¿½åŠ ...</option>
                                        {yearOptions.filter(y => y !== currentFiscalYear && !repContracts[y]).map(year => (
                                            <option key={year} value={year}>{year}å¹´åº¦</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={handleAddYear}
                                        disabled={!selectedYear}
                                        className="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        è¿½åŠ 
                                    </button>
                                </div>
                            )}
                            {availableYears.length > 1 && (
                                <button
                                    onClick={() => setShowPastYears(!showPastYears)}
                                    className="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md transition-colors flex items-center gap-1"
                                >
                                    <LucideIcon name={showPastYears ? 'eye-off' : 'eye'} size={14} />
                                    {showPastYears ? 'æœ€æ–°å¹´åº¦ã®ã¿' : 'éå»å¹´åº¦ã‚‚è¡¨ç¤º'}
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="space-y-6">
                        {yearsToShow.map(year => {
                            const yearData = repContracts[year] || {};
                            const stats = calculateStats(yearData);
                            const isCurrent = year === currentFiscalYear;

                            return (
                                <div key={year} className={`border rounded-lg p-4 ${isCurrent ? 'border-blue-400 bg-blue-50' : 'border-gray-300'}`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-bold text-gray-700">
                                            {year}å¹´åº¦ ({year}å¹´8æœˆ ã€œ {year + 1}å¹´7æœˆ)
                                            {isCurrent && <span className="ml-2 text-xs bg-blue-600 text-white px-2 py-1 rounded">æœ€æ–°</span>}
                                        </h4>
                                        <div className="flex gap-4 text-sm">
                                            <span className="font-semibold">åˆè¨ˆ: <span className="text-blue-600 text-lg">{stats.total}</span>æ£Ÿ</span>
                                            <span className="font-semibold">å¹³å‡: <span className="text-green-600 text-lg">{stats.average}</span>æ£Ÿ/æœˆ</span>
                                            {stats.inputCount > 0 && <span className="text-xs text-gray-500">({stats.inputCount}ãƒ¶æœˆåˆ†)</span>}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-6 gap-3">
                                        {monthKeys.map((month, idx) => {
                                            const value = yearData[month];
                                            const hasValue = value !== undefined && value !== null;

                                            return (
                                                <div key={month} className="flex flex-col">
                                                    <label className="text-xs font-medium text-gray-600 mb-1">{monthLabels[idx]}</label>
                                                    {isEditMode ? (
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            value={hasValue ? value : ''}
                                                            onChange={(e) => handleContractChange(year, month, e.target.value)}
                                                            placeholder="-"
                                                            className="w-full px-2 py-1 border border-blue-300 rounded text-center focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        />
                                                    ) : (
                                                        <div className={`w-full px-2 py-1 rounded text-center font-medium ${hasValue ? 'bg-gray-100 border border-gray-200' : 'bg-white border border-gray-200 text-gray-400'}`}>
                                                            {hasValue ? value : '-'}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Category display names mapping for Firebase-compatible keys
        const categoryDisplayNames = {
            'Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼': 'Aç ”ä¿® (ãƒ‡ãƒ“ãƒ¥ãƒ¼)',
            'Bç ”ä¿®_1_5æ£Ÿæœˆ': 'Bç ”ä¿® (1.5æ£Ÿ/æœˆ)',
            'Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡': 'Cç ”ä¿® (ç‹¬ã‚Šç«‹ã¡)'
        };

        const TrainingItemCard = ({ item, repId, progress, onStatusUpdate, onAddComment, onDeleteComment, isEditMode, onUpdateItem, onDeleteItem }) => {
            const [newComment, setNewComment] = useState('');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedVideo, setSelectedVideo] = useState(null);
            const [videoPreview, setVideoPreview] = useState(null);
            const [isDescOpen, setIsDescOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [editingCommentId, setEditingCommentId] = useState(null);
            const [editingText, setEditingText] = useState('');
            const [editingDate, setEditingDate] = useState('');
            const [editingVideo, setEditingVideo] = useState(null);
            const [editingVideoPreview, setEditingVideoPreview] = useState(null);

            // å®‰å…¨è£…ç½®: progress ãŒ undefined ã®å ´åˆã‚’è€ƒæ…®ã€å¤ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ã‚‚æ­£è¦åŒ–
            const rawProgress = progress || { status: 'æœªç€æ‰‹', comments: [] };
            const validStatus = STATUS_OPTIONS.includes(rawProgress.status) ? rawProgress.status : 'æœªç€æ‰‹';
            const currentProgress = { ...rawProgress, status: validStatus };
            const itemPercentage = (STATUS_VALUE[currentProgress.status] || 0) * 100;
            const sortedComments = useMemo(() => (currentProgress.comments || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)), [currentProgress.comments]);

            const handleVideoSelect = async (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('video/')) {
                    if (file.size > 500 * 1024 * 1024) { // 500MBåˆ¶é™
                        alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¯500MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                        return;
                    }
                    const videoId = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    try {
                        await saveVideoToDB(videoId, file);
                        const videoURL = URL.createObjectURL(file);
                        setSelectedVideo(videoId);
                        setVideoPreview(videoURL);
                    } catch (error) {
                        console.error('å‹•ç”»ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        alert('å‹•ç”»ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            };

            const handleRemoveVideo = async () => {
                if (selectedVideo) {
                    try {
                        await deleteVideoFromDB(selectedVideo);
                    } catch (error) {
                        console.error('å‹•ç”»å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                if (videoPreview) {
                    URL.revokeObjectURL(videoPreview);
                }
                setSelectedVideo(null);
                setVideoPreview(null);
            };

            const handleAddCommentClick = () => {
                if (newComment.trim() && selectedDate) {
                    onAddComment(repId, item.id, newComment.trim(), selectedDate, selectedVideo);
                    setNewComment('');
                    setSelectedVideo(null);
                    setVideoPreview(null);
                    setIsHistoryOpen(true);
                }
            };

            const handleEditClick = (comment) => {
                setEditingCommentId(comment.id);
                setEditingText(comment.text);
                setEditingDate(comment.date);
                setEditingVideo(comment.video || null);
                setEditingVideoPreview(null);
            };

            const handleCancelEdit = async () => {
                if (editingVideoPreview) {
                    URL.revokeObjectURL(editingVideoPreview);
                }
                setEditingCommentId(null);
                setEditingText('');
                setEditingDate('');
                setEditingVideo(null);
                setEditingVideoPreview(null);
            };

            const handleEditVideoSelect = async (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('video/')) {
                    if (file.size > 500 * 1024 * 1024) {
                        alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¯500MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                        return;
                    }
                    const videoId = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    try {
                        await saveVideoToDB(videoId, file);
                        const videoURL = URL.createObjectURL(file);
                        setEditingVideo(videoId);
                        setEditingVideoPreview(videoURL);
                    } catch (error) {
                        console.error('å‹•ç”»ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        alert('å‹•ç”»ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            };

            const handleRemoveEditVideo = async () => {
                if (editingVideo) {
                    try {
                        await deleteVideoFromDB(editingVideo);
                    } catch (error) {
                        console.error('å‹•ç”»å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                if (editingVideoPreview) {
                    URL.revokeObjectURL(editingVideoPreview);
                }
                setEditingVideo(null);
                setEditingVideoPreview(null);
            };

            const handleSaveEdit = (commentId) => {
                if (editingText.trim() && editingDate) {
                    onUpdateComment(repId, item.id, commentId, {
                        text: editingText.trim(),
                        date: editingDate,
                        video: editingVideo
                    });
                    handleCancelEdit();
                }
            };

            return (
                <div className={`p-4 border-2 rounded-lg hover:shadow-lg transition-all flex flex-col bg-white relative group ${isEditMode ? 'border-blue-300 bg-blue-50' : 'border-gray-200'}`}>
                    {isEditMode && (
                        <div className="absolute -top-3 -right-3 flex gap-1 z-10">
                            <div className="bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-bold shadow-md flex items-center gap-1">
                                <LucideIcon name="edit-3" size={12}/> ç·¨é›†ä¸­
                            </div>
                            <button onClick={() => onDeleteItem(item.id, item.name)} className="bg-red-500 text-white hover:bg-red-600 p-1.5 rounded-full transition-colors shadow-md" title="ã“ã®é …ç›®ã‚’å‰Šé™¤">
                                <LucideIcon name="trash-2" size={14}/>
                            </button>
                        </div>
                    )}
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                            {isEditMode ? (
                                <div className="space-y-2 bg-white p-3 rounded-lg border border-blue-200">
                                    <div>
                                        <label className="text-xs font-bold text-blue-600 mb-1 block">é …ç›®å</label>
                                        <input
                                            type="text"
                                            value={item.name}
                                            onChange={(e) => onUpdateItem(item.id, { ...item, name: e.target.value })}
                                            className="font-semibold text-gray-700 w-full border-2 border-blue-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                                            placeholder="ç ”ä¿®é …ç›®åã‚’å…¥åŠ›"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-blue-600 mb-1 block">ã‚«ãƒ†ã‚´ãƒª</label>
                                        <select
                                            value={item.category}
                                            onChange={(e) => onUpdateItem(item.id, { ...item, category: e.target.value })}
                                            className="text-sm text-gray-700 border-2 border-blue-300 rounded px-2 py-1 w-full focus:border-blue-500 focus:outline-none"
                                        >
                                            <option value="Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼">Aç ”ä¿® (ãƒ‡ãƒ“ãƒ¥ãƒ¼)</option>
                                            <option value="Bç ”ä¿®_1_5æ£Ÿæœˆ">Bç ”ä¿® (1.5æ£Ÿ/æœˆ)</option>
                                            <option value="Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡">Cç ”ä¿® (ç‹¬ã‚Šç«‹ã¡)</option>
                                        </select>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <p className="font-semibold text-gray-700">{item.name}</p>
                                    <p className="text-sm text-gray-500">{categoryDisplayNames[item.category] || item.category}</p>
                                </>
                            )}
                        </div>
                        {!isEditMode && (
                            <div className="ml-2 w-12 h-12 relative flex items-center justify-center">
                               <div className="absolute inset-0 rounded-full border-4 border-gray-100"></div>
                               <div className={`absolute inset-0 rounded-full border-4 border-blue-500 transition-all duration-500`} style={{ clipPath: `inset(${100 - itemPercentage}% 0 0 0)` }}></div>
                               <span className="text-xs font-bold text-gray-700 z-10">{Math.round(itemPercentage)}%</span>
                            </div>
                        )}
                    </div>

                    <div className={`mb-2 text-xs text-gray-600 p-2 rounded border ${isEditMode ? 'bg-white border-blue-200' : 'bg-gray-50 border-gray-100'}`}>
                        <div className="font-bold flex justify-between items-center cursor-pointer hover:text-blue-600 transition-colors" onClick={() => setIsDescOpen(!isDescOpen)}>
                            <span className="flex items-center gap-1"><LucideIcon name="book-open" size={16}/> å­¦ç¿’å†…å®¹ãƒ»ãƒã‚¤ãƒ³ãƒˆ</span>
                            <span>{isDescOpen ? <LucideIcon name="chevron-up" size={16}/> : <LucideIcon name="chevron-down" size={16}/>}</span>
                        </div>
                        {isDescOpen && (
                            isEditMode ? (
                                <div className="mt-2">
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">è©³ç´°èª¬æ˜</label>
                                    <textarea
                                        value={item.description || ''}
                                        onChange={(e) => onUpdateItem(item.id, { ...item, description: e.target.value })}
                                        className="w-full p-2 border-2 border-blue-300 rounded text-sm resize-none h-32 focus:border-blue-500 focus:outline-none"
                                        placeholder="å­¦ç¿’å†…å®¹ãƒ»ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›..."
                                    />
                                </div>
                            ) : (
                                <div className="whitespace-pre-wrap mt-2 pt-2 border-t border-gray-200 animate-fade-in leading-relaxed">{item.description || "è©³ç´°å†…å®¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"}</div>
                            )
                        )}
                    </div>

                    <div className="mb-4 text-xs text-gray-600 bg-blue-50 p-2 rounded border border-blue-100">
                        <div className="font-bold flex justify-between items-center cursor-pointer hover:text-blue-600 transition-colors" onClick={() => setIsHistoryOpen(!isHistoryOpen)}>
                            <span className="flex items-center gap-1"><LucideIcon name="history" size={16}/> æ´»å‹•å±¥æ­´ ({sortedComments.length})</span>
                            <span>{isHistoryOpen ? <LucideIcon name="chevron-up" size={16}/> : <LucideIcon name="chevron-down" size={16}/>}</span>
                        </div>
                        {isHistoryOpen && (
                            <div className="mt-2 pt-2 border-t border-blue-200 animate-fade-in">
                                {sortedComments.length === 0 ? <p className="text-gray-400 text-center py-2">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p> : (
                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                                        {sortedComments.map(c => (
                                            <div key={c.id} className="bg-white p-2 rounded border border-blue-100 shadow-sm relative group">
                                                {editingCommentId === c.id ? (
                                                    <div className="flex flex-col gap-2">
                                                        <label className="text-[10px] text-gray-500 font-bold">æ—¥ä»˜</label>
                                                        <input type="date" value={editingDate} onChange={(e) => setEditingDate(e.target.value)} className="w-full p-1.5 border rounded text-xs" />
                                                        <label className="text-[10px] text-gray-500 font-bold">å†…å®¹</label>
                                                        <textarea value={editingText} onChange={(e) => setEditingText(e.target.value)} className="w-full p-1.5 border rounded text-xs resize-none h-16" />
                                                        <label className="text-[10px] text-gray-500 font-bold">å‹•ç”»</label>
                                                        {editingVideo && !editingVideoPreview && (
                                                            <div className="relative">
                                                                <VideoPlayer videoId={editingVideo} className="w-full max-h-32 rounded border" />
                                                                <button onClick={handleRemoveEditVideo} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors" title="å‹•ç”»ã‚’å‰Šé™¤">
                                                                    <LucideIcon name="x" size={14} />
                                                                </button>
                                                            </div>
                                                        )}
                                                        {editingVideoPreview && (
                                                            <div className="relative">
                                                                <video src={editingVideoPreview} controls className="w-full max-h-32 rounded border" />
                                                                <button onClick={handleRemoveEditVideo} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors" title="å‹•ç”»ã‚’å‰Šé™¤">
                                                                    <LucideIcon name="x" size={14} />
                                                                </button>
                                                            </div>
                                                        )}
                                                        {!editingVideo && (
                                                            <input type="file" accept="video/*" onChange={handleEditVideoSelect} className="w-full p-1.5 border rounded text-xs file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                                        )}
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleSaveEdit(c.id)} className="flex-1 bg-green-600 text-white py-1.5 rounded text-xs font-bold hover:bg-green-700 transition-colors" disabled={!editingText.trim() || !editingDate}>ä¿å­˜</button>
                                                            <button onClick={handleCancelEdit} className="flex-1 bg-gray-400 text-white py-1.5 rounded text-xs font-bold hover:bg-gray-500 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="font-bold text-blue-800">{c.date}</span>
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleEditClick(c)} className="text-gray-400 hover:text-blue-500" title="ç·¨é›†"><LucideIcon name="edit" size={14}/></button>
                                                                <button onClick={() => onDeleteComment(repId, item.id, c.id)} className="text-gray-400 hover:text-red-500" title="å‰Šé™¤"><LucideIcon name="trash-2" size={14}/></button>
                                                            </div>
                                                        </div>
                                                        <p className="text-gray-700 whitespace-pre-wrap">{c.text}</p>
                                                        {c.video && (
                                                            <div className="mt-2">
                                                                <VideoPlayer videoId={c.video} className="w-full max-h-48 rounded border border-gray-200" />
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="mt-3 pt-2 border-t border-blue-200 flex flex-col gap-2">
                                    <label className="text-[10px] text-gray-500 font-bold">æ–°è¦å±¥æ­´è¿½åŠ </label>
                                    <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full p-1.5 border rounded text-xs" />
                                    <textarea placeholder="æ´»å‹•å†…å®¹ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯..." value={newComment} onChange={(e) => setNewComment(e.target.value)} className="w-full p-1.5 border rounded text-xs resize-none h-16" ></textarea>
                                    <div className="flex flex-col gap-2">
                                        <label className="text-[10px] text-gray-500 font-bold">å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ä»»æ„)</label>
                                        <input type="file" accept="video/*" onChange={handleVideoSelect} className="w-full p-1.5 border rounded text-xs file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                        {videoPreview && (
                                            <div className="relative">
                                                <video src={videoPreview} controls className="w-full max-h-32 rounded border" />
                                                <button onClick={handleRemoveVideo} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors" title="å‹•ç”»ã‚’å‰Šé™¤">
                                                    <LucideIcon name="x" size={14} />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={handleAddCommentClick} className="w-full bg-blue-600 text-white py-1.5 rounded text-xs font-bold hover:bg-blue-700 transition-colors disabled:opacity-50" disabled={!newComment.trim() || !selectedDate}>è¨˜éŒ²ã‚’è¿½åŠ </button>
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="mt-auto space-y-3">
                        <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div className={`${STATUS_COLOR[currentProgress.status].bg} h-2.5 rounded-full`} style={{ width: `${itemPercentage}%` }}></div>
                        </div>
                        <select value={currentProgress.status} onChange={(e) => onStatusUpdate(repId, item.id, 'status', e.target.value)} className={`w-full p-2 border rounded-md ${STATUS_COLOR[currentProgress.status].text}`}>
                            {STATUS_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    </div>
                </div>
            );
        };

        const SalesApp = () => {
             // Version 20: Firebase integration for real-time sync
             const [salesReps, setSalesReps, isLoadingSalesReps] = useFirebaseState('salesReps', salesInitialData.salesReps);
             const [trainingItems, setTrainingItems, isLoadingTrainingItems] = useFirebaseState('trainingItems', salesInitialData.trainingItems);
             const [progress, setProgress, isLoadingProgress] = useFirebaseState('progress', salesInitialData.progress);
             const [contracts, setContracts, isLoadingContracts] = useFirebaseState('contracts', salesInitialData.contracts);
             const [activeRepId, setActiveRepId] = useState(null);
             const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });
             const [isApiKeyModalOpen, setIsApiKeyModalOpen] = useState(false);
             const [isAIModalOpen, setIsAIModalOpen] = useState(false);
             const [apiKey, setApiKey] = useState(localStorage.getItem('ghouse_api_key') || '');
             const [toast, setToast] = useState({ message: '', type: 'success' });
             const [isEditMode, setIsEditMode] = useState(false);
             const [isRepManagementOpen, setIsRepManagementOpen] = useState(false);

             const isLoading = isLoadingSalesReps || isLoadingTrainingItems || isLoadingProgress || isLoadingContracts;

             // activeRepIdãŒæœ‰åŠ¹ãªIDã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
             useEffect(() => {
                 if (!isLoadingSalesReps && salesReps.length > 0 && (!activeRepId || !salesReps.find(r => r.id === activeRepId))) {
                     setActiveRepId(salesReps[0].id);
                 }
             }, [isLoadingSalesReps, salesReps, activeRepId]);

             const showToast = (message, type) => setToast({ message, type });
             const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
             const closeModal = () => setModalState({ ...modalState, isOpen: false });
             const activeRep = salesReps.find(r => r.id === activeRepId);

             // å–¶æ¥­æ‹…å½“è€…ã®ç®¡ç†
             const handleAddRep = () => {
                 const newId = 'rep' + (Math.max(...salesReps.map(r => parseInt(r.id.replace('rep', ''))), 0) + 1);
                 const newRep = { id: newId, name: 'æ–°è¦æ‹…å½“è€…' };
                 setSalesReps([...salesReps, newRep]);
                 setActiveRepId(newId);
                 showToast('æ‹…å½“è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
             };

             const handleUpdateRep = (repId, newName) => {
                 setSalesReps(salesReps.map(r => r.id === repId ? { ...r, name: newName } : r));
             };

             const handleDeleteRep = (repId, name) => {
                 showModal('æ‹…å½“è€…å‰Šé™¤', `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\né€²æ—ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`, () => {
                     const newReps = salesReps.filter(r => r.id !== repId);
                     setSalesReps(newReps);
                     const newProgress = { ...progress };
                     delete newProgress[repId];
                     setProgress(newProgress);
                     if (activeRepId === repId) setActiveRepId(newReps[0]?.id || null);
                     closeModal();
                     showToast('æ‹…å½“è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                 });
             };

             // ç ”ä¿®é …ç›®ã®ç®¡ç†
             const handleAddTrainingItem = (category) => {
                 const newId = 'item' + Date.now();
                 const newItem = { id: newId, name: 'æ–°è¦ç ”ä¿®é …ç›®', category: category, description: '' };
                 setTrainingItems([...trainingItems, newItem]);
                 showToast('ç ”ä¿®é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
             };

             const handleUpdateTrainingItem = (itemId, updatedItem) => {
                 setTrainingItems(trainingItems.map(item => item.id === itemId ? updatedItem : item));
             };

             const handleDeleteTrainingItem = (itemId, name) => {
                 showModal('ç ”ä¿®é …ç›®å‰Šé™¤', `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nå…¨æ‹…å½“è€…ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`, () => {
                     setTrainingItems(trainingItems.filter(item => item.id !== itemId));
                     const newProgress = { ...progress };
                     Object.keys(newProgress).forEach(repId => {
                         if (newProgress[repId][itemId]) {
                             delete newProgress[repId][itemId];
                         }
                     });
                     setProgress(newProgress);
                     closeModal();
                     showToast('ç ”ä¿®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                 });
             };

             const handleStatusUpdate = (repId, itemId, field, value) => {
                 setProgress(prev => ({ ...prev, [repId]: { ...prev[repId], [itemId]: { ...(prev[repId]?.[itemId] || { status: 'æœªç€æ‰‹', comments: [] }), [field]: value } } }));
             };

             const handleAddComment = (repId, itemId, text, date, videoData = null) => {
                 const newComment = { id: Date.now(), date, text, video: videoData };
                 setProgress(prev => {
                     const p = prev[repId] || {};
                     const itemP = p[itemId] || { status: 'æœªç€æ‰‹', comments: [] };
                     return { ...prev, [repId]: { ...p, [itemId]: { ...itemP, comments: [...(itemP.comments||[]), newComment] } } };
                 });
                 showToast("ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ", "success");
             };

             const handleUpdateComment = async (repId, itemId, commentId, updatedData) => {
                 const oldComment = progress[repId]?.[itemId]?.comments?.find(c => c.id === commentId);

                 // å¤ã„å‹•ç”»ãŒã‚ã‚Šã€æ–°ã—ã„å‹•ç”»IDã¨ç•°ãªã‚‹å ´åˆã¯å‰Šé™¤
                 if (oldComment?.video && oldComment.video !== updatedData.video) {
                     try {
                         await deleteVideoFromDB(oldComment.video);
                     } catch (error) {
                         console.error('å¤ã„å‹•ç”»å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                     }
                 }

                 setProgress(prev => {
                     const p = JSON.parse(JSON.stringify(prev));
                     if(p[repId] && p[repId][itemId]) {
                         p[repId][itemId].comments = p[repId][itemId].comments.map(c =>
                             c.id === commentId
                                 ? { ...c, text: updatedData.text, date: updatedData.date, video: updatedData.video }
                                 : c
                         );
                     }
                     return p;
                 });
                 showToast("å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");
             };

             const handleDeleteComment = async (repId, itemId, commentId) => {
                 showModal("ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤", "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
                     // å‰Šé™¤ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
                     const comment = progress[repId]?.[itemId]?.comments?.find(c => c.id === commentId);

                     // å‹•ç”»ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°IndexedDBã‹ã‚‰å‰Šé™¤
                     if (comment?.video) {
                         try {
                             await deleteVideoFromDB(comment.video);
                         } catch (error) {
                             console.error('å‹•ç”»å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                         }
                     }

                     setProgress(prev => {
                         const p = JSON.parse(JSON.stringify(prev));
                         if(p[repId] && p[repId][itemId]) {
                            p[repId][itemId].comments = p[repId][itemId].comments.filter(c => c.id !== commentId);
                         }
                         return p;
                     });
                     closeModal();
                     showToast("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");
                 });
             };

             const calculateProgress = (repId) => {
                 if (!trainingItems || trainingItems.length === 0) return 0;
                 const p = progress[repId] || {};
                 // ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¬ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹
                 const total = trainingItems.reduce((acc, item) => {
                     const status = p[item.id]?.status || 'æœªç€æ‰‹';
                     return acc + (STATUS_VALUE[status] || 0);
                 }, 0);
                 return (total / trainingItems.length) * 100;
             };

             const CircularProgress = ({ percentage }) => {
                 const radius = 40; const stroke = 8; const normalizedRadius = radius - stroke * 2; const circumference = normalizedRadius * 2 * Math.PI; const strokeDashoffset = circumference - (percentage / 100) * circumference;
                 return ( <div className="relative flex items-center justify-center w-32 h-32"> <svg height={radius * 2} width={radius * 2} className="transform -rotate-90"> <circle stroke="#e5e7eb" strokeWidth={stroke} fill="transparent" r={normalizedRadius} cx={radius} cy={radius} /> <circle stroke="#2563eb" strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset }} strokeLinecap="round" fill="transparent" r={normalizedRadius} cx={radius} cy={radius} className="transition-all duration-500 ease-in-out" /> </svg> <div className="absolute text-2xl font-bold text-gray-700">{Math.round(percentage)}%</div> </div> );
             };

             const CategoryProgressBar = ({ category, percentage }) => {
                 const displayName = categoryDisplayNames[category] || category;
                 return (
                     <div className="flex items-center w-full text-xs mb-2"> <span className="text-gray-600 w-24 truncate pr-2 text-right">{displayName}</span> <div className="flex-grow bg-gray-200 rounded-full h-2"> <div className="bg-blue-500 h-2 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }}></div> </div> <span className="font-semibold text-gray-700 w-10 text-left pl-2">{Math.round(percentage)}%</span> </div>
                 );
             };

             const itemsByCategory = useMemo(() => {
                 if (!trainingItems) return {};
                 return trainingItems.reduce((acc, item) => {
                     (acc[item.category] = acc[item.category] || []).push(item);
                     return acc;
                 }, {});
             }, [trainingItems]);

             const categoryOrder = ['Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼', 'Bç ”ä¿®_1_5æ£Ÿæœˆ', 'Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡'];

             const categoryProgresses = useMemo(() => {
                 return categoryOrder.map(category => {
                     const items = itemsByCategory[category] || [];
                     if (items.length === 0) return { category, percentage: 0 };
                     const total = items.reduce((acc, item) => {
                         const status = (progress[activeRepId] || {})[item.id]?.status || 'æœªç€æ‰‹';
                         return acc + (STATUS_VALUE[status] || 0);
                     }, 0);
                     return { category, percentage: (total / items.length) * 100 };
                 });
             }, [itemsByCategory, progress, activeRepId]);

             // Show loading state after all Hooks
             if (isLoading) {
                 return (
                     <div className="flex h-full w-full items-center justify-center bg-gray-100">
                         <div className="text-center">
                             <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent mb-4"></div>
                             <p className="text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                         </div>
                     </div>
                 );
             }

             return (
                 <div className="bg-gray-100 h-full overflow-y-auto font-sans">
                     <Toast {...toast} onDismiss={() => setToast({ ...toast, message: '' })} />
                     <ConfirmModal {...modalState} onCancel={closeModal} />
                     <ApiKeyModal isOpen={isApiKeyModalOpen} onClose={() => setIsApiKeyModalOpen(false)} onSave={(key) => { localStorage.setItem('ghouse_api_key', key); setApiKey(key); setIsApiKeyModalOpen(false); }} />
                     <AIConsultModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} apiKey={apiKey} />
                     <RepresentativeManagementModal
                        isOpen={isRepManagementOpen}
                        onClose={() => setIsRepManagementOpen(false)}
                        salesReps={salesReps}
                        onAddRep={handleAddRep}
                        onUpdateRep={handleUpdateRep}
                        onDeleteRep={handleDeleteRep}
                     />

                     <div className="container mx-auto px-4 py-8">
                        <header className={`flex justify-between items-center mb-8 p-4 rounded-lg transition-all ${isEditMode ? 'bg-blue-50 border-2 border-blue-300' : ''}`}>
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">å–¶æ¥­è‚²æˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                                {isEditMode && <p className="text-sm text-blue-600 font-semibold mt-1"><LucideIcon name="edit-3" size={14} className="inline mr-1"/> ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ - æ‹…å½“è€…åã‚„ç ”ä¿®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†ã§ãã¾ã™</p>}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsRepManagementOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-bold shadow-sm text-sm">
                                    <LucideIcon name="users" size={18} /> æ‹…å½“è€…ç®¡ç†
                                </button>
                                <button onClick={() => setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded-md font-bold shadow-sm text-sm transition-all ${isEditMode ? 'bg-green-600 text-white hover:bg-green-700 animate-pulse' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                    <LucideIcon name={isEditMode ? 'check' : 'edit'} size={18} className="inline mr-1" /> {isEditMode ? 'ç·¨é›†ã‚’å®Œäº†' : 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰'}
                                </button>
                                <button onClick={() => apiKey ? setIsAIModalOpen(true) : setIsApiKeyModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-bold shadow-sm text-sm"><LucideIcon name="brain" size={18} /> AIç›¸è«‡</button>
                                <button onClick={() => setIsApiKeyModalOpen(true)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-md"><LucideIcon name="settings" size={20} /></button>
                            </div>
                        </header>
                         <EducationScheduleHeader />
                         <div className="mb-6 border-b border-gray-200 bg-white sticky top-0 z-10 overflow-x-auto whitespace-nowrap p-2 flex items-center gap-2">
                             {salesReps.map(rep => (
                                 <button key={rep.id} onClick={() => setActiveRepId(rep.id)} className={`px-4 py-3 border-b-2 font-medium text-sm transition-colors ${activeRepId === rep.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                     {rep.name}
                                 </button>
                             ))}
                         </div>
                         {activeRep && (
                             <div className="animate-fade-in">
                                 <ErrorBoundary>
                                     {/* Dashboard Top Section */}
                                     <div className="bg-white p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row gap-8">
                                         <div className="flex flex-col items-center justify-center p-4 min-w-[200px]">
                                             <h3 className="text-lg font-bold text-gray-700 mb-4">ç·åˆé”æˆåº¦</h3>
                                             <CircularProgress percentage={calculateProgress(activeRep.id)} />
                                         </div>
                                         <div className="flex-1 border-l border-gray-100 pl-8">
                                             <h3 className="text-lg font-bold text-gray-700 mb-4">ã‚«ãƒ†ã‚´ãƒªåˆ¥é€²æ—</h3>
                                             <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2">
                                                 {categoryProgresses.map(cp => (
                                                     <CategoryProgressBar key={cp.category} category={cp.category} percentage={cp.percentage} />
                                                 ))}
                                             </div>
                                         </div>
                                     </div>

                                     {/* Monthly Contracts Section */}
                                     <MonthlyContractsCard
                                        repId={activeRep.id}
                                        contracts={contracts}
                                        onUpdateContract={setContracts}
                                        isEditMode={isEditMode}
                                     />

                                     {/* Training Items List by Category */}
                                     <div className="space-y-8">
                                         {categoryOrder.map(category => {
                                             const items = itemsByCategory[category] || [];
                                             const displayName = categoryDisplayNames[category] || category;
                                             return (
                                                 <div key={category}>
                                                     <div className="flex items-center justify-between mb-4">
                                                         <h3 className="text-xl font-bold text-gray-800 border-l-4 border-blue-500 pl-3">{displayName}</h3>
                                                         {isEditMode && (
                                                             <button onClick={() => handleAddTrainingItem(category)} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-bold flex items-center gap-1">
                                                                 <LucideIcon name="plus" size={16} /> ç ”ä¿®é …ç›®è¿½åŠ 
                                                             </button>
                                                         )}
                                                     </div>
                                                     {items.length > 0 ? (
                                                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                             {items.map(item => (
                                                                 <TrainingItemCard
                                                                     key={item.id}
                                                                     item={item}
                                                                     repId={activeRep.id}
                                                                     progress={(progress[activeRep.id] || {})[item.id]}
                                                                     onStatusUpdate={handleStatusUpdate}
                                                                     onAddComment={handleAddComment}
                                                                     onDeleteComment={handleDeleteComment}
                                                                    onUpdateComment={handleUpdateComment}
                                                                     isEditMode={isEditMode}
                                                                     onUpdateItem={handleUpdateTrainingItem}
                                                                     onDeleteItem={handleDeleteTrainingItem}
                                                                 />
                                                             ))}
                                                         </div>
                                                     ) : (
                                                         <div className="text-center text-gray-400 py-8 border-2 border-dashed border-gray-200 rounded-lg">
                                                             ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯ç ”ä¿®é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“
                                                         </div>
                                                     )}
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 </ErrorBoundary>
                             </div>
                         )}
                     </div>
                 </div>
             );
        };

        // ==========================================
        //  6. Debut Training App Components
        // ==========================================
        const DebutTrainingApp = () => {
             const [trainingData, setTrainingData, isLoadingTrainingData] = useFirebaseState('debutTraining', initialDebutTrainingData);
             const [toast, setToast] = useState({ message: '', type: 'success' });
             const [modalState, setModalState] = useState({ isOpen: false, title: "", message: "", onConfirm: () => {} });
             const [isEditMode, setIsEditMode] = useState(false);

             // Simple data logging - no migration
             useEffect(() => {
                 if (!isLoadingTrainingData && trainingData) {
                     console.log('=== Training Data Loaded ===');
                     try {
                         console.log('Training Data categories:', Object.keys(trainingData || {}).join(', '));
                     } catch (e) {
                         console.log('Could not log training data');
                     }
                 }
             }, [isLoadingTrainingData]);

             // Show loading state
             if (isLoadingTrainingData) {
                 return (
                     <div className="flex h-full w-full items-center justify-center bg-gray-100">
                         <div className="text-center">
                             <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent mb-4"></div>
                             <p className="text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                         </div>
                     </div>
                 );
             }

             // Validate trainingData structure
             if (!trainingData || typeof trainingData !== 'object') {
                 return (
                     <div className="flex h-full w-full items-center justify-center bg-gray-100">
                         <div className="text-center">
                             <p className="text-red-600">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                             <button
                                 onClick={() => window.location.reload()}
                                 className="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                             >
                                 å†èª­ã¿è¾¼ã¿
                             </button>
                         </div>
                     </div>
                 );
             }

             const showToast = (message, type) => setToast({ message, type });
             const showModal = (title, message, onConfirm) => setModalState({ isOpen: true, title, message, onConfirm });
             const closeModal = () => setModalState({ ...modalState, isOpen: false });

             const handleUploadPdf = async (category, itemId, file) => {
                 try {
                     const uploadedFile = await mockApi.uploadFile(file);
                     // Add unique ID to the PDF
                     const pdfWithId = {...uploadedFile, _id: `pdf_${Date.now()}_${Math.random()}`};
                     setTrainingData(prev => {
                         const newData = {...prev};
                         newData[category] = (newData[category] || []).map(item => {
                             if(item.id === itemId) {
                                 return {...item, pdfs: [...(item.pdfs || []), pdfWithId]};
                             }
                             return item;
                         });
                         return newData;
                     });
                     showToast('PDFã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                 } catch (e) {
                     showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                 }
             };

             const handleDeletePdf = (category, itemId, pdfId) => {
                 showModal('PDFå‰Šé™¤', 'ã“ã®PDFã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', () => {
                     setTrainingData(prev => {
                         const newData = {...prev};
                         newData[category] = (newData[category] || []).map(item => {
                             if(item.id === itemId) {
                                 // Try to filter by _id first, if not found, try by constructed key
                                 let newPdfs = (item.pdfs || []).filter(pdf => pdf._id !== pdfId);

                                 // If nothing was filtered (meaning pdfId is a fallback key), use index
                                 if (newPdfs.length === item.pdfs.length && pdfId.startsWith('pdf-')) {
                                     const idx = parseInt(pdfId.split('-').pop());
                                     if (!isNaN(idx)) {
                                         newPdfs = [...item.pdfs];
                                         newPdfs.splice(idx, 1);
                                     }
                                 }

                                 return {...item, pdfs: newPdfs};
                             }
                             return item;
                         });
                         return newData;
                     });
                     showToast('PDFã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                     closeModal();
                 });
             };

             const handleAddUrl = (category, itemId, url) => {
                 if (!url) return;
                 // Create URL object with unique ID
                 const urlWithId = { _id: `url_${Date.now()}_${Math.random()}`, url: url };
                 setTrainingData(prev => {
                     const newData = {...prev};
                     newData[category] = (newData[category] || []).map(item => {
                         if (item.id === itemId) {
                             return { ...item, urls: [...(item.urls || []), urlWithId] };
                         }
                         return item;
                     });
                     return newData;
                 });
                 showToast('URLã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
             };

             const handleDeleteUrl = (category, itemId, urlId) => {
                 showModal('URLå‰Šé™¤', 'ã“ã®URLã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', () => {
                    setTrainingData(prev => {
                        const newData = {...prev};
                        newData[category] = (newData[category] || []).map(item => {
                            if (item.id === itemId) {
                                // Try to filter by _id first
                                let newUrls = (item.urls || []).filter(urlItem => {
                                    const id = typeof urlItem === 'object' ? urlItem._id : null;
                                    return id !== urlId;
                                });

                                // If nothing was filtered (meaning urlId is a fallback key), use index
                                if (newUrls.length === item.urls.length && urlId.startsWith('url-')) {
                                    const idx = parseInt(urlId.split('-').pop());
                                    if (!isNaN(idx)) {
                                        newUrls = [...item.urls];
                                        newUrls.splice(idx, 1);
                                    }
                                }

                                return { ...item, urls: newUrls };
                            }
                            return item;
                        });
                        return newData;
                    });
                    showToast('URLã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    closeModal();
                 });
             };


             const handleUpdateTitle = (category, itemId, newTitle) => {
                 setTrainingData(prev => {
                     const newData = {...prev};
                     newData[category] = (newData[category] || []).map(item =>
                         item.id === itemId ? {...item, title: newTitle} : item
                     );
                     return newData;
                 });
             };

             const handleAddItem = (category) => {
                 const newId = `new_${Date.now()}`;
                 setTrainingData(prev => ({
                     ...prev,
                     [category]: [...(prev[category] || []), { id: newId, title: 'æ–°è¦é …ç›®', pdfs: [], urls: [] }]
                 }));
             };

             const handleDeleteItem = (category, itemId) => {
                 showModal('é …ç›®å‰Šé™¤', 'ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', () => {
                     setTrainingData(prev => ({
                         ...prev,
                         [category]: (prev[category] || []).filter(item => item.id !== itemId)
                     }));
                     closeModal();
                 });
             };

             const handleOpenPdf = async (doc) => {
                try {
                    if (doc.url && doc.url.startsWith('data:')) {
                        const blobUrl = dataUrlToBlobUrl(doc.url);
                        const win = window.open(blobUrl, '_blank');
                        if (win) {
                            win.addEventListener('beforeunload', () => URL.revokeObjectURL(blobUrl));
                            return;
                        }
                    }
                    alert('PDFã‚’é–‹ãã¾ã™: ' + doc.name);
                } catch (e) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ');
                }
             };

             // Items reordering logic
             const handleDragStart = (e, category, index) => {
                 e.dataTransfer.setData("category", category);
                 e.dataTransfer.setData("index", index);
             };

             const handleDragOver = (e) => {
                 e.preventDefault();
             };

             const handleDrop = (e, targetCategory, targetIndex) => {
                 const sourceCategory = e.dataTransfer.getData("category");
                 const sourceIndex = parseInt(e.dataTransfer.getData("index"), 10);

                 if (sourceCategory === targetCategory && sourceIndex !== targetIndex) {
                     setTrainingData(prev => {
                         const newItems = [...(prev[sourceCategory] || [])];
                         const [reorderedItem] = newItems.splice(sourceIndex, 1);
                         newItems.splice(targetIndex, 0, reorderedItem);
                         return { ...prev, [sourceCategory]: newItems };
                     });
                 }
             };

             return (
                 <div className="bg-gray-100 h-full font-sans p-8 overflow-y-auto">
                     <Toast {...toast} onDismiss={() => setToast({ ...toast, message: '' })} />
                     <ConfirmModal {...modalState} onCancel={closeModal} />
                     <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                <LucideIcon name="graduation-cap" className="text-indigo-600" size={32}/> ãƒ‡ãƒ“ãƒ¥ãƒ¼ç ”ä¿®ä¸€è¦§
                            </h1>
                            <button
                                onClick={() => setIsEditMode(!isEditMode)}
                                className={`px-4 py-2 rounded text-sm font-bold transition-colors ${isEditMode ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                            >
                                {isEditMode ? 'å®Œäº†' : 'ç·¨é›†'}
                            </button>
                        </div>

                         <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                             {['Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼', 'Bç ”ä¿®_1_5æ£Ÿæœˆ', 'Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡'].map(category => {
                                const displayNames = {
                                    'Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼': 'Aç ”ä¿® (ãƒ‡ãƒ“ãƒ¥ãƒ¼)',
                                    'Bç ”ä¿®_1_5æ£Ÿæœˆ': 'Bç ”ä¿® (1.5æ£Ÿ/æœˆ)',
                                    'Cç ”ä¿®_ç‹¬ã‚Šç«‹ã¡': 'Cç ”ä¿® (ç‹¬ã‚Šç«‹ã¡)'
                                };
                                const displayName = displayNames[category] || category;
                                return (
                                 <div key={category} className="bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-full">
                                     <div className={`p-4 font-bold text-white text-center text-lg ${category === 'Aç ”ä¿®_ãƒ‡ãƒ“ãƒ¥ãƒ¼' ? 'bg-blue-600' : category === 'Bç ”ä¿®_1_5æ£Ÿæœˆ' ? 'bg-indigo-600' : 'bg-purple-600'}`}>
                                         {displayName}
                                     </div>
                                     <div className="p-4 flex-1 overflow-y-auto">
                                         <div className="space-y-4">
                                             {(trainingData[category] || []).map((item, index) => {
                                                 if (!item || !item.id) return null;
                                                 return (
                                                     <div
                                                        key={item.id}
                                                        className={`border rounded-lg p-3 bg-gray-50 hover:shadow-sm transition-shadow ${isEditMode ? "cursor-move" : ""}`}
                                                        draggable={isEditMode}
                                                        onDragStart={(e) => handleDragStart(e, category, index)}
                                                        onDragOver={handleDragOver}
                                                        onDrop={(e) => handleDrop(e, category, index)}
                                                     >
                                                     <div className="flex justify-between items-start mb-2">
                                                         <div className="flex items-center flex-1 mr-2">
                                                            {isEditMode && <LucideIcon name="grip-vertical" className="mr-2 text-gray-400 flex-shrink-0" size={16}/>}
                                                             <input
                                                                 type="text"
                                                                 value={item.title}
                                                                 onChange={(e) => handleUpdateTitle(category, item.id, e.target.value)}
                                                                 className={`font-bold text-gray-700 bg-transparent ${isEditMode ? "" : "pointer-events-none"} border-b ${isEditMode ? "border-transparent hover:border-gray-300" : "border-transparent"} focus:border-blue-500 focus:outline-none w-full`}
                                                             />
                                                         </div>
                                                        {isEditMode && (
                                                            <button type="button" onClick={() => handleDeleteItem(category, item.id)} className="text-gray-400 hover:text-red-500"><LucideIcon name="trash-2" size={16}/></button>
                                                        )}
                                                     </div>

                                                     {/* PDF List */}
                                                     <div className="space-y-2 mb-3">
                                                         {(item.pdfs || []).map((pdf, idx) => {
                                                             try {
                                                                 if (!pdf || !pdf.name) return null;
                                                                 const pdfKey = (pdf && pdf._id) || `pdf-${item.id}-${idx}`;
                                                                 return (
                                                                     <div key={pdfKey} className="flex items-center justify-between text-xs bg-white p-2 rounded border border-gray-200">
                                                                         <div onClick={() => handleOpenPdf(pdf)} className="flex items-center cursor-pointer hover:text-blue-600 truncate flex-1 mr-2">
                                                                             <LucideIcon name="file-text" size={14} className="mr-1 text-red-500 flex-shrink-0"/>
                                                                             <span className="truncate">{pdf.name}</span>
                                                                         </div>
                                                                        {isEditMode && (
                                                                            <button type="button" onClick={() => handleDeletePdf(category, item.id, pdfKey)} className="text-gray-400 hover:text-red-500">Ã—</button>
                                                                        )}
                                                                     </div>
                                                                 );
                                                             } catch (e) {
                                                                 console.error('Error rendering PDF item:', e);
                                                                 return null;
                                                             }
                                                         })}
                                                     </div>
                                                    {/* Upload Button */}
                                                    {isEditMode && (
                                                        <label className="flex items-center justify-center w-full p-2 border-2 border-dashed border-gray-300 rounded cursor-pointer hover:bg-gray-100 hover:border-blue-400 transition-colors text-xs text-gray-500 mb-3">
                                                            <LucideIcon name="upload" size={14} className="mr-1"/> è³‡æ–™ã‚’è¿½åŠ 
                                                            <input type="file" accept=".pdf" className="hidden" onChange={(e) => e.target.files[0] && handleUploadPdf(category, item.id, e.target.files[0])} />
                                                        </label>
                                                    )}

                                                     {/* URL List */}
                                                     <div className="space-y-2 mb-3">
                                                        {(item.urls || []).map((urlItem, idx) => {
                                                            try {
                                                                const urlString = typeof urlItem === 'string' ? urlItem : (urlItem && urlItem.url) || '';
                                                                const urlKey = (urlItem && typeof urlItem === 'object' && urlItem._id) || `url-${item.id}-${idx}`;
                                                                if (!urlString) return null;
                                                                return (
                                                                    <div key={urlKey} className="flex items-center justify-between text-xs bg-white p-2 rounded border border-gray-200">
                                                                        <a href={urlString} target="_blank" rel="noopener noreferrer" className="flex items-center cursor-pointer hover:text-blue-600 truncate flex-1 mr-2 text-blue-500">
                                                                            <LucideIcon name="link" size={14} className="mr-1 flex-shrink-0"/>
                                                                            <span className="truncate">{urlString}</span>
                                                                        </a>
                                                                        {isEditMode && (
                                                                            <button onClick={() => handleDeleteUrl(category, item.id, urlKey)} className="text-gray-400 hover:text-red-500">Ã—</button>
                                                                        )}
                                                                    </div>
                                                                );
                                                            } catch (e) {
                                                                console.error('Error rendering URL item:', e);
                                                                return null;
                                                            }
                                                        })}
                                                     </div>

                                                     {/* Add URL Input */}
                                                    {isEditMode && (
                                                     <div className="flex items-center gap-1">
                                                        <input
                                                            type="text"
                                                            placeholder="https://..."
                                                            className="flex-1 p-1.5 border rounded text-xs"
                                                            id={`url-input-${item.id}`}
                                                            onKeyDown={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    handleAddUrl(category, item.id, e.target.value);
                                                                    e.target.value = '';
                                                                }
                                                            }}
                                                        />
                                                        <button
                                                            onClick={() => {
                                                                const input = document.getElementById(`url-input-${item.id}`);
                                                                handleAddUrl(category, item.id, input.value);
                                                                input.value = '';
                                                            }}
                                                            className="bg-gray-100 border border-gray-300 text-gray-600 p-1.5 rounded hover:bg-gray-200"
                                                        >
                                                            <LucideIcon name="plus" size={14} />
                                                        </button>
                                                     </div>
                                                    )}
                                                 </div>
                                             );
                                             })}
                                         </div>
                                     </div>
                                     <div className="p-4 border-t bg-gray-50">
                                        {isEditMode && (
                                                                                 <button type="button" onClick={() => handleAddItem(category)} className="w-full py-2 bg-white border border-gray-300 rounded text-gray-600 hover:bg-gray-100 text-sm font-bold flex items-center justify-center">
                                                                                     <LucideIcon name="plus" size={16} className="mr-1"/> é …ç›®è¿½åŠ 
                                                                                 </button>
                                        )}
                                     </div>
                                 </div>
                             );
                             })}
                         </div>
                     </div>
                 </div>
             );
        };

        // ==========================================
        //  6. Root App & Unified App
        // ==========================================

        const HomePage = ({ onNavigate }) => (
            <div className="h-full overflow-y-auto bg-gradient-to-br from-slate-50 to-blue-50 p-8 flex items-center justify-center">
              <div className="max-w-5xl w-full">
                <h1 className="text-4xl font-bold text-center text-slate-800 mb-12">G-house | å–¶æ¥­ã‚µã‚¤ãƒˆ</h1>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {[
                        { id: 'sales', title: 'å–¶æ¥­è‚²æˆç®¡ç†', icon: <LucideIcon name="users" className="text-blue-600" size={32}/>, desc: 'ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚¹ã‚­ãƒ«ç¿’å¾—çŠ¶æ³ã€AIãƒ­ãƒ¼ãƒ—ãƒ¬æ”¯æ´' },
                        { id: 'flow', title: 'å–¶æ¥­ä½œæ¥­ãƒ•ãƒ­ãƒ¼', icon: <LucideIcon name="file-text" className="text-green-600" size={32}/>, desc: 'å¥‘ç´„ã¾ã§ã®æ¨™æº–å·¥ç¨‹ã¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç®¡ç†' },
                        { id: 'bank', title: 'å„ç¨®éŠ€è¡Œ', icon: <LucideIcon name="dollar-sign" className="text-yellow-600" size={32}/>, desc: 'ææºé‡‘èæ©Ÿé–¢ã®é‡‘åˆ©ãƒ»æ‰‹æ•°æ–™ãƒ»å¿…è¦æ›¸é¡DB' },
                        { id: 'debut', title: 'ãƒ‡ãƒ“ãƒ¥ãƒ¼ç ”ä¿®ä¸€è¦§', icon: <LucideIcon name="graduation-cap" className="text-indigo-600" size={32}/>, desc: 'æ–°äººå–¶æ¥­ãƒãƒ³å‘ã‘ã®æ¨™æº–ç ”ä¿®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ' },
                    ].map(card => (
                        <div key={card.id} onClick={() => onNavigate(card.id)} className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all cursor-pointer border-t-4 border-blue-500 transform hover:-translate-y-1 flex flex-col h-full">
                            <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mb-6">{card.icon}</div>
                            <h2 className="text-xl font-bold text-slate-800 mb-3">{card.title}</h2>
                            <p className="text-gray-500 mb-6 flex-grow text-sm">{card.desc}</p>
                            <div className="flex items-center text-blue-600 font-bold mt-auto">é–‹ã <LucideIcon name="chevron-down" className="ml-1 -rotate-90" size={16}/></div>
                        </div>
                    ))}
                </div>
              </div>
            </div>
        );

        const UnifiedApp = () => {
          const [currentView, setCurrentView] = useState('home');

          return (
            <div className="h-full flex flex-col">
              <nav className="bg-white shadow-md flex-shrink-0 z-20">
                <div className="container mx-auto px-4">
                  <div className="flex items-center h-16">
                    <div className="text-xl font-bold text-gray-800 mr-8">G-house | å–¶æ¥­ã‚µã‚¤ãƒˆ</div>
                    <div className="flex items-center space-x-2">
                       {['home', 'sales', 'flow', 'bank', 'debut'].map(view => (
                           <button key={view} onClick={() => setCurrentView(view)} className={`px-4 py-2 rounded-md font-medium transition-colors ${currentView === view ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}>
                             {view === 'home' ? 'ãƒ›ãƒ¼ãƒ ' : view === 'sales' ? 'å–¶æ¥­è‚²æˆ' : view === 'flow' ? 'å–¶æ¥­ãƒ•ãƒ­ãƒ¼' : view === 'bank' ? 'å„ç¨®éŠ€è¡Œ' : 'ãƒ‡ãƒ“ãƒ¥ãƒ¼ç ”ä¿®'}
                           </button>
                       ))}
                    </div>
                  </div>
                </div>
              </nav>

              <div className="flex-1 overflow-auto bg-gray-100">
                <ErrorBoundary>
                    {currentView === 'home' && <HomePage onNavigate={setCurrentView} />}
                    {currentView === 'sales' && <SalesApp />}
                    {currentView === 'flow' && <FlowManagementApp />}
                    {currentView === 'bank' && <BankManagementApp />}
                    {currentView === 'debut' && <DebutTrainingApp />}
                </ErrorBoundary>
              </div>
            </div>
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<UnifiedApp />);
    </script>
</body>
</html>